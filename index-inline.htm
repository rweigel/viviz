<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><meta charset="UTF-8">
		<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
		<title>ViViz</title>
		<script type="text/javascript">
//////////////////////////////
// Begin configuation.
// URL string is empty for Test because gallery information
// is located in VIVIZ["catalogs"]["Test"]
var VIVIZ = {}
VIVIZ["config"] =
	{
		"catalogs": {"Test": {"URL": ""}, "ViRBO": {"URL": "catalogs/virbo.json"}},
		"defaultCatalog": "Test",
		"defaultMode": "gallery",
		"showThumbstrip": true,
		"showCatalog": true,
		"showDropdowns": true,
		"showControls": true,
		"showAboutText": true,
		"showAttributes": true,
		"showFileName": true,
		"thumbWidth": 0.25,
		"thumbHeight": 0.25,
		"fullWidth": 1.0,
		"fullHeight": 1.0,
		"useAutoAttributes": true,
		"lazyLoadMax": 6,
		"frameRate": 500,
		"play": false,
		"port": 8002,
		"debug": true,
		"proxyServer": "http://localhost:8002/proxy?url=",
		"useCachedImages": false,
	}

// Note: In general it is best to use $ instead of % in configuation except in
// the scripts.  This is because sprintf=demo-%04d.png is decoded to demo-d.png,
// so you must use demo-$04d.png.  In scripts where sprintf and strftime are used,
// the % must be used.
VIVIZ["catalogs"] = {};
VIVIZ["catalogs"]["Test"] = 
		[
			{
				"id": "ACE/Multi/a",
				"title": "ACE/Multi",
				"aboutlink": "http://virbo.org/gallery#ACE",
				"strftime": "product_$Y$m$d.png",
				"start": "1998-01-01",
				"stop": "2012-04-30",
				"fulldir": "http://virbo.org/images/pngwalk/ACE/Multi/fulls/",
				"thumbdir": "http://virbo.org/images/pngwalk/ACE/Multi/thumbs400/"
			},
			{
				"id": "ACE/Multi/b",
				"title": "ACE/Multi/a w/ no thumbdir",
				"aboutlink": "http://virbo.org/gallery#ACE",
				"strftime": "product_$Y$m$d.png",
				"start": "1998-01-01",
				"stop": "2012-04-30",
				"fulldir": "http://virbo.org/images/pngwalk/ACE/Multi/fulls/"
			},
			{
				"id": "ACE/Multi/c",
				"title": "ACE/Multi/b w/ no thumbdir & thumbWidth=0.1",
				"aboutlink": "http://virbo.org/gallery#ACE",
				"strftime": "product_$Y$m$d.png",
				"start": "1998-01-01",
				"stop": "2012-04-30",
				"fulldir": "http://virbo.org/images/pngwalk/ACE/Multi/fulls/",
				"thumbWidth": 0.1
			},
			{
				"id": "ACE/Multi/d",
				"title": "ACE/Multi/c w/ no thumbdir & thumbWidth=100",
				"aboutlink": "http://virbo.org/gallery#ACE",
				"strftime": "product_$Y$m$d.png",
				"start": "1998-01-01",
				"stop": "2012-04-30",
				"fulldir": "http://virbo.org/images/pngwalk/ACE/Multi/fulls/",
				"thumbWidth": 100
			},
			{
				"id": "ACE/Multi/e",
				"title": "ACE/Multi/d w/ dir, no thumbdir & thumbWidth=0.1.",
				"aboutlink": "http://virbo.org/gallery#ACE",
				"strftime": "product_$Y$m$d.png",
				"start": "1998-01-01",
				"stop": "2012-04-30",
				"dir": "http://virbo.org/images/pngwalk/ACE/Multi/fulls/",
				"thumbWidth": 0.1
			},
			{
				"id": "ACE/Multi/f",
				"title": "ACE/Multi/e w/ dir, no thumbdir & thumbWidth=100.",
				"aboutlink": "http://virbo.org/gallery#ACE",
				"strftime": "product_$Y$m$d.png",
				"start": "1998-01-01",
				"stop": "2012-04-30",
				"dir": "http://virbo.org/images/pngwalk/ACE/Multi/fulls/",
				"thumbWidth": 100
			},
			{
				"id": "ACE/Multi/g",
				"title": "ACE/Multi/f thumbdir is relative path.",
				"aboutlink": "http://virbo.org/gallery#ACE",
				"strftime": "product_$Y$m$d.png",
				"start": "1998-01-01",
				"stop": "2012-04-30",
				"fulldir": "http://virbo.org/images/pngwalk/ACE/Multi/fulls/",
				"thumbdir": "../thumbs400/"
			},
			{
				"id": "ACE/Multi/h",
				"title": "ACE/Multi/g with start number and regexp.",
				"aboutlink": "http://virbo.org/gallery#ACE",
				"strftime": "product_$Y$m$d.png",
				"start": "1998-01-01",
				"stop": "2012-04-30",
				"fulldir": "http://virbo.org/images/pngwalk/ACE/Multi/fulls/",
				"thumbdir": "../thumbs400/",
				"defaultFirstImage": 10
			},
			{
				"id": "ACE/Multi/i",
				"title": "ACE/Multi/h with start number and regexp.",
				"aboutlink": "http://virbo.org/gallery#ACE",
				"strftime": "product_$Y$m$d.png",
				"start": "1998-01-01",
				"stop": "2012-04-30",
				"fulldir": "http://virbo.org/images/pngwalk/ACE/Multi/fulls/",
				"thumbdir": "../thumbs400/",
				"defaultRegExp": "2000",
				"defaultFirstImage": 10
			},
			{
				"id": "Demo/01",
				"title": "sprintf",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"sprintf": "demo-$04d.png",
				"start": 1,
				"stop": 4
			},
			{
				"id": "Demo/02",
				"title": "strftime",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"strftime": "demo-$Y.png",
				"start": 2001,
				"stop": 2004
			},
			{
				"id": "Demo/03",
				"title": "fullscript as function",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"fullscript": function() {files = [];for (i = 0; i < 4; i++) {files[i] = ['demo-' + sprintf('%04d',i+1) + '.png']};return files}
			},
			{
				"id": "Demo/04",
				"title": "fullscript as string",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"fullscript": "function() {files = [];for (i = 0; i < 4; i++) {files[i] = ['demo-' + sprintf('%04d',i+1) + '.png']};return files}"
			},
			{
				"id": "Demo/05a",
				"title": "fullfiles as array with array elements of file information",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"fullfiles": [["demo-2001.png"],["demo-2002.png"],["demo-2003.png"],["demo-2004.png"]]
			},
			{
				"id": "Demo/05b",
				"title": "Same as Demo/05a but with attribute for each image",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"fullfiles": [["demo-2001.png",1],["demo-2002.png",2],["demo-2003.png",3],["demo-2004.png",4]]
			},
			{
				"id": "Demo/05c",
				"title": "Same as Demo/05b but with attribute names",
				"fulldir": "images/full/",
				"thumbdir": "images/thumb/",
				"attributes": ["Filename","Age"],
				"fullfiles": [["demo-2001.png",1],["demo-2002.png",2],["demo-2003.png",3],["demo-2004.png",4]]
			},
			{
				"id": "Demo/05d",
				"title": "Same as Demo/05c but with attribute filters",
				"fulldir": "images/full/",
				"thumbdir": "images/thumb/",
				"attributes": ["Filename","Age"],
				"filters": [[{}],[{"name": "Age is greater than 1", "value": "this > 1.0"}]],
				"fullfiles": [["demo-2001.png",1],["demo-2002.png",2],["demo-2003.png",3],["demo-2004.png",4]]
			},
			{
				"id": "Demo/05e",
				"title": "Same as Demo/05d but with defaultFirstImage",
				"fulldir": "images/full/",
				"thumbdir": "images/thumb/",
				"defaultFirstImage": 2,
				"attributes": ["Filename","Age"],
				"filters": [[{}],[{"name": "Age is greater than 1", "value": "this > 1.0"}]],
				"fullfiles": [["demo-2001.png",1],["demo-2002.png",2],["demo-2003.png",3],["demo-2004.png",4]]
			},
			{
				"id": "Demo/06",
				"title": "fullfiles as string with file information separated by newlines",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"fullfiles": "demo-2001.png\ndemo-2002.png\ndemo-2003.png\ndemo-2004.png"
			},
			{
				"id": "Demo/09",
				"title": "fullfiles as string with relative path to text file. (Will not work for simple installation.)",
				"fulldir": "images/full/",
				"fullfiles": "catalogs/lists/demo-filelist.txt"
			},
			{
				"id": "Demo/10",
				"title": "fullfiles as string with relative path to JavaScript file. (Will not work for simple installation.)",
				"fulldir": "images/full/",
				"fullfiles": "catalogs/lists/demo-filelist.json"
			},
			{
				"id": "Demo/11",
				"title": "fullfiles as localhost URL to text file. (Requires full application install)",
				"aboutlink": "http://viviz.org/",
				"fulldir": "images/full/",
				"fullfiles": "http://localhost:"+VIVIZ["config"]["port"]+"/catalogs/lists/demo-filelist.txt"
			},
			{
				"id": "Demo/12",
				"title": "fullfiles as localhost URL to file with JavaScript array. (Requires full application install)",
				"fulldir": "images/full/",
				"fullfiles": "http://localhost:"+VIVIZ["config"]["port"]+"/catalogs/lists/demo-filelist.json"
			},
			{
				"id": "Demo/13",
				"title": "fullfiles as remote URL to text file. (Requires full application install.)",
				"fulldir": "images/full/",
				"fullfiles": "https://raw.githubusercontent.com/rweigel/viviz/master/catalogs/lists/demo-filelist.txt"
			},
			{
				"id": "Demo/14",
				"title": "fullfiles as remote URL to file with JavaScript array. (Requires full application install.)",
				"fulldir": "images/full/",
				"fullfiles": "https://raw.githubusercontent.com/rweigel/viviz/master/catalogs/lists/demo-filelist.json"
			},
			{
				"id": "Demo/15",
				"title": "First image is 404.",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"fullfiles": [["xdemo-2001.png"],["demo-2002.png"],["demo-2003.png"],["demo-2004.png"]]
			},
			{
				"id": "Demo/15b",
				"title": "Demo/15 with attributes and filters.",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"attributes": ["Filename","Age"],
				"filters": [[{}],[{"name": "Age is greater than 1", "value": "this > 1.0"}]],
				"fullfiles": [["xdemo-2001.png",1],["demo-2002.png",2],["demo-2003.png",3],["demo-2004.png",4]]
			},
			{
				"id": "Demo/16",
				"title": "First two images are 404.",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"fullfiles": [["xdemo-2001.png"],["xdemo-2002.png"],["demo-2003.png"],["demo-2004.png"]]
			},
			{
				"id": "Demo/17",
				"title": "All images are 404.",
				"fulldir":"images/full/",
				"thumbdir":"images/thumb/",
				"fullfiles": [["xdemo-2001.png"],["xdemo-2002.png"],["xdemo-2003.png"],["xdemo-2004.png"]]
			},
			{
				"id": "Demo/18",
				"title": "Should always fail. Response is 404.",
				"fulldir": "images/full/",
				"fullfiles": "http://mag.gmu.edu/demo-filelist.txt"
			},
			{
				"id": "Demo/19",
				"title": "Should always fail. Response is 404.",
				"fulldir": "images/full/",
				"fullfiles": "http://mag.gmu.edu/demo-filelist.json"
			},
			{
				"id": "Demo/20",
				"title": "Should always fail.  Site returns html instead of 404.",
				"fulldir": "images/full/",
				"fullfiles": "http://viviz.org/demo-filelist.txt"
			},
			{
				"id": "Demo/21",
				"title": "fullfiles as remote URL to file with JavaScript array. (Requires full application install.)",
				"title": "Should always fail.  Site returns html instead of 404.",
				"fullfiles": "http://viviz.org/demo-filelist.json"
			},
			{
				"id": "Demo/22",
				"title": "No dir given; images must be in same directory as index.htm",
				"strftime": "demo-$Y.png",
				"start": 2001,
				"stop": 2002
			},
			{
				"id": "Demo/23",
				"title": "No dir given; images must be in same directory as index.htm",
				"strftime": "demo-$Y.png",
				"start": 2001,
				"stop": 2002,
				"fullfiles": ""
			},
			{
				"id": "dir=http://sohowww.nascom.nasa.gov/data/synoptic/sunspots_earth/&strftime=sunspots_512_$Y$m$d.jpg&start=2006-01-20&stop=P0D",
				"title": "Example in documentation."
			},
			{
				"id": "dir=http://sohowww.nascom.nasa.gov/data/synoptic/sunspots_earth/&strftime=sunspots_512_%Y%m%d.jpg&start=2006-01-20&stop=P0D",
				"title": "Example in documentation.  Should be error because % is used instead of $."
			},
			{
				"id": "dir=images/full/&strftime=demo-$Y.png&start=2001&stop=2004",
				"title": "Example in documentation."
			},
			{
				"id": "dir=images/full/&strftime=demo-$Y.png&start=2001&stop=2004",
				"title": "Example in documentation"
			},
			{
				"id": "fulldir=images/full/&thumbdir=images/thumb/&strftime=demo-$Y.png&start=2001&stop=2004",
				"title": "Example in documentation."
			},
			{
				"id": "fulldir=http://virbo.org/images/pngwalk/ACE/Multi/fulls/&strftime=product_$Y$m$d.png&start=1998-01-01&stop=1998-01-04",
				"title": "ID specified as URL in index.js."
			},
			{
				"id": "dir=http://virbo.org/images/pngwalk/ACE/Multi/fulls/&strftime=product_$Y$m$d.png&start=1998-01-01&stop=1998-01-04",
				"title": "ID specified as URL in index.js."
			},
			{
				"id": "dir=http://virbo.org/images/pngwalk/ACE/Multi/fulls/&strftime=product_$Y$m$d.png&start=1998-01-01&stop=1998-01-04&thumbWidth=0.1",
				"title": "ID specified as URL in index.js."
			},
			{
				"id": "dir=http%3A%2F%2Flocalhost%3A8004%2F%3Fcatalog%3DIMAGE%2FPT1M%26dataset%3DABK%26parameters%3DX%26return%3Dimage%26format%3Dpng%26type%3Dtimeseries%26style%3D0%26image.width%3D800%26image.height%3D200&strftime=%26start%3D-P1D%26stop%3D%24Y-%24m-%24d&start=2014-09-01&stop=2014-09-30",
				"title": "ID specified as URL with encoded values in index.js (28 images)."
			},
			{
				"id": "dir=http%3A%2F%2Flocalhost%3A8004%2F%3Fcatalog%3DIMAGE%2FPT1M%26dataset%3DABK%26parameters%3DX%26return%3Dimage%26format%3Dpng%26type%3Dtimeseries%26style%3D0%26image.width%3D800%26image.height%3D200&strftime=%26start%3D-P1D%26stop%3D%24Y-%24m-%24d&start=2010-09-27&stop=2014-09-30",
				"title": "ID specified as URL with encoded values in index.js (1000+ images)."
			},
			{
				"id": "INVALID/ID",
				"title": "Invalid ID.  Error message is wrong because of use of configuration URL in gallery configuration. URL is assumed to be gallery configuration. Append x to id in address bar to see proper error message."
			},
			{
				"id": "RBSP-A/HFR-WFR_L2",
				"title": "RBSP-A/HFR-WFR_L2",
				"config": "http://emfisis.physics.uiowa.edu/pngwalk/RBSP-A/HFR-WFR_L2/product.pngwalk"
			},
			{
				"id": "config=http://emfisis.physics.uiowa.edu/pngwalk/RBSP-A/HFR-WFR_L2/product.pngwalk",
				"title": "Gallery configuration in .pngwalk file"
			},

		]

// End configuration.
//////////////////////////////		</script>
		<script type="text/javascript">function viviz(VIVIZ, mode) {

	// http://stackoverflow.com/a/13277545
	var consoleHolder = console;
	function debug(bool) {
		if(!bool) {
			consoleHolder = console;
			console = {};
			console.log = function(){};
		} else {
			console = consoleHolder;
		}
	}
	debug(VIVIZ["config"]["debug"]);

	console.log("viviz.js: Called.")

	if (location.protocol.indexOf("file") === 0) {
		if ($("#favicon").length == 0) {
			// Set favicon for offline mode.  See also
			//http://stackoverflow.com/questions/5199902/isnt-it-silly-that-a-tiny-favicon-requires-yet-another-http-request-how-to-mak
			$('<link id="favicon" rel="shortcut icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAAAAAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAADQcAALonPQANAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAERAREBEQERASEBIQEhASEBEQERAREBEQAAAAAAAAAAAREBEQEhAREBIQEhASEBIQERAREBEQERAAAAAAAAAAABEQERAREBEQEhASEBIQEhAREBEQERAREAAAAAAAAAAAMzAzMDMwMzAyMDIwMjAyMDMwMzAzMDMwAAAAAAAAAAAREQAAEREAABERAAD//wAAEREAABERAAAREQAA//8AABERAAAREQAAEREAAP//AAAREQAAEREAABERAAD//wAA" />')
				.appendTo('head')
		}
	}

	// Default configuration options
	_VIVIZ = {
		"defaultMode": "gallery",
		"defaultFirstImage": 1,
		"showThumbstrip": true,
		"showFileName": true,
		"showAboutText": true,
		"showCatalog": true,
		"showControls": true,
		"showAttributes": true,
		"showDropdowns": true,
		"showDownloads": false,
		"useAutoAttributes": true,
		"thumbWidth": 0.25,
		"thumbHeight": 0.25,
		"fullWidth": 1.0,
		"fullHeight": 1.0,
		"lazyLoadMax": 6,
		"frameRate": 500,
		"play": false,
		"port": 8002,
		"proxyServer": "http://localhost:8002/proxy?url=",
		"useCachedImages": false
	}

	// If key does not exist in global or passed VIVIZ object, add it.
	for (key in _VIVIZ) {
		if (typeof(VIVIZ["config"][key]) === "undefined") {
			VIVIZ["config"][key] = _VIVIZ[key]
		}
	}

	// Read and parse query string
	var qs = $.parseQueryString()
	if (typeof(mode) === "undefined") {
		if (qs["mode"]) {
			if (qs["mode"] === "gallery") {
				mode = "gallery"
			} else if (qs["mode"] === "thumb") {
				mode = "thumb"
			} else {
				console.log("viviz.js: mode = " + qs["mode"] + " not recognized."
					+ " Should be 'thumb' or 'gallery'.")
				mode = VIVIZ["config"]["defaultMode"]
			}
		} else {
			mode = VIVIZ["config"]["defaultMode"]
		}
	}

	var gallerynumber = "1"
	var wrapper = "#" + mode + gallerynumber

	function tooltip(id) {
		if (!tooltip.titles) tooltip.titles = {}
		
		// Prevent native tooltip from showing
		var title = $(wrapper + ' #'+id).attr('title') || $(wrapper + ' #'+id).attr('xtitle')
		$(wrapper + ' #'+id).attr('title','')
		tooltip.titles[id] = title;

		$(wrapper + ' #'+id).on('mouseenter', 
			function () {
				$(this).attr('title', '')
				$(wrapper + ' #tooltip').html(tooltip.titles[id])
			})

		$(wrapper + ' #'+id).on('mouseleave', 
			function () {
				$(this).attr('title', tooltip.titles[id])
				$(wrapper + ' #tooltip').html('')
			})
	}

	location.hash = location.hash.replace("id=dir","dir");

	$(window).unbind('hashchange.' + mode)
	$(window).bind('hashchange.' + mode, function() {
		console.log('viviz.js: Hash has changed to ' + location.hash + ".");

		// Special case where id is only key specified in gallery object in VIVIZ
		// and its value is a query string. (Allowed in order to simplify testing
		// of query strings.)
		var keys = ["catalog","dir","full","thumb","strftime",
					"sprintf","script","list","start","stop"]
		var hash = location.hash
		for (var k in keys) {
			key  = keys[k]
			hash = hash.replace("id=" + key, key)
			hash = hash.replace("id=full" + key, "full" + key)
			hash = hash.replace("id=thumb" + key, "thumb" + key)
		}
		if (hash !== location.hash) {
			console.log('viviz.js: Hash is a query string.')
		}
		location.hash = hash

		if (viviz.triggerreset == false) {
			console.log('viviz.js: viviz.triggerreset = false.  Not resetting application.');
			viviz.triggerreset = true;
		} else {
			console.log('viviz.js: viviz.triggerreset = true. Resetting application.');
			viviz(VIVIZ)
		}
	})

	// Get list of galleries
	console.log("viviz.js: Getting list of galleries.")
	var GALLERIES = cataloginfo()

	if (typeof(GALLERIES) === "string") {
		console.log("viviz.js: Call to cataloginfo() failed.")
		resetdom()
		error(GALLERIES)
		return
	}

	if (location.hash.indexOf("dir") == -1) {
		var galleryid = qs["id"] || GALLERIES["Values"][0]["Id"]
	} else {
		var galleryid = location.hash.replace("#","")
		console.log("viviz.js: galleryid = " + galleryid)
	}

	var GALLERYINFO = galleryinfo(galleryid)

	if (typeof(GALLERYINFO) === "string") {
		console.log("viviz.js: Call to galleryinfo() failed.")
		resetdom()
		error("Problem with configuration for gallery with <code>id = " 
				+ galleryid + "</code>:<br/>" + GALLERYINFO)
		if (!VIVIZ["galleries"]) {
			// Call to galleryinfo sets this object based on VIVIZ["catalog"].
			// If object was not generated, ID was not found in catalog so there
			// will be no header information for gallery.
			setdropdowns(false)
		} else if (VIVIZ["galleries"][galleryid]) {
			// Gallery ID is valid but an error occured.
			// Show gallery configuration.
			setheader()
			setdropdowns(false)
		} else {
			setdropdowns(false)
		}
		return
	}

	if (qs["number"]) {
		console.log("viviz.js: Initial query string had a number.  Using that as defaultFirstImage.")
		VIVIZ["galleries"][galleryid]["defaultFirstImage"] = parseInt(qs["number"])
	}

	// TODO: Do this for all optional parameters.
	if (!VIVIZ["galleries"][galleryid]["defaultFirstImage"]) {
		console.log("viviz.js: defaultFirstImage not set in gallery configuration.  Using default.");
		VIVIZ["galleries"][galleryid]["defaultFirstImage"] = parseInt(VIVIZ["config"]["defaultFirstImage"]);
	} else {
		VIVIZ["galleries"][galleryid]["defaultFirstImage"] = parseInt(VIVIZ["galleries"][galleryid]["defaultFirstImage"])
	}

	resetdom()
	setheader()
	setdropdowns()

	// Button to switch between gallery and thumb view
	$("#gallerybrowsebutton").unbind('click')
	$("#gallerybrowsebutton").click(function () {
		if (VIVIZ["config"]["defaultMode"] === "gallery") {
			location.hash = location.hash.replace("&mode=thumb","")
		} else {
			// Remove any existing mode=gallery and append mode=thumb
			location.hash = location.hash.replace("&mode=thumb","") + "&mode=gallery"
		}
	})
	$("#thumbbrowsebutton").unbind('click')
	$("#thumbbrowsebutton").click(function () {
		viviz.triggerreset = true;
		if (VIVIZ["config"]["defaultMode"] === "thumb") {			
			location.hash = location.hash.replace("&mode=gallery","")
		} else {
			// Remove any existing mode=gallery and append mode=thumb
			location.hash = location.hash.replace("&mode=gallery","") + "&mode=thumb"
		}
	})

	// TODO: These should be in callback for setdropdowns.
	// Use https://github.com/caolan/async
	// aync.series([resetdom,setheader,setdropdowns,gallery])
	// aync.series([resetdom,setheader,setdropdowns,thumb])
	if (mode === 'gallery') gallery()
	if (mode === 'thumb') thumb()		

	function cataloginfo(galleryid) {

		var qs = location.hash.replace(/^#/,'')
		var qo = $.parseQueryString()

		var selected = qo["catalog"] || VIVIZ["config"]["defaultCatalog"];

		if (qo["config"]) {
			if (qo["config"].indexOf(".pngwalk")) {
				dataType = "text";
			}
			var url = VIVIZ["config"]["proxyServer"] + qo["config"]
			try {
				console.log("cataloginfo(): Reading " + url);
				$.ajax({
						type: "GET",
						url: url,
						async: false,
						dataType: dataType,
						success: 
							function (data, textStatus, jqXHR) {
								console.log("cataloginfo(): Finished reading " + url + ".  Contents:")
								console.log(data)
								if (!data) {
									errmsg = "Problem with data returned from "
											+ "<a style='text-decoration:underline' href='" 
											+ url
											+ "'>" 
											+ url
											+ "</a>."
									console.log("cataloginfo(): Problem with data returned from " + url)
								}
								if (qo["config"].indexOf(".pngwalk")) {
									v = data.split(/\n/)
									console.log(v)
									var fulldir=qo["config"].replace("product.pngwalk","") + v[1].replace("baseurl=.","")
									console.log(v[1].replace("baseurl=."))
									var strftime = v[2].replace('product=',"") + "_" + v[3].replace("timeFormat=","").replace(/%/g,"$") + ".png"
									console.log(strftime)
									ss = v[4].replace("timeRange=","").replace(" through "," ").split(" ")
									var start = ss[0].substring(0,4) + "-" + ss[0].substring(4,6) + "-" + ss[0].substring(6,8)
									var stop = ss[1].substring(0,4) + "-" + ss[1].substring(4,6) + "-" + ss[1].substring(6,8)
									var id = qo["config"];
									var gallery = {"id": id, "fulldir": fulldir, "strftime": strftime, "start": start, "stop": stop};									VIVIZ["catalogs"][selected].unshift(gallery)

								}
							},
						error: 
							function (xhr, textStatus, errorThrown) {
								errmsg = "Could not read <a style='text-decoration:underline' href='" + VIVIZ['config']["catalog"] + "'>" + VIVIZ['config']["catalog"] + "</a>. Error: " + errorThrown.message.split(":")[0]
								console.log("cataloginfo(): Could not read " + VIVIZ['config']["catalog"] + ". Error: " + errorThrown.message.split(":")[0])
							}
					})
			} catch (err) {
				// If URL returns a 404, error above is not triggered if
				// there is text in the message body.  Instead, there is
				// an interal error "Cannot read property split of undefined."
				// that must be caught.
				errmsg = "Could not read "
						+ "<a style='text-decoration:underline' href='" 
						+ url
						+ "'>" 
						+ url
						+ "</a>."
				console.log("cataloginfo(): Could not read " + url + ".")
			}
		}

		var hashisgallery = false
		if (location.hash.indexOf("dir=") != -1){
			if (location.hash.length > 1) {
				hashisgallery = true
			}
		}

		if (hashisgallery) {
			// Hash is query string with gallery information
			console.log("cataloginfo(): Hash is a query string with gallery information: ")
			delete qo["catalog"]
			console.log(qo)
			qo["id"] = location.hash.replace("#","")
			qo["title"] = ""//location.hash.replace("#","")
			var url = "";
			var found = false;
			for (var i = 0; i < VIVIZ["catalogs"][selected].length; i++) {
				//console.log(VIVIZ["catalogs"][selected][i]["id"])
				//console.log(qo["id"])
				if (VIVIZ["catalogs"][selected][i]["id"] == qo["id"]) {
					found = true
					break
				}
			}
			if (found) {
				console.log("cataloginfo(): Hash found in gallery list of " + selected + ".")
			} else {
				console.log("cataloginfo(): Hash not found in gallery list of " + selected + ".")
				console.log("cataloginfo(): Prepending gallery to gallery list of " + selected + ".")
				VIVIZ["catalogs"][selected].unshift(qo)
			}
		} else {
			var url = VIVIZ["config"]["catalogs"][selected]["URL"]
		}

		var errmsg = ""

		if (url !== "" && !VIVIZ["catalogs"][selected] && !hashisgallery) {
			if (location.href.match(/^file/)) {
				console.log("cataloginfo(): Application cannot read " 
						+ url 
						+ " because it is not available from a server.")
				if (hashisgallery == false) {
					console.log("cataloginfo(): Problem with query string.")
					errmsg =  "In this mode, ViViz is not allowed to read "
							+ "the external configuration file " + url 
							+ " <a style='text-decoration:underline' href='" 
							+ url + "'>" 
							+ url + "</a>).<br/>"
							+ "Contents of this file must be copied into ViViz['catalogs']['" + selected + "']"
							+ " in index.htm or index.htm must be viewed from a server."
				} else {
					VIVIZ["catalog"] = []
				}
			} else {
				console.log("cataloginfo(): Configuraton for " 
								+ selected
								+ " is from a URL (" + url + ") that returns JSON. Requesting it.")
				try {
					$.ajax({
							type: "GET",
							url: url,
							async: false,
							dataType: "json",
							success: 
								function (data, textStatus, jqXHR) {
									console.log("cataloginfo(): Finished reading " + url + ".  Contents:")
									console.log(data)
									if (!data) {
										errmsg = "Problem with data returned from "
												+ "<a style='text-decoration:underline' href='" 
												+ url
												+ "'>" 
												+ url
												+ "</a>."
										console.log("cataloginfo(): Problem with data returned from " + url)
									}
									VIVIZ["catalogs"][selected] = data
								},
							error: 
								function (xhr, textStatus, errorThrown) {
									errmsg = "Could not read <a style='text-decoration:underline' href='" + VIVIZ['config']["catalog"] + "'>" + VIVIZ['config']["catalog"] + "</a>. Error: " + errorThrown.message.split(":")[0]
									console.log("cataloginfo(): Could not read " + VIVIZ['config']["catalog"] + ". Error: " + errorThrown.message.split(":")[0])
								}
						})
				} catch (err) {
					// If URL returns a 404, error above is not triggered if
					// there is text in the message body.  Instead, there is
					// an interal error "Cannot read property split of undefined."
					// that must be caught.
					errmsg = "Could not read "
							+ "<a style='text-decoration:underline' href='" 
							+ url
							+ "'>" 
							+ url
							+ "</a>."
					console.log("cataloginfo(): Could not read " + url + ".")
				}
			}
		}

		if (errmsg !== "") {
			console.log(errmsg)
			return errmsg
		}

		// If no arguments, return list of galleries.
		if (arguments.length == 0) {

			if (!VIVIZ["catalogs"][selected]) {
				var msg = "No catalog object found for " + selected + ".";
				console.log("cataloginfo(): " + msg)
				return msg
			}

			var GALLERIES           = new Object()
			GALLERIES["Title"]      = "Galleries"
			GALLERIES["Titleshort"] = "-Galleries-"
			GALLERIES["Class"]      = "updatelglobal"
			GALLERIES["Values"]     = new Array()

			VIVIZ["catalogs"][selected]
				.forEach(
					function (el,i) {
						GALLERIES["Values"][i] = new Object()
						if (el.title) {
							GALLERIES["Values"][i]["Title"] = el.id + ": " + el.title
						} else {
							GALLERIES["Values"][i]["Title"] = el.id
						}
						if (el.isqs) {
							GALLERIES["Values"][i]["Title"] = el.id 
										+ ": Gallery defined by query string."
						}
						GALLERIES["Values"][i]["Value"] = el.id
						GALLERIES["Values"][i]["Id"]    = el.id
					})
					
			if (GALLERIES.Values.length == 0) {
				console.log("cataloginfo(): Could not generate a gallery menu based on VIVIZ['catalog'].")
				return " Could not generate a gallery menu based on VIVIZ['catalog']."
			}

			console.log("cataloginfo(): Returning list of "
						+ GALLERIES.Values.length + " galleries in catalog " + selected)
			return GALLERIES
		}

		// If galleryid given, return gallery information.
		if (arguments.length == 1) {

			console.log("cataloginfo(): Looking for info for gallery with id = " + galleryid + " in catalog = " + selected)
			var _CATALOGINFO = new Object()

			// Find gallery with matching id in json array.
			var found = true
			for (i = 0;i < VIVIZ["catalogs"][selected].length; i++) {
				if (VIVIZ["catalogs"][selected][i]["id"] === galleryid) {
					found = false
					break
				}
			}

			if (found) {
				var msg = "Gallery with <code>id = "+ galleryid + "</code> "
					+ "not found in catalog:<br/>"
					+ "<textarea style='width:40em;height:20em'>"
					+ JSON.stringify(VIVIZ["catalog"], null, 4)
					+ "</textarea>"
				console.log("cataloginfo(): Gallery with "
					+ "<code>id = "+ galleryid + "</code>"
					+ " not found in catalog.")
				return msg
			}
			
			// Gallery nodes will be stored in this object so they can
			// be referenced by id.
			if (!VIVIZ["galleries"]) VIVIZ["galleries"] = {}
			VIVIZ["galleries"][galleryid] = {}

			// Replace gallery information with values in query string.
			for (key in qo) {
				if (qo[key]) {
					if (qo[key] === 'true') {qo[key] = true}
					if (qo[key] === 'false') {qo[key] = false}
					if ($.isNumeric(qo[key])) {qo[key] = parseFloat(qo[key])}
					console.log("cataloginfo(): Setting " + key + " from " 
									+ VIVIZ["galleries"][galleryid][key] + " to " + qo[key])
					VIVIZ["catalogs"][selected][i][key] = qo[key]
				}
			}

			if (VIVIZ["catalogs"][selected][i]["dir"] || VIVIZ["catalogs"][selected][i]["fulldir"] !== VIVIZ["catalogs"][selected][i]["thumbdir"]) {
				// If thumbdir != fulldir in gallery configuration, set scaling of thumbs to 1.0
				if (!VIVIZ["catalogs"][selected][i]["thumbWidth"] && !VIVIZ["catalogs"][selected][i]["thumbHeight"]) {
					if (VIVIZ["catalogs"][selected][i]["thumbdir"]) {
						VIVIZ["galleries"][galleryid]["thumbWidth"] = 1.0
						VIVIZ["galleries"][galleryid]["thumbHeight"] = 1.0
					}
				}
				// If only one was specified, assume other is same if fraction given
				if (VIVIZ["catalogs"][selected][i]["thumbWidth"] && !VIVIZ["catalogs"][selected][i]["thumbHeight"]) {
					if (VIVIZ["catalogs"][selected][i]["thumbWidth"] <= 1.0) {
						VIVIZ["galleries"][galleryid]["thumbHeight"] = VIVIZ["catalogs"][selected][i]["thumbWidth"]
					} else {
						VIVIZ["galleries"][galleryid]["thumbHeight"] = ""
					}
				}
				if (VIVIZ["catalogs"][selected][i]["thumbHeight"] && !VIVIZ["catalogs"][selected][i]["thumbWidth"]) {
					if (VIVIZ["catalog"][i]["thumbHeight"] <= 1.0) {
						VIVIZ["galleries"][galleryid]["thumbWidth"] = VIVIZ["catalogs"][selected][i]["thumbHeight"]
					} else {
						VIVIZ["galleries"][galleryid]["thumbWidth"] = ""
					}
				}
			}

			// Copy gallery information
			for (key in VIVIZ["catalogs"][selected][i]) {
				if (typeof(VIVIZ["catalogs"][selected][i]) === 'string') {
					// If a URL to a catalog was given, remove leading and trailing spaces.
					VIVIZ["galleries"][galleryid][key] = VIVIZ["catalogs"][selected][i][key].replace(/^\s+|\s+$/g,'')
				} else {
					VIVIZ["galleries"][galleryid][key] = VIVIZ["catalogs"][selected][i][key]
				}
			}

			// Copy configuration information found in VIVIZ["config"] and
			// not found in gallery configuration.
			for (key in VIVIZ["config"]) {
				if (typeof(VIVIZ["galleries"][galleryid][key]) === 'undefined') {
					VIVIZ["galleries"][galleryid][key] = VIVIZ["config"][key]
				}
			}

			// Copy configution information for display in header.
			VIVIZ["galleries"][galleryid]["json"] = VIVIZ["catalogs"][selected][i]
			
			// Delete elements with no value.
			for (var key in VIVIZ["galleries"][galleryid]) {
				if (VIVIZ["galleries"][galleryid][key] === "") {
					delete VIVIZ["galleries"][galleryid][key]
				}
			}
			console.log("cataloginfo(): Returning")
			console.log(VIVIZ["galleries"][galleryid])
			return VIVIZ["galleries"][galleryid]
		}
	}

	function galleryinfo(galleryid) {

		var usecache = true

		if (usecache) {
			if (typeof(galleryinfo.GALLERYINFO) !== 'object') {
				galleryinfo.GALLERYINFO = new Object()
			}
			
			if (galleryinfo.GALLERYINFO[galleryid]) {
				console.log("gallerinfo(): Cache hit.")
				return galleryinfo.GALLERYINFO[galleryid]
			}
		}

		var CATALOGINFO = cataloginfo(galleryid)

		// Catches case where galleryid is not found.
		if (typeof(CATALOGINFO) === "string") {return CATALOGINFO}

		var types = ["full", "thumb"]

		for (var j in types) {

			var type = types[j]
			var files = []

			if (CATALOGINFO["dir"] && !CATALOGINFO[type+"dir"]) {
				CATALOGINFO[type+"dir"] = CATALOGINFO["dir"]
			}

			if (CATALOGINFO["script"] && !CATALOGINFO[type+"script"]) {
				CATALOGINFO[type+"script"] = CATALOGINFO["script"]
			}
			if (typeof(CATALOGINFO[type+"script"]) === 'string') {
				files = eval("(" + CATALOGINFO[type+"script"] + ")()")
			}
			if (typeof(CATALOGINFO[type+"script"]) === 'function') {
				files = eval(CATALOGINFO[type+"script"]())
			}

			if (CATALOGINFO["files"] && !CATALOGINFO[type+"files"]) {
				CATALOGINFO[type+"files"] = CATALOGINFO["files"]
			}

			if (typeof(CATALOGINFO[type+"files"]) !== 'undefined') {
				files = extractfiles(CATALOGINFO[type+"files"])
				if (typeof(files) === 'string') {
					return files // Response is an error message.
				}
			}
			
			var options = {}

			if (CATALOGINFO["start"] && !CATALOGINFO[type+"start"]) {
				CATALOGINFO[type+"start"] = CATALOGINFO["start"]
			}	
			if (CATALOGINFO["stop"] && !CATALOGINFO[type+"stop"]) {
				CATALOGINFO[type+"stop"] = CATALOGINFO["stop"]
			}

			if (CATALOGINFO["strftime"] && !CATALOGINFO[type+"strftime"]) {
				CATALOGINFO[type+"strftime"] = CATALOGINFO["strftime"]
			}	
			if (CATALOGINFO[type+"strftime"]) {
				options.type = "strftime";
				// TODO: Need to document why this try/catch is needed.
				try {
					options.template = decodeURIComponent(CATALOGINFO[type+"strftime"])
				} catch(err) {
					options.template = CATALOGINFO[type+"strftime"]
				}
				options.timeRange = CATALOGINFO[type+"start"] + "/" + CATALOGINFO[type+"stop"]
			}

			if (CATALOGINFO["sprintf"] && !CATALOGINFO[type+"sprintf"]) {
				CATALOGINFO[type+"sprintf"] = CATALOGINFO["sprintf"]
			}	
			if (CATALOGINFO[type+"sprintf"]) {
				options.type = "sprintf";
				try {
					options.template = decodeURIComponent(CATALOGINFO[type+"sprintf"])
				} catch(err) {
					options.template = CATALOGINFO[type+"sprintf"]
				}
				if (CATALOGINFO["delta"] && !CATALOGINFO[type+"delta"]) {
					CATALOGINFO[type+"delta"] = CATALOGINFO["delta"]
				}	
				var step = parseInt(CATALOGINFO[type+"delta"])
				if (isNaN(step)) {
					var step = 1
					console.log("galleryinfo.js: delta is not defined " + " or is NaN.  Using value of 1.")
				}
				options.indexRange = CATALOGINFO[type+"start"] + "/" + CATALOGINFO[type+"stop"] + "/" + step
			}

			if (CATALOGINFO[type+"sprintf"] || CATALOGINFO[type+"strftime"]) {
				options.debug = false
				var xfiles = expandtemplate(options)
				for (var i = 0; i < xfiles.length; i++) {
					files[i] = [xfiles[i]]
				}
			}

			VIVIZ["galleries"][galleryid][type+"files"] = files
		}

		// If no full dir given, files are in same directory as index.htm 
		if (!CATALOGINFO["fulldir"]) {
			CATALOGINFO["fulldir"] = ""
		}

		if (CATALOGINFO["thumbdir"]) {
			if (CATALOGINFO["thumbdir"].indexOf("http") != 0 && CATALOGINFO["fulldir"].indexOf("http") == 0) {
				// If thumbdir does not start with http and fulldir does,
				// thumbdir path is relative to fulldir
				CATALOGINFO["thumbdir"] = CATALOGINFO["fulldir"] + CATALOGINFO["thumbdir"]
			}
		}

		if (!CATALOGINFO["thumbdir"]) {
			CATALOGINFO["thumbdir"] = CATALOGINFO["fulldir"]
		}

		if (VIVIZ["galleries"][galleryid]["fullfiles"].length == 0) {
			console.log("No full file list was generated.")
			return "No full file list was generated."
		}
		if (VIVIZ["galleries"][galleryid]["thumbfiles"].length == 0) {
			VIVIZ["galleries"][galleryid]["thumbfiles"] = VIVIZ["galleries"][galleryid]["fullfiles"]
		}
		if (VIVIZ["galleries"][galleryid]["thumbfiles"].length != VIVIZ["galleries"][galleryid]["fullfiles"].length) {
			console.log("Thumb file list length does not match full file length.")
			return "Thumb file list length does not match full file list length."
		}

		if (VIVIZ["galleries"][galleryid]["fullfiles"][0][0].indexOf("file:") == 0) {
			if (location.href.indexOf("file:") != 0) {
				var msg = "Full file URLs cannot start with file:/ if running in web server mode."
				console.log(msg)
				return msg
			}
		}

		VIVIZ["galleries"][galleryid]["orders"] = extractorders()
		VIVIZ["galleries"][galleryid]["attributes"] = extractattributes()
		VIVIZ["galleries"][galleryid]["totalingallery"] = VIVIZ["galleries"][galleryid]["fullfiles"].length 

		if (VIVIZ["config"]["useAutoAttributes"] || VIVIZ["galleries"][galleryid]["useAutoAttributes"]) {

			// When useAutoAttributes is true, ignores attributes specified in file.
			// TODO: Add options useAutoAttributesOnly (current meaning of useAutoAttributes) 
			// and useAutoAttributesAlso (Append auto attributes to existing)?	

			na = 0

			// Create regexps based on time information
			if (CATALOGINFO["fullstrftime"]) {

				var msg = testdecode(CATALOGINFO["fullstrftime"])
				if (msg !== "") return msg;

				VIVIZ["galleries"][galleryid]["autoattributes"] = 
					filterlist(CATALOGINFO["fullstart"], CATALOGINFO["fullstop"], decodeURIComponent(CATALOGINFO["fullstrftime"]))
			
				VIVIZ["galleries"][galleryid]["attributes"]["Values"][0]["Filters"] = 
					VIVIZ["galleries"][galleryid]["autoattributes"]

				// Add an All attribute at the end.
				na = VIVIZ["galleries"][galleryid]["autoattributes"].length || 0
			}

			VIVIZ["galleries"][galleryid]["attributes"]["Values"][0]["Filters"][na] = {}
			VIVIZ["galleries"][galleryid]["attributes"]["Values"][0]["Filters"][na].Title = "All"
			VIVIZ["galleries"][galleryid]["attributes"]["Values"][0]["Filters"][na].Value = ".*"	
		}

		var msg = testdecode(VIVIZ["galleries"][galleryid]["fulldir"])
		if (msg !== "") return msg;
		var msg = testdecode(VIVIZ["galleries"][galleryid]["thumbdir"])
		if (msg !== "") return msg;

		VIVIZ["galleries"][galleryid]["fulldirdecoded"] = decodeURIComponent(VIVIZ["galleries"][galleryid]["fulldir"]);
		VIVIZ["galleries"][galleryid]["thumbdirdecoded"] = decodeURIComponent(VIVIZ["galleries"][galleryid]["thumbdir"]);
		// Decoding of files takes place in thumblist()

		if (usecache) {
			galleryinfo.GALLERYINFO[galleryid] = VIVIZ["galleries"][galleryid]
		}

		console.log("galleryinfo.js: Returing"); console.log(VIVIZ["galleries"][galleryid])
		return VIVIZ["galleries"][galleryid]

		function extractorders() {

			var ORDERS = {
					"Title": "Sort images by attribute",
					"Titleshort": "-Sort by-",
					"Class": "updatelocal",
					"Values": [
								{"Title": "No sort", "Value": "none"},
								{"Title": "Ascending", "Value": "ascending"},
								{"Title": "Descending","Value": "descending"},
								{"Title": "Random","Value": "random"}
							  ]
			}
			return ORDERS
		}

		function extractattributes() {

			var files = VIVIZ["galleries"][galleryid]["fullfiles"];
			if (VIVIZ["galleries"][galleryid]["attributes"]) {
				console.log("galleryinfo.extractattributes(): First array element contains attribute names.")
				var AttributeNames = VIVIZ["galleries"][galleryid]["attributes"]
			}

			ATTRIBUTES = new Object();
			
			ATTRIBUTES["Title"]      = "Image attributes"
			ATTRIBUTES["Titleshort"] = "-Attribute-"
			ATTRIBUTES["Class"]      = "updatelocal"

			ATTRIBUTES["Values"]             = new Array()
			ATTRIBUTES["Values"][0]          = new Object()
			ATTRIBUTES["Values"][0]["Title"] = "Filename"
			ATTRIBUTES["Values"][0]["Value"] = "Filename"

			// If file list has attributes.
			for (var k = 1;k < files[0].length;k++) {
				ATTRIBUTES["Values"][k] = new Object()
				if (AttributeNames) {
					ATTRIBUTES["Values"][k]["Title"] = AttributeNames[k]
					ATTRIBUTES["Values"][k]["Value"] = AttributeNames[k]

				} else {
					ATTRIBUTES["Values"][k]["Title"] = "Attribute " + (k)
					ATTRIBUTES["Values"][k]["Value"] = "Attribute" + (k)
				}
			}

			if (!VIVIZ["galleries"][galleryid]["filters"]) {
				ATTRIBUTES["Values"][0]["Filters"]    = new Array()
				ATTRIBUTES["Values"][0]["Filters"][0] = new Object()
				ATTRIBUTES["Values"][0]["Filters"][0]["Title"] = "All"
				ATTRIBUTES["Values"][0]["Filters"][0]["Value"] = ".*"
				return ATTRIBUTES
			}

			var filters = VIVIZ["galleries"][galleryid]["filters"]
			console.log(filters)
			for (var i = 0; i < filters.length; i++) {
				ATTRIBUTES["Values"][i] = new Object();
				ATTRIBUTES["Values"][i]["Title"] = AttributeNames[i];
				ATTRIBUTES["Values"][i]["Value"] = AttributeNames[i];
				ATTRIBUTES["Values"][i]["Filters"] = new Array();
				for (var j = 0; j < filters[i].length; j++) {
					console.log(filters[i][j])
					ATTRIBUTES["Values"][i]["Filters"][j] = new Object();
					ATTRIBUTES["Values"][i]["Filters"][j]["Title"] = filters[i][j]["name"];
					ATTRIBUTES["Values"][i]["Filters"][j]["Value"] = filters[i][j]["value"];
				}
			}

			return ATTRIBUTES;
		}

		function extractfiles(URLFiles) {
			
			if (typeof(URLFiles) === 'object') {
				return URLFiles
			}

			var msg = ""
			if (location.href.indexOf("file") == 0) {
				msg = "Configuration variable <code>fullfiles</code> cannot be an external file (local or remote) unless this page is loaded from a web server."
				console.log(msg)
				return msg
			}

			// fullfiles is a string with newlines
			if (URLFiles.indexOf("\n") != -1) {
				fullfiles = CSVToArray(URLFiles.replace(/\n$/,''))			
				return fullfiles
			}
			
			// fullfiles is a URL, check if proxy is needed.
			if (URLFiles.indexOf("http") != -1) {
				var tmparr = URLFiles.split("/");
				var tmparrp = VIVIZ["config"]["proxyServer"].split("/");

				var proxy = tmparrp[2]
				var files = tmparr[2]
				var host = location.hostname+(location.port ? ':'+location.port: '')

				if (VIVIZ["config"]["proxyServer"]) {
					if (host !== files) {
						console.log("Proxy server is required.");
						if (proxy !== host) {
							var msg = "proxyServer address (" + proxy + ") specified in configuation must match application address (" + host + ")"
							console.log(msg)
						} else {
							// TODO: Check that proxy actually works.
							URLFiles = VIVIZ["config"]["proxyServer"] + URLFiles;
						}
					}
				} else {
					if (host === files) {

					} else {
						console.log("Request is for file list from a http address, but no proxyServer specified in configuration and server address for file is not same as address of application.")
						console.log("Request will fail because of Same Origin policy.")
						msg = "proxyServer must be specified in configuration or filelist URL must start with http://" + location.hostname+(location.port ? ':'+location.port: '')
						console.log(msg)
					}

				}
			}

			var FILES = new Array()
			$("#status").text("Retrieving list of files.")
			console.log("galleryinfo.extractfiles(): Getting file list from " + URLFiles)
			if (URLFiles.match(/\.txt$/)) {
				$.ajax({
					type: "GET",
					url: URLFiles,
					async: false,
					dataType: "text",
					error: geterror,
					success: function (data) {
								if (data.indexOf("<html") >= 0) {
									msg = "Error parsing <a style='text-decoration:underline' href='" + URLFiles + "'>" + URLFiles + "</a>.  File contains html tag."
									console.log(msg)	
								} else {
									console.log('galleryinfo.extractfiles(): Extracting files from ' + URLFiles)
									FILES = CSVToArray(data.replace(/\n$/,''))
									//FILES = data.split(/\n/); Use this instead?
								}
							}
				});
				$("#status").text("")
			} else {
				// A service request that returns a JSON array of files.
				$.ajax({
					type: "GET",
					url: URLFiles,
					async: false,
					dataType: "json",
					error: geterror,
					success: function (data) {
								console.log('Extracting files from ' + URLFiles)
								if (typeof(data[0]) === "string") {
									for (var k=0;k<data.length;k++) {
										FILES[k] = []
										FILES[k][0] = data[k]
									}
								} else {
									FILES = data
								}	
							}
				})
			}

			function geterror(err, textStatus, errorThrown) {
				console.log(err)
				msg = "Error getting <a style='text-decoration:underline' target='_blank' href='" + URLFiles + "'>" + URLFiles + "</a>."
				if (textStatus && textStatus !== 'error') {
					if (errorThrown) {
						msg = msg + "<br/>Error: " + textStatus + ", " + errorThrown
					} else {
						msg = msg + "<br/>Error: " + textStatus + "."
					}
				}
				if (err.status != 200) {
					msg = msg + "<br/>Error: " + err.statusText + "; " + $(err.responseText).text();
				}
				console.log(msg)
			}
			$("#status").text("")

			if (msg !== "") return msg
			return FILES
		}

		function filterlist(Start,Stop,TEMPLATE) {

			TEMPLATE = TEMPLATE.replace(/%/g,"$")
			if (TEMPLATE.indexOf("$Y-$m-$d") == -1 && TEMPLATE.indexOf("$Y$m$d") == -1) {
				return []			
			}

			if (typeof(Start) !== 'string') {
				return []
			}

			var startstop = expandISO8601Duration(Start + "/" + Stop)
			StartYear = parseInt(startstop.split("/")[0].substring(0,4))
			StopYear  = parseInt(startstop.split("/")[1].substring(0,4))

			FILTERS = new Array();

			for (var j=0;j<(StopYear-StartYear+1);j++) {
				var patt = new RegExp(TEMPLATE);
				year = ""+(j+StartYear);
				var PATTERN = TEMPLATE.replace(TEMPLATE,year);
				FILTERS[j] = {"Title":year,"Value":PATTERN};
			}
			return FILTERS;
		}
	}

	function resetdom() {
		console.log("resetdom(): Called.")

		// Make copy of catalogwrapper and place in thumb container.
		if ($("#thumb" + gallerynumber + " #catalogwrapper").length == 0) {
			$("#gallery" + gallerynumber + " #catalogwrapper").clone().insertAfter("#thumb" + gallerynumber + " #error")
		}

		// Toggle state set when call to cataloginfo() failed.
		// No - causes size of app to change when gallery changed.	
		//$("#thumb" + gallerynumber).parent().hide()
		//$("#gallery" + gallerynumber).parent().hide()

		$("#thumb" + gallerynumber + " .well").show()
		$("#gallery" + gallerynumber + " .well").show()

		$(wrapper + ' #workingfullframe').css('visibility','hidden')
		$(wrapper + " #gallerythumbframe").html('')

		if ($(wrapper + " #galleryopen:visible").length == 0) {
			$(wrapper + " #infoclose").click()
		}

		// Keep full frame width and height what it was last.  When image is
		// loaded, proper dimensions will be set.
		if (1) {
		if ($(wrapper + " #fullframe").width() > 0)
			$(wrapper + " #fullframe").width($(wrapper + " #fullframe").width())
		if ($(wrapper + " #fullframe").height() > 0)
			$(wrapper + " #fullframe").height($(wrapper + " #fullframe").height())
		}

		$(wrapper + " #fullframe").html('')
		$(wrapper).attr('nowvisible', '').attr('lastvisible', '').attr('totalvisible', '').attr('totalingallery', '')
		$(wrapper + " #controls").html('&nbsp;')
		$(wrapper + " #dropdowns").html('')
		$(wrapper + " #attributes").html('&nbsp;')
		$(wrapper + " #filename").html('&nbsp;')
		$(wrapper + " #error").html('').hide()
		$(wrapper + " #warning").html('').hide()

		$(wrapper + " #connectionerror").html('')
		$(wrapper + " #catalog").html('')
		$(wrapper + " #thumbbrowseframe").html('')
	}

	function testdecode(component) {
		try {
			var tmp = decodeURIComponent(component)
			return ""
		} catch (err) {
			var msg = "Error when evaluating decodeURIComponent('" + component + "').";
			if (component.indexOf("%") != -1) {
				msg = msg + "<br/>Consider using $ instead of % in strftime and sprintf."
			}
			console.log(msg)
			return msg					
		}
	}

	function error(msg, clear) {
		$(wrapper).parent().show()
		$(wrapper + " .well").hide()
		$(wrapper + " #error").show()
		if (clear) {
			$(wrapper + ' #error').html(msg)
		} else {
			if ($(wrapper + ' #error').text() === "") {
				$(wrapper + ' #error').append(msg)
			} else {
				$(wrapper + ' #error').append("<br/>" + msg)
			}
		}
	}

	function warning(msg, clear, totime) {

		$(wrapper + ' #warning').show()
		if (clear) {
			$(wrapper + ' #warning').html(msg);
		} else {
			spacer = ""
			if ($(wrapper + ' #warning').text().length > 0) {
				spacer=" | "
			}
			$(wrapper + ' #warning').append(spacer + msg)
		}

		if (warning.lt) {
			clearTimeout(warning.lt);
		}

		if (isFinite(totime)) {
			warning.lt = setTimeout(
							function () {
								$(wrapper + ' #warning').html('').hide();
							}, totime)
		}
	}

	function setheader() {

		console.log("setheader(): Setting header in " + wrapper 
			+ " based on gallery information for " + galleryid)

		// Select items to hide based on configuration.
		for (key in VIVIZ["config"]) {
			// Key name starts with "show"
			if (key.indexOf("show") == 0) {
				if (VIVIZ["galleries"][galleryid][key] == false) {
					console.log("setheader(): Hiding " + wrapper + " #" + key.replace("show",""))
					$(wrapper + " #" + key.replace("show","").toLowerCase() + "wrapper").hide()
				}
			}
		}

		// If call to galleryinfo() failed, show gallery configuration and return.
		if (typeof(GALLERYINFO) === "string") {
			$(wrapper + ' #workingfullframe').css('visibility','hidden')
			$(wrapper+' #catalog')
				.html(JSON.stringify(
					VIVIZ["galleries"][galleryid]["json"], null, 4).replace(/\n/g,"<br/>"))
			$(wrapper + ' #catalogwrapper').show()
			return
		}
		
		// Set window title.
		if (GALLERYINFO["title"]) {
			$("head title").html(GALLERYINFO["title"])
		} else {
			$("head title").html(GALLERYINFO["id"])
		}

		// Set link and title for ? button.  Compute tlink for later use.
		if (GALLERYINFO["aboutlink"]) {
			var title = "Gallery info:\n" + GALLERYINFO["aboutlink"]
			var onclick = 'window.open("' + GALLERYINFO["aboutlink"] + '","_blank")'
			var tlink = "<span style='text-decoration:underline;cursor:pointer' title='"+title+"' onclick='"+onclick+"'>"
			if (GALLERYINFO["title"]) {
				tlink = tlink+GALLERYINFO["title"]+"</span>"
			} else {
				tlink = tlink+GALLERYINFO["id"]+"</span>"
			}
			$(wrapper + " #aboutbuttonwrapper").attr("onclick",onclick)
			$(wrapper + " #aboutbutton").attr("title",title)
			$(wrapper + " #aboutbuttonwrapper").show()
		} else {
			if (GALLERYINFO["title"]) {
				var tlink = GALLERYINFO["title"]
			} else {
				var tlink = GALLERYINFO["id"]
			}			
		}

		// Set about text.
		if (GALLERYINFO["about"]) {
			$(wrapper + " #abouttext").html(tlink + ": " + GALLERYINFO["about"])
		} else {
			if (GALLERYINFO["title"]) {
				$(wrapper + " #abouttext").html(tlink)
			} else {
				if (location.hash.indexOf("id=") == -1) {
					$(wrapper + " #abouttext").html("Gallery generated based on URL.")	
				} else {
					$(wrapper + " #abouttext").html(galleryid)	
				}
			}
		}

		$(wrapper + " #catalogopen").unbind('click')
		$(wrapper + " #catalogopen").click(
				function () {
					if ($(wrapper + " #infoclose").css('visibility') == "visible") {
						$(wrapper + " #infoclose").click();
						return
					}

					$(wrapper + ' #info').width($(wrapper + ' #info').width());
					$(wrapper + ' #info').height('200px')
					var val = $(wrapper + " #catalog option:selected").val()
					// Show catalog information
					$(wrapper+' #info')
						.html(
							JSON.stringify(VIVIZ["catalogs"][val], null, 4)
							.replace(/\n/g,"<br/>").replace(/ /g,"&nbsp;")
						)
					$(wrapper + ' #infoclose').css("visibility","visible")
				})

		// Gallery configuration area
		$(wrapper + " #galleryopen").unbind('click')
		$(wrapper + " #galleryopen").click(
				function () {
					if ($(wrapper + " #infoclose").css('visibility') == "visible") {
						$(wrapper + " #infoclose").click();
						return
					}

					//$(wrapper+' #catalog').width($(wrapper+' #catalog').width())
					if (GALLERYINFO["json"]["fullscript"]) {
						// Convert function declaration to string.
						GALLERYINFO["json"]["fullscript"] = 
							"" + GALLERYINFO["json"]["fullscript"]
					}
					if (GALLERYINFO["json"]["thumbscript"]) {
						// Convert function declaration to string.
						GALLERYINFO["json"]["thumbscript"] = 
							"" + GALLERYINFO["json"]["thumbscript"]
					}
					$(wrapper+' #info')
						.html(JSON.stringify(
							GALLERYINFO["json"], null, 4)
							.replace(/\n/g,"<br/>").replace(/ /g,"&nbsp;")
							)
					//$(wrapper + ' #galleryopen').css("visibility","hidden")
					$(wrapper + ' #infoclose').css("visibility","visible")
				})

		// Gallery configuration area
		$(wrapper + " #applicationopen").unbind('click')
		$(wrapper + " #applicationopen").click(
				function () {

					if ($(wrapper + " #infoclose").css('visibility') == "visible") {
						$(wrapper + " #infoclose").click();
						return
					}

					$(wrapper + ' #info').width($(wrapper + ' #info').width());
					$(wrapper + ' #info').height('200px')
					var val = $(wrapper + " #catalog option:selected").val()
					// Show configuration information
					$(wrapper+' #info')
						.html(
							JSON.stringify(VIVIZ["config"], null, 4)
							.replace(/\n/g,"<br/>").replace(/ /g,"&nbsp;")
						)
					$(wrapper + ' #infoclose').css("visibility","visible")
				})


		$(wrapper + " #infoclose").unbind('click')
		$(wrapper + " #infoclose").click(
				function () {
					$(wrapper + " #info").html('')
					$(wrapper + ' #info').height('')
					$(wrapper + ' #infoclose').css("visibility","hidden")
				})
	}

	function updatehash(el, val, triggerreset) {

		var qs = $.parseQueryString()

		if (triggerreset) {
			console.log("updatehash(): triggerrest parameter given. Setting viviz.triggerreset = " + triggerreset + ".")
			viviz.triggerreset = triggerreset;
		}

		console.log('updatehash(): Called initial hash = ' + location.hash)
		if (!val) {
			var val = $(wrapper + " #" + el + " option:selected").val()
			console.log('updatehash(): Updating based on selected value of element ' + el + ' which is ' + val + '.');
			if (typeof(triggerreset) === "undefined") {
				console.log("updatehash(): triggerrest parameter not given. Setting viviz.triggerreset = false.")
				viviz.triggerreset = true
			}
		} else {
			val = "" + val;
			console.log("updatehash(): Updating based on passed parameter for element '" 
							+ el + "' to " + val);
			if (typeof(triggerreset) === "undefined") {
				console.log("updatehash(): triggerrest parameter not given. Setting viviz.triggerreset = false.")
				viviz.triggerreset = false
			}
		}

		if (val !== "") {
			if (el === 'regexp') {
				var def = VIVIZ["galleries"][galleryid]["defaultRegExp"]
			}
			if (el !== 'id') {
				console.log("updatehash(): Setting query string object element " + el + " to " + val);
				qs[el] = val
				if (def) {
					if (def === val) {
						console.log("updatehash(): Selected is equal to default " + el + ". Deleting from query object.")
						delete qs[el]	
					}
				} else {
					if ($($("#" + el + " option")[1]).val() === val) {
						console.log("updatehash(): No default " + el + " and select = second option.  Deleting from query object.")
						// If selected is not gallery id and is second option,
						// it is default.  Remove from hash.
						delete qs[el]
					}
				}
			}
			if (el === 'number') {
				if (VIVIZ["galleries"][galleryid]["defaultFirstImage"] === VIVIZ["config"]["defaultFirstImage"]) {
					if (parseInt(val) === VIVIZ["galleries"][galleryid]["defaultFirstImage"]) {
						delete qs[el]
					}
				}
			}

			var hash = ""
			if (el === 'id') {
				// Remove everything except for id, catalog, and mode
				var hash = ""
				if (qs["catalog"]) {
					hash = "catalog=" + qs["catalog"]
				}
				hash = hash + "&id=" + val
				if (qs["mode"]) {
					hash = hash + "&mode=" + qs["mode"]
				}
				hash = hash.replace(/^&/,"")
			} else {
				for (var key in qs) {
					hash = hash + "&" + key + "=" + qs[key]
				}
				hash = hash.substr(1)
			}
			console.log('updatehash(): Setting location.hash = ' + hash)
			location.hash = hash
		}
	}

	function setdropdowns(all) {

		console.log("dropdowns(): Setting dropdowns in " + wrapper + ".")

		var CATALOGS           = new Object()
		CATALOGS["Title"]      = "Catalogs"
		CATALOGS["Titleshort"] = "-Catalogs-"
		CATALOGS["Class"]      = "updatelglobal"
		CATALOGS["Values"]     = new Array()

		var k = 0;
		for (var key in VIVIZ["config"]["catalogs"]) {
			CATALOGS["Values"][k] = new Object()
			CATALOGS["Values"][k]["Title"] = key
			CATALOGS["Values"][k]["Value"] = key
			k = k + 1;
		}

		// Catalogs drop-down
		dropdown("catalog", CATALOGS, wrapper + " #dropdowns")
		$(wrapper + ' #dropdowns #catalog').unbind('change')
		$(wrapper + ' #dropdowns #catalog').change(function () {
			var catalogid = $(wrapper + " #catalog option:selected").val()
			console.log('setdropdowns(): Catalog id changed to ' + catalogid)
			viviz.triggerreset = true
			hash = "catalog=" + catalogid;
			if (qs["mode"]) {
				hash = hash + "&mode=" + qs["mode"]
			}
			location.hash = hash;
		})

		// Galleries drop-down
		dropdown("id", GALLERIES, wrapper + " #dropdowns")
		// Gallery drop-down bindings
		$(wrapper + ' #dropdowns #id').unbind('change')
		$(wrapper + ' #dropdowns #id').change(function () {
			var galleryid = $(wrapper + " #id option:selected").val()
			console.log('setdropdowns(): Gallery id changed to id = ' + galleryid)
			$(wrapper + " #error").html("")
			if (galleryid !== "") {
				console.log('setdropdowns(): Gallery changed.')
				updatehash('id')
			}
		})

		if (all == false) {
			// galleryid not found or error when generating file list.
			// Select gallery definition in gallery list drop-down and exit.
			console.log("setdropdowns(): Only setting gallery dropdown because of error.")
			console.log("setdropdowns(): Selecting defintion in gallery dropdown.")
			$(wrapper + " #dropdowns #id #def").attr('selected','selected')
			$(wrapper + ' #dropdownswrapper').show()
			$(wrapper + ' #dropdownswrapper select').hide()
			$(wrapper + ' #dropdownswrapper #dropdowns #id').show()
			return
		}

		// Select default gallery.
		$(wrapper + " #id option[value='" + galleryid + "']").attr('selected','selected')

		// Attributes drop-down
		console.log('setdropdowns(): Setting attributes drop-down.')

		dropdown("sortby", GALLERYINFO['attributes'], wrapper + " #dropdowns")
		$(wrapper + ' #dropdowns #sortby').unbind('change')
		$(wrapper + ' #dropdowns #sortby').change(function () {
			console.log('setdropdowns(): Sortby changed.')
			setregexps()
			updatehash('sortby')
		})

		// Order drop-down
		dropdown("order", GALLERYINFO['orders'], wrapper + " #dropdowns")
		$(wrapper + ' #dropdowns #order').unbind('change')
		$(wrapper + ' #dropdowns #order').change(function () {
			console.log('setdropdowns(): Order changed.')
			//viviz.triggerreset = false
			//resetdom()
			//gallery()
			updatehash('order')
		})

		setregexps()
		//setdownloads()

		function dropdown(ID, list, after){

			$(after + " #" + ID).remove()
			$(after).append(
				'<select id="' + ID + '" title="' + list.Title + '" class="' + (list.Class || "updatelocal") + '"></select>')
			for (var k = 0; k < list["Values"].length; k++) {
				VALUE = list["Values"][k]["Value"]
				TITLE = list["Values"][k]["Title"]
				if (k == 0) {
					$(after + ' #' + ID).append(
						'<option value="" class="def" id="def">' + list.Titleshort + '</option>')
					$(after + ' #' + ID).append(
						'<option value="' + VALUE + '" selected="true">' + TITLE + '</option>')
				}
				else {
					$(after + ' #' + ID).append(
						'<option value="' + VALUE + '">' + TITLE + '</option>')
				}
			}
			tooltip(ID);

			var qs = $.parseQueryString()
			if (qs[ID]) {
				console.log("setdropdowns.dropdown(): Setting selected value for " + ID + " to " + qs[ID])
				$(wrapper + " #" + ID + " option[value='" + qs[ID] + "']").attr('selected','selected')
			}
		}

		function setdownloads() {
			var REGEXPS            = new Object();
			REGEXPS["Title"]       = "Download options"
			REGEXPS["Titleshort"]  = "-Download-"
			REGEXPS["Values"]      = new Array()

			REGEXPS["Values"][0]          = new Object()
			REGEXPS["Values"][0]["Title"] = "File list"
			REGEXPS["Values"][0]["Value"] = "filelist"

			if (0) {
				REGEXPS["Values"][1]          = new Object()
				REGEXPS["Values"][1]["Title"] = "Zip file"
				REGEXPS["Values"][1]["Value"] = "zip"

				REGEXPS["Values"][2]          = new Object()
				REGEXPS["Values"][2]["Title"] = "Animated GIF"
				REGEXPS["Values"][2]["Value"] = "gif"

				REGEXPS["Values"][3]          = new Object()
				REGEXPS["Values"][3]["Title"] = "MP4"
				REGEXPS["Values"][3]["Value"] = "mp4"
			}

			dropdown("downloads", REGEXPS, wrapper + " #dropdowns")
			$(wrapper + " #downloads #def").attr('selected','selected')

			$(wrapper + ' #dropdowns #downloads').change(function () {
				// TODO: If full app is running, send file from server
				// with proper content-type instead of opening a window.
				$(wrapper + " #downloadlink").remove()
				var val = $(wrapper + " #downloads option:selected").val()
				if (val === "filelist") {
					var list = ""
					for (var i in INFOjs) {
						list = list + INFOjs[i]["FullFile"] + "\n"
					}
					var popup = window.open('', 'fullframe')
					// Clear content from previous selections.
					popup.document.getElementsByTagName('body')[0].innerHTML = ''
					popup.document.write('<html><head><title>File list</title>')
					popup.document.write('<link rel="icon" type="image/ico" href="css/favicon.ico"/>')
					popup.document.write('</head><body>')
					popup.document.write('<pre>'+list+'</pre>')
					popup.document.write('</body></html>')
				} else if (val !== "") {
					console.log('Not implemented.')
					//http://stackoverflow.com/questions/3975648/how-to-set-content-disposition-attachment-via-javascript
					$(wrapper + " #dropdowns").append('&nbsp;<a id="downloadlink" download href="'+INFOjs[0]["FullFile"]+'">&#11015;</a>')
				} else {
				}
				$(wrapper + " #downloads #def").attr('selected','selected')
			})
		}

		function setregexps() {

			var REGEXPS            = new Object();		
			var n                  = $(wrapper + " #dropdowns #sortby option:selected").index() || 1
			REGEXPS["Title"]       = "Show subset of images according to filter on attribute"
			REGEXPS["Titleshort"]  = "-Filters-"
			REGEXPS["Values"]      = new Array()

			n = n-1
			if (GALLERYINFO['attributes']["Values"][n]) {
				if (GALLERYINFO['attributes']["Values"][n]["Filters"]) {
					if (!(n == 0 && GALLERYINFO['attributes']["Values"][n]["Filters"].length == 1)) {
						for (i = 0; i < GALLERYINFO['attributes']["Values"][n]["Filters"].length; i++) {
							REGEXPS["Values"][i]          = new Object()
							REGEXPS["Values"][i]["Title"] = GALLERYINFO['attributes']["Values"][n]["Filters"][i]["Title"]
							REGEXPS["Values"][i]["Value"] = GALLERYINFO['attributes']["Values"][n]["Filters"][i]["Value"]
						}
						console.log("setdropdowns.setregexps(): Setting regexp filter dropdown.")
						dropdown("regexp", REGEXPS, wrapper + " #dropdowns")
					}
				} else {
					console.log("setdropdowns.setregexps(): No regexp filters.  Not displaying drop-down.")
					$(wrapper + " #regexp").remove()
				}
			}

			var qs = $.parseQueryString();
			if (VIVIZ["galleries"][galleryid]["defaultRegExp"] && !qs["regexp"]) {
				console.log("setdropdowns(): Setting regexp filter value based on gallery configuration.")
				$(wrapper + " #regexp").val(VIVIZ["galleries"][galleryid]["defaultRegExp"])
			}

			$(wrapper + ' #dropdowns #regexp').unbind('change')
			$(wrapper + ' #dropdowns #regexp').change(function () {
				//alert('here')
				//viviz.triggerreset = false;
				updatehash('regexp')
			})
		}
	}

	function setWH(el, type) {

		console.log("setWH(): Computing width and height of " 
			+ type + " images based on image size and options.")

		var ar = el.naturalWidth/el.naturalHeight

		// Compute pixels if given fractions.
		if (VIVIZ["galleries"][galleryid][type+"Width"]) {
			if (VIVIZ["galleries"][galleryid][type+"Width"] <= 1.0) {
				console.log('setWH(): Converting ' + type + 'Width to pixels.')
				VIVIZ["galleries"][galleryid][type+"Width"] = 
					el.naturalWidth*VIVIZ["galleries"][galleryid][type+"Width"]
			}
		}
		if (VIVIZ["galleries"][galleryid][type+"Height"]) {
			if (VIVIZ["galleries"][galleryid][type+"Height"] <= 1.0) {
				console.log('setWH(): Converting ' + type + 'Height to pixels.')
				VIVIZ["galleries"][galleryid][type+"Height"] = 
					el.naturalHeight*VIVIZ["galleries"][galleryid][type+"Height"]
			}
		}

		// Compute un-specified width or height.
		if (VIVIZ["galleries"][galleryid][type+"Width"] && !VIVIZ["galleries"][galleryid][type+"Height"]) {
			console.log('setWH(): ' + type + 'Width known but Height unknown.  Using aspect ratio to compute.')
			VIVIZ["galleries"][galleryid][type+"Height"] = VIVIZ["galleries"][galleryid][type+"Width"]/ar
		}
		if (VIVIZ["galleries"][galleryid][type+"Height"] && !VIVIZ["galleries"][galleryid][type+"Width"]) {
			console.log('setWH(): ' + type + 'Height known but Width unknown.  Using aspect ratio to compute.')
			VIVIZ["galleries"][galleryid][type+"Width"] = VIVIZ["galleries"][galleryid][type+"Height"]*ar
		}

		if (!VIVIZ["galleries"][galleryid][type+"Height"]) {
			console.log('setWH(): ' + type + 'Height unknown.  Using naturalHeight.')
			VIVIZ["galleries"][galleryid][type+"Height"] = el.naturalHeight
		}
		if (!VIVIZ["galleries"][galleryid][type+"Width"]) {
			console.log('setWH(): ' + type + 'Width unknown.  Using naturalWidth.')
			VIVIZ["galleries"][galleryid][type+"Width"] = el.naturalWidth
		}

		VIVIZ["galleries"][galleryid][type+"NaturalHeight"] = el.naturalHeight
		VIVIZ["galleries"][galleryid][type+"NaturalWidth"] = el.naturalWidth

		return true
	}

	function thumblist() {

		console.log("thumblist(): Called.")

		var galleryid = $(wrapper + " #id").val()
		var SORTBY    = $(wrapper + " #sortby").val()
		var ORDER     = $(wrapper + " #order").val()
		var regexp    = $(wrapper + " #regexp :selected").attr('value')

		var SORTBYS  = GALLERYINFO['attributes']
		var ORDERS   = GALLERYINFO['orders']

		//http://stackoverflow.com/a/2450976
		function shuffle(array) {
		  var currentIndex = array.length, temporaryValue, randomIndex;

		  // While there remain elements to shuffle...
		  while (0 !== currentIndex) {

			// Pick a remaining element...
			randomIndex = Math.floor(Math.random() * currentIndex);
			currentIndex -= 1;

			// And swap it with the current element.
			temporaryValue = array[currentIndex];
			array[currentIndex] = array[randomIndex];
			array[randomIndex] = temporaryValue;
		  }

		  return array;
		}
		// http://keithdevens.com/weblog/archive/2007/Jun/07/javascript.clone
		function clone(obj){       
			if (obj == null || typeof(obj) != 'object') 
				return obj;
			
			var temp = new obj.constructor(); // changed (twice)
			for (var key in obj) 
				temp[key] = clone(obj[key]);
			
			return temp;
		}

		// Test decoding of of first file only.
		var msg = testdecode(GALLERYINFO["fullfiles"][0][0])
		if (msg !== "") {error(msg, true); return;}
		var msg = testdecode(GALLERYINFO["thumbfiles"][0][0])
		if (msg !== "") {error(msg, true); return;}

		var INFOjs = new Array();
		for (j = 0; j < GALLERYINFO["fullfiles"].length; j++) {
			INFOjs[j] = new Object();
			INFOjs[j]["FullFile"]  = decodeURIComponent(GALLERYINFO["fullfiles"][j][0]);
			INFOjs[j]["ThumbFile"] = decodeURIComponent(GALLERYINFO["thumbfiles"][j][0]);

			// This is a confusing way to do things.
			if (Object.keys(SORTBYS).length > 0) {
				for (z = 0;z < SORTBYS["Values"].length;z++) {
					INFOjs[j][SORTBYS["Values"][z]["Value"]] = GALLERYINFO["fullfiles"][j][z];
				}
			}
			INFOjs[j]["ImageNumber"] = j;
		}

		state = galleryid+SORTBY+ORDER+regexp;
		if (typeof(thumblist.cache) != 'object') {
			thumblist.cache = new Object();
		}
		if ( thumblist.cache[state] ) {
			console.log('thumblist(): Using cached thumblist.');
			return thumblist.cache[state];
		} 			

		I = new Array();
		if (regexp) {
			var REGEXP = new RegExp(regexp);
			if (typeof(INFOjs[0][SORTBY]) == "string") {
				var k = 0;
				for (var i = 0; i < INFOjs.length; i++) {
					if (INFOjs[i][SORTBY].match(REGEXP)) {
						I[i] = k;
						k = k+1;
					}
				}
				console.log("thumblist(): Regexp " + REGEXP + " removed " + (INFOjs.length-k) + "/" + INFOjs.length + " images in subset.");
			} else {
				regexp = regexp.replace('gt','>').replace('ge','<=').replace('lt','<').replace('le','<=');
				regexp = regexp.replace('and','&').replace('&amp;','&');
				regexp = regexp.replace('&lt;','<');
				regexp = regexp.replace('&gt;','>');
				var k = 0;
				for (var i = 0; i < INFOjs.length; i++) {
					var test = regexp.replace(/this/g, INFOjs[i][SORTBY]);
					if (eval(test)) {
						I[i] = k;
						k = k+1;
					}
				}
			}
			if (I.length > 0) {
				var INFOr = new Array();
				for (i = 0; i < I.length; i++) {
					INFOr[I[i]] = INFOjs[i];
				}
				var INFOrs = clone(INFOr);
			} else {
				return [];
			}
		} else {
			var INFOrs = clone(INFOjs)
		}

		if (ORDER.match("ascending")) {
			//console.log('thumblist.js: Sorting by attribute ' + SORTBY + " in ascending order.");			
			if (typeof(INFOrs[0][SORTBY]) == "string") {
				//console.log('thumblist.js: Sorting attribute ' + SORTBY + " as string.");
				INFOrs.sort(function(a,b) {
					return a[SORTBY].localeCompare(b[SORTBY]);
				});
			} else {
				//console.log('thumblist.js: Sorting attribute ' + SORTBY + " as number.");
				INFOrs.sort(function(a, b){
					return a[SORTBY] - b[SORTBY];
				});
			}
		}

		if (ORDER.match("descending")){
			//console.log('thumblist.js: Sorting by attribute ' + SORTBY + " in descending order.")
			if (typeof(INFOrs[0][SORTBY]) == "string") {
				//console.log('thumblist.js: Sorting attribute ' + SORTBY + " as string.")
				INFOrs.sort(function(a,b) {
					return b[SORTBY].localeCompare(a[SORTBY])
				});
			} else {
				//console.log('thumblist.js: Sorting attribute ' + SORTBY + " as number.")
				INFOrs.sort(function(a,b){
					return b[SORTBY] - a[SORTBY]
				})
			}
			//console.log('thumblist.js: First image is now ' + INFOrs[0])
		}
		if (ORDER.match("random")) {
			//console.log('thumblist.js: Sorting by attribute ' + SORTBY + " in random order.")
			INFOrs = shuffle(INFOrs);
		}

		if ((!ORDER.match("random")) & (typeof(thumblist.cache[state]) != 'object')) {
			thumblist.cache[state] = new Object();
			thumblist.cache[state] = INFOrs;
		}

		var qs = $.parseQueryString();
		if (parseInt(qs["number"]) > INFOrs.length) {
			warning("Number of images in subset < number in query string.  Resetting number to 1.", true, Infinity);
			VIVIZ["galleries"][galleryid]["defaultFirstImage"] = 1;
			updatehash("number",1)
		}
		return INFOrs
	}

	function gallery() {

		$('button').each(function () {tooltip($(this).attr('id'))})

		$("#thumb" + gallerynumber).parent().hide()
		$("#gallery" + gallerynumber).parent().show()

		setthumbs()

		// Actions to take when a thumbnail is clicked.
		function setthumbbindings() {

			console.log("gallery.setthumbbindings(): Called.")

			var nowvisible = parseInt($(wrapper).attr('nowvisible'));
			var lastvisible = parseInt($(wrapper).attr('lastvisible'));

			if (isNaN(nowvisible)) {
				console.log("gallery.setthumbbindings(): nowvisible is NaN. Setting nowvisible attribute on " + wrapper + " to 1.");
				nowvisible = 1;
				$(wrapper).attr('nowvisible', '1');
			} else {
				nowvisible = $(this).attr('id');
				console.log("gallery.setthumbbindings(): Setting nowvisible attribute on " + wrapper + " to " + nowvisible + ".");
				$(wrapper).attr('nowvisible', nowvisible);
			}
			if (isNaN(lastvisible)) {
				console.log("gallery.setthumbbindings(): lastvisible is NaN. Setting nowvisible attribute on " + wrapper + " to 1.");
				lastvisible = 1;
				$(wrapper).attr('lastvisible', '1');
			}

			console.log("gallery.setthumbbindings():"
				+ " Setting class on thumb #" + lastvisible + " to inactive.");
			$(wrapper + " #gallerythumbframe #" + lastvisible)
					.removeClass('active').addClass('inactive');

			console.log("gallery.setthumbbindings():"
				+ " Setting class on thumb #" + nowvisible + " to active.");
			$(wrapper + " #gallerythumbframe #" + nowvisible)
					.removeClass('inactive').addClass('active');
			
			console.log("gallery.setthumbbindings(): Setting stat string.");
			INFOjs = thumblist(); 
			var statstr = "| #" + (nowvisible) 
								+ "/" + (INFOjs.length) + " for filter";
			statstr = statstr + " | #" 
							  + (1+INFOjs[nowvisible-1].ImageNumber)
							  + "/" + $(wrapper).attr('totalingallery')
							  + " in gallery | ";
			
			for (var z = 1;z < GALLERYINFO['attributes']["Values"].length;z++) {
				statstr = statstr 
							+ GALLERYINFO['attributes']["Values"][z].Title 
							+ " = ";

				var key = GALLERYINFO['attributes']["Values"][z].Value
				if (GALLERYINFO['attributes']["Values"][z].Format) {
					statstr = statstr + sprintf(GALLERYINFO['attributes']["Values"][z].Format, parseFloat(INFOjs[nowvisible-1][GALLERYINFO['attributes']["Values"][z].Value]));
				} else {
					statstr = statstr + INFOjs[nowvisible-1][key];
				}
				if (GALLERYINFO['attributes']["Values"][z].Unit) {
					statstr = statstr 
								+ " [" 
								+ GALLERYINFO['attributes']["Values"][z].Unit 
								+ "] " 
								+  " | ";
				} else {
					statstr = statstr + " | ";
				}
			}
			$(wrapper + ' #attributes').html(statstr);

			var qs = $.parseQueryString()
			console.log("gallery.sethumbbindings(): Calling updatehash('number',"+ nowvisible + ").")
			updatehash('number', nowvisible);

			//$(wrapper + " #fullframe img[id=" + lastvisible + "]").css("opacity","0.4");
			console.log("gallery.sethumbbindings(): Hiding full image #" + lastvisible + ".");
			$(wrapper + " #fullframe img[id=" + lastvisible + "]").hide();

			// Load full image.
			console.log("gallery.sethumbbindings(): Calling loadfull.");
			loadfull($(this).attr('id')); 

			// Update lastvisible attribute on wrapper.
			console.log("gallery.sethumbbindings(): Setting lastvisible attribute on " + wrapper + " to " + nowvisible + ".");
			$(wrapper).attr("lastvisible", nowvisible);

			// Scroll thumbnail list
			console.log("gallery.sethumbbindings(): Scrolling #gallerythumbframe to #" + nowvisible + ".");
			$(wrapper + " #gallerythumbframe").scrollTo(this, 0, {
			   duration: 0, offset: 0
			});
		}

		function setthumbs() {

			console.log('gallery.setthumbs(): Called.');
			
			var INFOjs = thumblist()

			// Set attributes used by lazy loader
			$(wrapper).attr('totalvisible', INFOjs.length)
			$(wrapper).attr('totalingallery',GALLERYINFO["totalingallery"])

			var thumbframe = $(wrapper + ' #gallerythumbframe')
			
			// Clear any previous scroll binding.  (Lazy load uses this.)
			thumbframe.unbind('scroll')

			if (INFOjs.length == 0) {
				$(wrapper + ' #attributes').html('No images in subset.')
				return
			}
		
			firstimage(VIVIZ["galleries"][galleryid]["defaultFirstImage"]);

			// TODO: (?) Detect bad images:
			// https://github.com/desandro/imagesloaded
			// http://stackoverflow.com/questions/821516/browser-independent-way-to-detect-when-image-has-been-loaded
			// http://stackoverflow.com/questions/3877027/jquery-callback-on-image-load-even-when-the-image-is-cached

			// Find first valid thumbnail
			function firstimage(f) {

				console.log("gallery.firstimage(): Called."
								+ " Setting thumb #" + (f) + " into DOM.");

				if (f == VIVIZ["galleries"][galleryid]["defaultFirstImage"]) {
					setcontrolbindings();
				}

				$('<img class="gallerythumbbrowse firstimage"/>')
					.appendTo($(wrapper + ' #gallerythumbframe'))
					.attr("id",f)
					.attr("src", VIVIZ["galleries"][galleryid]["thumbdirdecoded"] 
									+ INFOjs[f-1].ThumbFile)
					.error(function () {
						// First image is bad.
						console.log("gallery.firstimage.error(): Error event when setting thumb image " + (f) + " is bad.");
						$(this).addClass("error")
						warning("Thumbnail image " + (f) + " could not be loaded.", true, 1000);

						// This triggers .load
						$(this).attr("src","css/transparent.png");

						// Need to do this here and in .load in case error
						// event is triggered after .load event of first non-
						// error image.
						console.log("gallery.firstimage.error(): Setting dimensions on image to " + VIVIZ["galleries"][galleryid]["thumbWidth"] + "x" + VIVIZ["galleries"][galleryid]["thumbHeight"] + ".");
						$(this).css("height", VIVIZ["galleries"][galleryid]["thumbHeight"]);
						$(this).css("width", VIVIZ["galleries"][galleryid]["thumbWidth"]);

						//$(this).remove();
						if (f == INFOjs.length) {
							warning("No images could be loaded.", true, Infinity)
							console.log("No images could be loaded.")
							$(wrapper + " #workingfullframe").css('visibility','hidden')
							if ($(wrapper + " #fullframe").width() > 0)
								$(wrapper + " #fullframe").width('')
							if ($(wrapper + " #fullframe").height() > 0)
								$(wrapper + " #fullframe").height('')
							return
						}
						firstimage(f+1)
					})
					.load(function () {
						
						if ($(this).hasClass('error')) return;
						//if (f > VIVIZ["config"]["defaultFirstImage"]) {
							if (f == VIVIZ["galleries"][galleryid]["defaultFirstImage"]+1) {
								if (VIVIZ["galleries"][galleryid]["defaultFirstImage"] > 1) {
									warning("The selected thumbnail image in this subset could not be loaded.", true, 10000)
								} else {
									warning("The first thumbnail image in this subset could not be loaded.", true, 10000)
								}
							} else {
								//warning("The first " + (VIVIZ["config"]["defaultFirstImage"]-f+1) + " images" + " in this subset could not be loaded.",true)
							}
						//}
						
						// Trigger load of the first full image.
						$(wrapper).attr('nowvisible', f)
						console.log("gallery.firstimage.load(): First successful thumbnail image load.")
						console.log("gallery.firstimage.load(): Applying click bindings and then clicking it to trigger load of full image.")
						$(this).bind('click', setthumbbindings).click()

						// Scroll to top.
						$(wrapper + " #gallerythumbframe").scrollTo(0);

						console.log('gallery.firstimage.load(): First thumbnail has natural dimensions = '
							+this.naturalWidth+'x'+this.naturalHeight+'.');

						// Set height of thumbnail image - setWH()
						// Modifies VIVIZ["galleries"][galleryid]
						var tmp = setWH(this, 'thumb');
						$(this).css("height",VIVIZ["galleries"][galleryid]["thumbHeight"]);
						$(this).css("width",VIVIZ["galleries"][galleryid]["thumbWidth"]);

						//setTimeout(function () {
							var l = $(wrapper + ' #gallerythumbframe img.error').length;
							console.log("gallery.firstimage.load(): Setting dimensions on " + (l) + " images with class error to " + VIVIZ["galleries"][galleryid]["thumbWidth"] + "x" + VIVIZ["galleries"][galleryid]["thumbHeight"] + ".");
							$(wrapper + ' #gallerythumbframe img.error').css("height",VIVIZ["galleries"][galleryid]["thumbHeight"]);
							$(wrapper + ' #gallerythumbframe img.error').css("width",VIVIZ["galleries"][galleryid]["thumbWidth"]);
						//}, 0);

						if (VIVIZ["galleries"][galleryid]["defaultFirstImage"] > 1) {
							console.log("gallery.firstimage.load(): First image to show > 1.  Inserting spacers before first image.");

							for (var i = 1; i < VIVIZ["galleries"][galleryid]["defaultFirstImage"]; i++) {
								$('<img class="spacer"/>')
									.prependTo($(wrapper + ' #gallerythumbframe'))
									.attr("src", "css/transparent.png")
									.css("height",VIVIZ["galleries"][galleryid]["thumbHeight"])
									.css("width",VIVIZ["galleries"][galleryid]["thumbWidth"])
							}
						}

						console.log('gallery.firstimage.load(): First thumbnail set to '
								+ 'have dimensions = '
								+ VIVIZ["galleries"][galleryid]["thumbWidth"]
								+ 'x'
								+ VIVIZ["galleries"][galleryid]["thumbHeight"]
								+ '.');

						$(wrapper + ' #gallerythumbframe').attr('data-thumb-length', INFOjs.length);

						// Set attribute that indicates which thumbnail is active.
						$(wrapper + ' #gallerythumbframe').attr('data-thumb-displayed', f);
						
						setscrollbinding();

						// Lazy Load images.
						var maxLength = INFOjs.length;
						var max = VIVIZ["galleries"][galleryid]["lazyLoadMax"]
								 || VIVIZ["config"]["lazyLoadMax"]
						if (INFOjs.length > max) {
							maxLength = max;
						}
						if (maxLength + f > INFOjs.length) {
							maxLength = INFOjs.length-f;
						}

						loadmore("both");
					})   
			}
		}

		function settabledims(el,callback) {

			console.log("gallery.settabledims(): Called.")

			// http://stackoverflow.com/questions/986937/how-can-i-get-the-browsers-scrollbar-sizes
			$.scrollbarWidth=function(){var a,b,c;if(c===undefined){a=$('<div style="width:50px;height:50px;overflow:auto"><div/></div>').appendTo('body');b=a.children();c=b.innerWidth()-b.height(99).innerWidth();a.remove()}return c};

			if (el) {
				// Don't get border-width by querying DOM for first thumbnail, because it may not be in 
				// DOM already.  Instead, get it from function parameter.
				var bw = 2*parseFloat($(el).css('border-width').replace("px",''));
				if (isNaN(bw)) {
					bw = $(wrapper + ' #gallerythumbframe img:first')
							.outerWidth() - VIVIZ["galleries"][galleryid]["thumbWidth"];
				}
				if  (isNaN(bw)) {
					bw = 2;
				}
				var w = VIVIZ["galleries"][galleryid]["thumbWidth"] 
							+ $.scrollbarWidth() + bw + 8; // Why 8?
				console.log("gallery.settabledims(): Setting #gallerythumbframe "
					+ "width to = " + w + ".");
				$(wrapper + ' #gallerythumbframe').width(w);
			}

			console.log("gallery.settabledims(): Full img natural dimensions = " 
				+ VIVIZ["galleries"][galleryid]["fullNaturalWidth"] 
				+ "x" 
				+ VIVIZ["galleries"][galleryid]["fullNaturalHeight"])
			console.log("gallery.settabledims(): Full img scaled dimensions  = " 
				+ VIVIZ["galleries"][galleryid]["fullWidth"] 
				+ "x" 
				+ VIVIZ["galleries"][galleryid]["fullHeight"])
			
			// Set heights of thumbframe and fullframe. When first image is loaded, fullNaturalHeight is set.
			if (VIVIZ["galleries"][galleryid]["fullHeight"] > 0) {
				
				// Aspect ratio;
				var ar = VIVIZ["galleries"][galleryid]["fullWidth"]/VIVIZ["galleries"][galleryid]["fullHeight"];
				console.log("gallery.settabledims(): Full image aspect ratio = " + ar + ".");

				// Force outer frame to stay the same size after image is
				// removed and before new image is inserted.
				//$(wrapper + " #fullframe").width($(wrapper + " #fullframe").width())
				
				// Set height of thumb strip to be full height of image.
				$(wrapper + ' #gallerythumbframe')
					.height(VIVIZ["galleries"][galleryid]["fullHeight"]);

				// For iframe?
				//enclosure = $(wrapper).parents().filter('body')[0];
				enclosure = "body";

				console.log("gallery.settabledims(): Window dimensions: " 
					+ $(window).width() + "x" + $(window).height())
				console.log("gallery.settabledims(): Client dimensions: " 
					+ document.documentElement.clientWidth 
					+ "x"
					+ document.documentElement.clientHeight + ".");
				console.log("gallery.settabledims(): Document dimensions: "
					+  $(document).width() + "x" + $(document).height())
				console.log("gallery.settabledims(): Body element dimensions: " 
					+ $(enclosure).width() + "x" + $(enclosure).height() + ".")

				// Amount height needs to shrink so that no scrollbar appears.
				dh = $(enclosure).height() - $(window).height();

				if (dh > 0) {
					console.log("gallery.settabledims(): Amount full image "
						+ "height needs to decrease so that no scrollbar appears: dh = "+dh);
					console.log("gallery.settabledims(): Reducing height "
						+ "and width of #fullframe img.")
					var newh = VIVIZ["galleries"][galleryid]["fullHeight"]-dh
					$(wrapper + ' #fullframe img').height(newh)
					$(wrapper + ' #fullframe img').width(newh*ar)
					console.log("gallery.settabledims(): Shrinking height "
						+ "of #gallerythumbframe to "+(VIVIZ["galleries"][galleryid]["fullHeight"]-dh + "."));
					$(wrapper + ' #gallerythumbframe').height(newh);
					VIVIZ["galleries"][galleryid]['fullHeight'] = newh;
					VIVIZ["galleries"][galleryid]['fullWidth']  = newh*ar
				} else {
					console.log("gallery.settabledims(): Full image does not "
						+ " need to be reduced in height to prevent vertical scrollbar.")
					console.log("gallery.settabledims(): Setting " 
						+ "#gallerythumbframe height to be height of full "
						+ "image = " + VIVIZ["galleries"][galleryid]["fullHeight"] + ".");
					$(wrapper + " #gallerythumbframe")
						.height(VIVIZ["galleries"][galleryid]["fullHeight"]);
				}

				console.log("gallery.settabledims(): Window dimensions: " 
					+ $(window).width() + "x" + $(window).height())
				console.log("gallery.settabledims(): Client dimensions: " 
					+ document.documentElement.clientWidth 
					+ "x" 
					+ document.documentElement.clientHeight)
				console.log("gallery.settabledims(): Document dimensions: "
					+  $(document).width() + "x" + $(document).height())
				console.log("gallery.settabledims(): Enclosing Body dimensions: " 
					+ $(enclosure).width() + "x" + $(enclosure).height())

				dw = $(document).width()-$(enclosure).width();

				if (dw > 0) {
					console.log("gallery.settabledims(): Document width is larger than body element width by dw = " + dw + ".");
					if (dh > 0) {
						newh = VIVIZ["galleries"][galleryid]["fullNaturalHeight"] - dh - dw/ar;
					} else {
						newh = VIVIZ["galleries"][galleryid]["fullNaturalHeight"]- dw/ar;
					}
					newh = newh - 1;
					console.log("gallery.settabledims(): Shrinking height of #fullframe img and #gallerythumbframe because dw > 0.  New height: " + newh + ".");
					$(wrapper + ' #fullframe img').height(newh)
					$(wrapper + ' #gallerythumbframe').height(newh);
					$(wrapper + ' #fullframe img').width(newh*ar)
					VIVIZ["galleries"][galleryid]['fullHeight'] = newh;
					VIVIZ["galleries"][galleryid]['fullWidth'] = newh*ar;
				} 


				dh = $(enclosure).height() - $(window).height() - parseInt($(wrapper).css('margin-top'))
				if (dh < 0) {
					console.log("gallery.settabledims(): Setting top margin to "
									+ (-dh/2) + ".");
					$(wrapper).css('margin-top', -dh/2);
				}	
			} else {
				console.log("gallery.settabledims(): Full image height unknown "
					+ " but thumb height known.");
				var a = 4*VIVIZ["galleries"][galleryid]["thumbHeight"];
				console.log("gallery.settabledims(): Setting thumb frame height "
					+ " to be 4*(first thumb outer height) = " + a + ".");
				console.log("gallery.settabledims(): First thumbnail height = " 
					+ $('#gallerythumbframe img').eq(0).height());
				$(wrapper + ' #gallerythumbframe').height("" + a);
			}

			if (VIVIZ["galleries"][galleryid]["play"] || VIVIZ["play"]) {
				$(wrapper + " #play").click()
			}

			if (callback) {
				callback();
			}
		}

		function loadfull(id) {

			id = parseInt(id);
			console.log("gallery.loadfull(): Called with image object with id = "
							 + id + ".");

			if (id > INFOjs.length) {return}
			
			if ($(wrapper + " #fullframe img[id="+id+"]").length == 1) {
				console.log("gallery.loadfull(): "
							+ "Found hidden full image in DOM.  Showing.");
				$(wrapper + " #fullframe img[id=" + id + "]").show();
				prepnext(id)
				setfilename(id)
				return;
			}

			// Show loading indicator
			console.log("gallery.loadfull(): Showing loading indicator.")
			$(wrapper + ' #workingfullframe').css('visibility','visible');

			// Place empty image element in DOM.
			console.log("gallery.loadfull(): Placing empty img element with id = "
						+ id + " in DOM.");
			$(wrapper + " #fullframe").prepend('<img id="' +id +'" class="full"/>');

			console.log("gallery.loadfull(): Setting attributes and binding"
							+ " load event on # " + id + ".");			
			$(wrapper + " #fullframe img[id="+id+"]")
					.unbind('load')
					.error(function () {
						$(wrapper + ' #workingfullframe').css('visibility','hidden');
						console.log("-- gallery.loadfull(): Error "
							+ "loading full image #" + id + ".");
						$(this).attr("src","css/transparent.png")
						$(this).addClass("class","error")
						warning("The full image for this thumbnail could "
							+ "not be loaded.", true)
						// Above set will trigger load event so following not needed.
						//$(this).trigger('load')
					})
					.css("height", VIVIZ["galleries"][galleryid]["fullHeight"] || 400)
					.css('width', VIVIZ["galleries"][galleryid]['fullWidth'] || 400)
					.attr('src', VIVIZ["galleries"][galleryid]["fulldirdecoded"] 
								+ INFOjs[parseInt(id)-1]["FullFile"])
					.load(function() {

						console.log("gallery.loadfull(): Load event for full image #" + id + ".");
						
						// Hide loading indicator
						console.log("gallery.loadfull(): Hiding loading indicator.");
						$(wrapper + ' #workingfullframe').css('visibility', 'hidden');

						// Undo width and height set when dom is reset.
						if ($(wrapper + " #fullframe").width() > 0)
							$(wrapper + " #fullframe").width('')
						if ($(wrapper + " #fullframe").height() > 0)
							$(wrapper + " #fullframe").height('')

						if ($("#"+id).hasClass('firstimage')) {

							console.log("gallery.loadfull(): "
								+ "First full image load event. Full image has dimensions "
								+ this.naturalWidth 
								+ "x" 
								+ this.naturalHeight
								+ ".  Setting table dimensions.");

							$(wrapper + " #fullframe").height('');

							var tmp = setWH(this, 'full');

							// Set height of full image.
							console.log("gallery.loadfull(): "
									+ "Setting full image height on #" + id + ".");
							$(this).css("height",
									VIVIZ["galleries"][galleryid]["fullHeight"]);
							$(this).css('width',
									VIVIZ["galleries"][galleryid]['fullWidth'])

							// After this function sets VIVIZ[galleryid] dimensions, 
							// then call prepnext(), which uses these dimensions.
							console.log("gallery.loadfull(): Calling "
								+ "settabledims() with callback prepnext(" + id + ").");
							settabledims(this, function () {prepnext(id)})
						} else {
							prepnext(id)
						}

						console.log("gallery.loadfull(): Calling setfilename(" + id + ").");
						setfilename(id)

					})

			function prepnext(id) {

				// If next few images not in DOM, load them.
				
				console.log("gallery.loadfull.prepnext(): Called with id = " + id + ".")

				var idn = parseInt(id) + 1
				
				if (idn > INFOjs.length) {return}

				var ido = idn
				var Nlazy = VIVIZ["galleries"][galleryid]["lazyLoadMax"]
							|| VIVIZ["config"]["lazyLoadMax"] || 3
				// Always have next Nlazy full images set in DOM.
				// TODO: If play button hit, start loading more.
				while (idn < ido + Nlazy) {
					if (idn > INFOjs.length) {break}					
					if ($(wrapper + " #fullframe img[id="+idn+"]").length == 0) {
						console.log("gallery.loadfull.prepnext(): Setting full image with id = " + idn + ".");
						$(wrapper + " #fullframe").prepend('<img id="'+idn+'" class="full" style="display:none"/>');
						$(wrapper + " #fullframe img[id="+idn+"]")
							.css('height',VIVIZ["galleries"][galleryid]['fullHeight'])
							.css('width',VIVIZ["galleries"][galleryid]['fullWidth'])
							.attr('src',VIVIZ["galleries"][galleryid]["fulldirdecoded"] + INFOjs[idn-1]["FullFile"])
							.error(function () {
								$(this).attr("src", "css/transparent.png")
								$(this).attr("class","error")
								$(this).height(VIVIZ["galleries"][galleryid]["fullHeight"]);
								$(this).width(VIVIZ["galleries"][galleryid]["fullWidth"]);
							})
							.load(function () {
								console.log("gallery.loadfull.prepnext(): Full image #" + $(this).attr('id') + " load event.")
								if ($(wrapper + " #fullframe img[id="+(parseInt($(this).attr('id'))-1)+"]").hasClass("error")) {
									console.log("gallery.loadfull.prepnext(): Previous full image did not load.  Setting full image dimensions and setting table dimensions.")
									var tmp = setWH(this, 'full');

									// Set height of full image.
									console.log("gallery.loadfull.prepnext(): Setting full image height on #" + id + ".");
									$(this).css("height",VIVIZ["galleries"][galleryid]["fullHeight"]);
									$(this).css('width',VIVIZ["galleries"][galleryid]['fullWidth'])

									// After this function sets VIVIZ[galleryid] dimensions, 
									// then call prepnext(), which uses these dimensions.
									console.log("gallery.loadfull(): Calling settabledims() with callback prepnext(" + id + ").");
									settabledims(this, function () {
										console.log("gallery.loadfull(): Calling setfilename(" + id + ").");
										setfilename(id)
									});

								}
							})
					}
					idn = idn+1
				}
			}

			function setfilename(id) {
				console.log("gallery.loadfull.setfilename(): Called.");
				$(wrapper + " #filename").html('');
				var wo = $(wrapper).width()

				$(wrapper + " #filename").append("<a>");
				var href = VIVIZ["galleries"][galleryid]["fulldirdecoded"] 
							+ INFOjs[parseInt(id-1)]["FullFile"];
				var fname = INFOjs[parseInt(id-1)]["FullFile"];
				if (fname.match("&")) {
					// URL is not a file but a URL with query parameters.
					fname = href;
				}
				
				$(wrapper + " #filename a")
					.attr('href', href)
					.css("white-space", "nowrap")
					.html(fname);

				var wx = $(wrapper + " #filename").width();

				while (wx > wo) {

					console.log("gallery.loadfull.setfilename(): "
									+ wrapper + " width "+wo)
					console.log("gallery.loadfull.setfilename(): "
									+ "#filename div width "+wx)

					// Fraction to remove. 0.9 is to account for nonuniformity
					// of charcter width.
					r = 0.9*wo/wx
					console.log("gallery.loadfull.setfilename(): " 
								+ "Reduction factor: 0.9*" + wo + "/" + wx)
					l = fname.length
					nr = l-r*l
					console.log("gallery.loadfull.setfilename(): "
								+ "Number of characters to remove: " + nr)
					c = l/2
					console.log("gallery.loadfull.setfilename(): Center value: " + c)
					console.log("gallery.loadfull.setfilename(): "
							+ "Number of characters to keep: " + nr)
					fnamer = fname.substr(0,Math.floor(c-nr/2)) 
								+ " ... " 
								+ fname.substr(Math.ceil(c+nr/2),l)
					$(wrapper + " #filename a").text(fnamer);
					wx = $(wrapper + " #filename").width();
				}
			}
		}

		function loadmore(direction, Nshown, scrollEvent) {

			var Navail = parseInt($(wrapper + ' #gallerythumbframe').attr('data-thumb-length'));
			Nshown = Nshown || parseInt($(wrapper + " #gallerythumbframe > img.active").attr("id"));

			var Nlazy = VIVIZ["galleries"][galleryid]["lazyLoadMax"]
						|| VIVIZ["config"]["lazyLoadMax"]
			
			var firstidx = parseInt(VIVIZ["galleries"][galleryid]["defaultFirstImage"])-1;
			Nbefore = 0;
			if (firstidx > 0) {
				Nbefore = Nlazy;
			}

			// Number of blocks of Nlazy images to fill document height.
			var d = Math.max(Nlazy, Nshown)*VIVIZ["galleries"][galleryid]["thumbHeight"];
			var Nfill = $(window).height()/(d)

			// If Nfill > 1, we need to load more images initially
			// to trigger appearance of scroll bar.
			if (Nfill > 1) {
				Nlazy = Math.ceil(Nfill*Nlazy)
			}

			var tic = new Date().getTime()
			var slowwarn = false
			var imgstr = '<img class="gallerythumbbrowse lazyload"/>';

			if (direction === "both" || direction === "forward") {
				for (var j = Nshown + 1; j < Nshown + Nlazy; j++) {
					if ($("#gallerythumbframe img[id='" + (j) + "']").length > 0) {
						console.log("gallery.loadmore(): Found thumb with id = " 
										+ (j) + " in DOM.  Not appending.");
						continue;
					}
					if (j == INFOjs.length + 1) break;
					var last = $("#gallerythumbframe img").last();
					var bottom = parseInt(last.attr('id'));
					console.log("gallery.loadmore(): Bottom image is #" 
									+ bottom 
									+ ". Inserting thumb #" 
									+ bottom 
									+ " after #" + (j) + ".");
					var el = $(imgstr)
								.css("height",
									$("#gallerythumbframe > img.active").height())
								.css("width",
									$("#gallerythumbframe > img.active").width())
								.css("background-image", "url(css/ajax-loader-slow.gif")
								.css("background-repeat", "no-repeat")
								.css("background-size","100%")
								.css("background-position","center")
								.insertAfter(last);
					setel(el,j);
				}
			}

			if (direction === "both" || direction === "backward") {
				for (var j = Nshown-1; j > Nshown-Nlazy-2; j--) {
					if (j < 1) continue;
					if ($("#gallerythumbframe img[id='" + (j) + "']").length > 0) {
						console.log("gallery.loadmore(): Found thumb with id = " 
										+ (j) + " in DOM.  Not prepending.");
						continue;
					}
					var first = $("#gallerythumbframe img").not(".spacer").first();
					var top = parseInt(first.attr('id'));
					console.log("gallery.loadmore(): Top non-spacer image is #" + top 
						+ ". Inserting thumb #" + (j) + " before #" + top + ".");
					var lastspacer = $("#gallerythumbframe .spacer").last();
					//var el = $(imgstr)
					var el = $(lastspacer)
								.removeClass("spacer")
								.css("height",
									$("#gallerythumbframe > img.active").height())
								.css("width",
									$("#gallerythumbframe > img.active").width())
								.css("background-image", "url(css/ajax-loader-slow.gif")
								.css("background-repeat", "no-repeat")
								.css("background-size","100%")
								.css("background-position","center")
					setel(el,j);
				}
			}

			function setel(el,j) {
				$(el)
					.attr("id",j)
					.addClass("gallerythumbbrowse")
					.addClass("lazyload")
					.attr("src", VIVIZ["galleries"][galleryid]["thumbdirdecoded"] 
									+ INFOjs[j-1].ThumbFile)
					.bind('click',setthumbbindings)
					.attr("title",imgtitle(INFOjs[j-1]))
					.error(function () {
						$(this).addClass("error")
						$(this).attr("src","css/transparent.png")
						$(this).css("background-image", "")
					})
					.load(function () {
						var active = $(wrapper + " #gallerythumbframe img.active");
						$(this).css("background-image", "")
						if (!scrollEvent) {
							$(wrapper + " #gallerythumbframe")
								.scrollTo(active, 0, {
									duration: 80, offset: 0
								});
						}
						if ((slowwarn == false) && (new Date().getTime() - tic > 3000)) {
							slowwarn = true;
						}													
					})
			}
		}

		function imgtitle(obj) {
			//http://stackoverflow.com/questions/5612787/converting-javascript-object-to-string
			var str = '';
			var k = 0;
			for (var p in obj) {
				if (obj.hasOwnProperty(p)) {
					if (isNaN(parseInt(p)))
						str += p + ':' + obj[p] + '\n';
					}
					k = k+1;
				}
				return str;
		}

		function setcontrolbindings() {

			var si = false;
			
			// Show/Hide thumb button
			$(wrapper + " #showhidethumb").unbind('toggle');
			$(wrapper + " #showhidethumb").toggle(function(){
					$(wrapper + " #gallerythumbframe").hide()
					setcontrolbindings.marginleft = $("#fullframe").css('margin-left');
					$("#fullframe").css('margin-left','0');
					$(wrapper + ' #showhidethumb').text('+');
					$(wrapper + ' #showhidethumb').attr('title','Show thumbnails')
				}, function(){
					console.log("gallery.setcontrolbindings: Showing gallerythumbframe.");
					$(wrapper + " #gallerythumbframe").css('visibility','visible')
					$(wrapper + " #gallerythumbframe").show();
					console.log("gallery.setcontrolbindings: Setting margin-left to " + setcontrolbindings.marginleft);
					$("#fullframe").css('margin-left',setcontrolbindings.marginleft)
					$(wrapper + ' #showhidethumb').text('x');
					$(wrapper + ' #showhidethumb').attr('title','Hide thumbnails')
			})

			if (VIVIZ["config"]["showThumbstrip"] == false) {
				if (typeof(VIVIZ["galleries"][galleryid]["showThumbstrip"]) !== "undefined") {
					if (VIVIZ["galleries"][galleryid]["showThumbstrip"] == false) {					
						$("#showhidethumb").click()
					}
				}
			}
			
			$(wrapper + " #stop").unbind('click');
			$(wrapper + " #stop").click(
					function () {
						if (typeof(si) === "number") {
							clearInterval(si);
						}
					}
			)

			$(wrapper + " #play").unbind('click');
			$(wrapper + " #play").click(
					function () {
						if (typeof(si) === "number") {
							clearInterval(si);
						}
						$("#next").click();
						si = setInterval(
								function () {
									$("#next").click();
								}, VIVIZ["galleries"][galleryid]["frameRate"] || VIVIZ["frameRate"]);
					}
					
			)

			// Time step buttons
			$(wrapper + " #next").unbind('click');
			$(wrapper + ' #next').click(function(){

				var lastvisible = parseInt($(wrapper).attr('lastvisible'));
				if (lastvisible == parseInt($(wrapper).attr('totalvisible'))) {
					// This finds the first image set according to number parameter
					// in hash, which may not be the first image in subset.			
					var nowvisible = parseInt($(wrapper + " #gallerythumbframe img.firstimage").attr('id'));					
				} else {
					var nowvisible = lastvisible + 1;	
				}
				console.log("gallery.setcontrolbindings: Next button clicked."
								+ " Clicking on  #" + nowvisible + ".")
				$(wrapper + " #gallerythumbframe #" + nowvisible).click();

				var length = parseInt($('#gallerythumbframe').attr('data-thumb-length'));
				var shown = parseInt($("#gallerythumbframe > img").last().attr("id"));
				var max = VIVIZ["galleries"][galleryid]["lazyLoadMax"] || VIVIZ["lazyLoadMax"]

				var f = Math.ceil(nowvisible/max) - nowvisible/max
				if (f < 0.5) loadmore("forward");
			});
			
			$(wrapper + " #previous").unbind('click');
			$(wrapper + ' #previous').click(function(){

				var lastvisible = parseInt($(wrapper).attr('lastvisible'));
				if (lastvisible == 1) {
					var nowvisible = parseInt($(wrapper).attr('totalvisible'));
				} else {
					var nowvisible = lastvisible - 1;
				}
				$(wrapper + " #" + nowvisible).click();
				
				var max = VIVIZ["galleries"][galleryid]["lazyLoadMax"] || VIVIZ["lazyLoadMax"]
				var first = parseInt($(wrapper + " #gallerythumbframe > img").first().attr("id"));
				if (nowvisible-first < max) {
					loadmore("backward");
				}
			})
			
			$(wrapper + " #last").unbind('click');
			$(wrapper + ' #last').click(function () {
				var last = parseInt($(wrapper).attr("totalvisible"));
				// Need to re-set application here because clicking
				// on a spacer does not do anything.
				updatehash('number', last, true)
			});

			$(wrapper + " #first").unbind('click');    
			$(wrapper + ' #first').click(function(){
				// Need to re-set application here because clicking
				// on a spacer does not do anything.
				updatehash('number', 1, true)
			});  
		}

		function setscrollbinding() {

			if (typeof(setscrollbinding.lastoffset) === "undefined") {
				setscrollbinding.lastoffset = $(wrapper + " #gallerythumbframe").scrollTop().valueOf();
			}
			var debugscroll = false;

			$(wrapper + ' #gallerythumbframe').scroll(function(e){
				if (debugscroll) console.log("gallery.setscrollbinding(): Scroll event.")

				var currentoffset = $(wrapper + " #gallerythumbframe").scrollTop().valueOf();
				var rel = setscrollbinding.lastoffset - currentoffset;
				setscrollbinding.lastoffset = currentoffset;

				if (debugscroll) {
					if (rel > 0) {
						console.log("gallery.setscrollbinding(): Scroll put lower image #s in view.");
					} else {
						console.log("gallery.setscrollbinding(): Scroll put higher image #s in view.");
					}
				}	
				var elem = $(this);

				var Nlazy = VIVIZ["galleries"][galleryid]["lazyLoadMax"]
							|| VIVIZ["config"]["lazyLoadMax"]


				var Nshown = parseInt($(wrapper + " #gallerythumbframe > img.active").attr("id"));
	
				// Determine number of thumbnails above active one that exist in view.
				var activetop = $(wrapper + " #gallerythumbframe > img.active").offset().top;
				var frametop  = $(wrapper + " #gallerythumbframe").offset().top;
				var frameouterHeight = $(wrapper + " #gallerythumbframe").outerHeight();
				var frameinnerHeight = $(wrapper + " #gallerythumbframe").innerHeight();
				var framedel  = frameouterHeight - frameinnerHeight;
				var rel2       = activetop - frametop;

				var Nshown2 = Math.floor(rel2/VIVIZ["galleries"][galleryid]["thumbHeight"]);
				if (debugscroll) {
					console.log("gallery.setscrollbinding(): Position of active relative to top of document = " + activetop);
					console.log("gallery.setscrollbinding(): Position of active gallerythumbframe to top of document = " + frametop);
					console.log("gallery.setscrollbinding(): outerHeight - innerHeight of gallerythumbframe = " + frameinnerHeight + " - " + frameouterHeight + " = " + framedel);
					console.log("gallery.setscrollbinding(): Offset of active relative to top of gallerythumbframe = " + rel);
					console.log("gallery.setscrollbinding(): Scroll distance to top of active thumb  = " + rel);
					console.log("gallery.setscrollbinding(): Scroll distance in units of thumbHeight = " + Nshown2);
					}
				if (rel < 0) {
					if (debugscroll) console.log("gallery.setscrollbinding(): Scroll put higher image #s in view.");
					direction = "forward"; // Need to append
					Nshown = Nshown - Nshown2;
					if (debugscroll) console.log("gallery.setscrollbinding(): Last image fully visible in #gallerythumbframe is #" + Nshown + ".");
					Nlast = parseInt($("#gallerythumbframe img").not(".spacer").last().attr("id"));
					if (debugscroll) console.log("gallery.setscrollbinding(): Last image in DOM in #gallerythumbframe is #" + Nlast + ".");
					if ((Nlast-Nshown) < Nlazy) {
						if (debugscroll) console.log("gallery.setscrollbinding(): Number of images below last fully visible image < Nlazy. Calling loadmore('forward', true)");
						loadmore(direction, Nshown, true);
					} else {
						if (debugscroll) console.log("gallery.setscrollbinding(): Number of images below last fully visible image >= Nlazy. Not calling loadmore('forward', true)");
					}
				} else {
					if (debugscroll) console.log("gallery.setscrollbinding(): Scroll put lower image #s in view.");
					direction = "backward"; // Scroll down. Need to prepend.
					Nshown = Nshown - Nshown2 - 1;
					if (debugscroll) console.log("gallery.setscrollbinding(): First image fully visible in #gallerythumbframe is #" + Nshown + ".");
					Nfirst = parseInt($("#gallerythumbframe img").not(".spacer").first().attr("id"));
					if (debugscroll) console.log("gallery.setscrollbinding(): First image in DOM in #gallerythumbframe is #" + Nfirst + ".");
					if (debugscroll) console.log("gallery.setscrollbinding(): Number of images in DOM above it = " + (Nshown-Nfirst) + ".");
					if ((Nshown-Nfirst) < Nlazy) {
						if (debugscroll) console.log("gallery.setscrollbinding(): Number of hidden images above it < Nlazy. Calling loadmore('forwward, true')");
						loadmore(direction, Nshown, true);
					}
				}
			})
		}

	}

	function thumb() {

		tooltip("slider1")
		
		$(wrapper + ' button').each(function () {tooltip($(this).attr('id'))})

		$("#gallery" + gallerynumber).parent().hide()
		$("#thumb" + gallerynumber).parent().show()

		setthumbs()

		function setthumbbindings() {
			console.log('thumb.setthumbbindings(): Setting bindings on ' + wrapper);

			if (!setthumbbindings.active) setthumbbindings.active = {};

			$(wrapper + ' .thumbbrowse').unbind('click');
			$(wrapper + ' .thumbbrowse').unbind('hover');
			$(wrapper + ' .thumbbrowseoverlay').unbind('click');
			$(wrapper + ' .thumbbrowseoverlay').unbind('hover');

			function setfilename(jq) {
				$(wrapper + " #filename").html('');
				$(wrapper + " #filename").append("<a>");
				$(wrapper + " #filename a").attr('href',jq.src.replace(GALLERYINFO['thumbdir'],GALLERYINFO['fulldir'])).text(jq.src.replace(GALLERYINFO['thumbdir'],""));
			}

			function positionoverlay(el) {

				// Where does this 30 pixels come from?
				// 30 is $(wrapper + ' #thumbbrowseoverlay').position().{left,right}
				// Align upper left corners
				var lt = [$(el).offset().left,$(el).position().top]

				if (setthumbbindings.overlayDimensions) {
					// If overlay dimensions known (first overlay loaded)
					console.log("thumb.positionoverlay(): Overlay dimensions known.")
					// Offset is relative to document.
					// Position is relative to the offset of the parent.
					var elo = wrapper + ' #thumbbrowseoverlay'
					console.log("Overlay offset left:   " + $(elo).offset().left)
					console.log("Overlay offset top:    " + $(elo).offset().top)
					console.log("Overlay position left: " + $(elo).position().left)
					console.log("Overlay position top:  " + $(elo).position().top)
					console.log("Overlay width:  " + $(elo).width())
					console.log("Overlay height: " + $(elo).height())

					console.log("Element offset left:   " + $(el).offset().left)
					console.log("Element offset top:    " + $(el).offset().top)
					console.log("Element position left: " + $(el).position().left)
					console.log("Element position top:  " + $(el).position().top)
					console.log("Element width:  " + $(el).width())
					console.log("Element height: " + $(el).height())

					console.log('Window width:  ' + $(window).width())
					console.log('Window height: ' + $(window).height())
					if ($(el).offset().left > $(window).width()/2) {
						var lt = [$(el).offset().left-setthumbbindings.overlayDimensions[0]+$(el).outerWidth(),$(el).position().top]						
					}
				}

				return lt
			}

			// Overlay on click.
			$(wrapper + ' .thumbbrowse').click(function () {
				console.log("Thumb click event.")

				setthumbbindings.active = this
				$(setthumbbindings.active).addClass("active")
				lt = positionoverlay(this)
				console.log(lt)
				$(wrapper + ' #thumbbrowseoverlay').parent().prepend('<img style="position:absolute; z-index:2; display:none" id="thumboverlayloading" src="css/ajax-loader.gif"/>')
				$(wrapper + ' #thumboverlayloading').css("left", lt[0]).css("top", lt[1]).fadeIn(2000)

				// http://stackoverflow.com/questions/3877027/jquery-callback-on-image-load-even-when-the-image-is-cached
				$(wrapper + ' #thumbbrowseoverlay').unbind('load')
				console.log("Loading overlay.")
				$(wrapper + ' #thumbbrowseoverlay')
					.show()
					.attr("src", $(this).attr("srcfull"))
					.css("left", lt[0])
					.css("top", lt[1])
					.error(function () {
						console.log("Overlay error event.")
						$(wrapper + ' #thumboverlayloading').remove()
						$(this).hide()
						$(setthumbbindings.active).removeClass("active")
					})
					.one("load",function () {
						console.log("Overlay load event.")
						setthumbbindings.overlayOffset   = [$(wrapper + ' #thumbbrowseoverlay').offset().left, $(wrapper + ' #thumbbrowseoverlay').offset().top]
						setthumbbindings.overlayPosition = [$(wrapper + ' #thumbbrowseoverlay').position().left, $(wrapper + ' #thumbbrowseoverlay').position().top]
						setthumbbindings.overlayDimensions = [$(wrapper + ' #thumbbrowseoverlay').outerWidth(), $(wrapper + ' #thumbbrowseoverlay').height()]
						lt = positionoverlay(setthumbbindings.active)
						console.log(lt)
						$(this).css("left", lt[0])
						$(this).css("top", lt[1])
						$(wrapper + ' #thumboverlayloading').remove()
					}).each(function() {
						//if(this.complete) $(this).load();
					})
			})

			// If image is clicked on, close.
			$(wrapper + ' #thumbbrowseoverlay').click(function(){
				console.log("Overlay clicked.")
				$(wrapper + ' #thumbbrowseoverlay').hide()
				console.log($(setthumbbindings.active).hasClass("loaderror"))
				$(setthumbbindings.active).removeClass("active")
			})
			
			// If image is hovered on and then a hover-out event occurs, close.
			$(wrapper + ' #thumbbrowseoverlay').hover(
				function(event){
					// Hover in event.
					console.log("Overlay hover in event.")
				},
				function(){
					// Hover out event
					console.log("Overlay hover out event.")
					$(wrapper + ' #thumbbrowseoverlay').hide()
					$(setthumbbindings.active).removeClass("active")
				})
		}

		function setthumbs() {

			window.onresize = function onresize() {console.log("thumb.setthumbs(): Zoom or resize event.")}
			
			thumb.Nset = 0; 	// # Set in DOM.
			thumb.Nloaded = 0;  // # For which load event triggered.
			// Note that we don't have a way of determining when image is
			// visible or when image size has changed.

			// This is set to a value by slider change.
			var newWidth = false;
			var newHeight = false;
			
			var th = 100; // Initial thumb height
			var tw = 100; // Initial thumb width

			// Get list of thumbnails in order determined by drop-downs.
			var INFOjs = thumblist()
			
			// Maximum number of thumbnails to load.  Will change after we
			// know how many images fit per row.
			var maxLength = Math.min(INFOjs.length, 
								VIVIZ["galleries"][galleryid]["lazyLoadMax"] 
							 || VIVIZ["config"]["lazyLoadMax"])
			
			// Trigger setting of maxLength images in DOM.
			loadmore()
			setscrolltrigger()

			function loadmore() {

				// thumb.Nset may change, so get current value.
				var Nset = thumb.Nset

				if ($(wrapper).height() < $(window).height()) {
					console.log("thumb.loadmore(): Called. Nset = " + Nset)
					console.log("thumb.loadmore(): $(wrapper).height() = " + $(wrapper).height())
					console.log("thumb.loadmore(): $(window).height() = " + $(window).height())
					console.log("thumb.loadmore(): Loading more images because vertical space is available.")

					for (var j = Nset; j < Nset+maxLength; j++) {
						loadone(j)
					}
					
					// This sets bindings on everything.  May take a long
					// time when many are shown.
					setthumbbindings()
				}
			}

			function objToString (obj) {
				var str = ''
				for (var p in obj) {
					if (obj.hasOwnProperty(p)) {str += p + ':' + obj[p] + '\n'}
				}
				return str;
			}

			function setslider() {
				$( "#slider1" ).change(function () {
					console.log("thumb.setslider(): Slider value changed to " + this.value)
					newWidth = tw*this.value/4;
					newHeight = th*this.value/4
					$('.thumbbrowse').css('width', newWidth);
					$('.thumbbrowse').css('height', newHeight);
					setpadding()
					loadmore()
				})
			}

			function setpadding(el) {

				// Set left padding so that block of images is centered.
				// Could avoid this call if text-alignment:center was used,
				// except that if there is an un-filled last row
				// the images will be centered instead of left-justified.
				if (el) {
					// Use actual element instead of querying DOM.
					// (Element may be loaded, setpadding() called, but
					// element may not yet be in DOM.)
					x = $(el).outerWidth()
				} else {
					x = $(wrapper + " #thumbbrowseframe img:first").outerWidth()
				}
				var iw = $("#thumbbrowseframe").innerWidth()

				// Only modify padding of #thumbbrowseframe if first image
				// size has changed or innerWidth has changed.  
				if (typeof(setpadding.lastx) !== 'undefined') {
					// Only modify padding if iw has changed.
					if (setpadding.lastiw == iw)  {
						return
					}
				}

				console.log("thumb.setpadding(): First image outer width = " + x)
				console.log("thumb.setpadding(): Inner width of thumbbrowseframe = " + iw)

				setpadding.lastx = x
				setpadding.lastiw = iw

				var pl = parseInt($("#thumbbrowseframe").css('padding-left').replace('px',""))
				var pr = parseInt($("#thumbbrowseframe").css('padding-right').replace('px',""))

				console.log("thumb.setpadding(): padding-left/right of thumbbrowseframe = " + pl + "/" + pr)

				a = (iw)/x
				console.log("thumb.setpadding(): Max # images per row = " + a);
				b = (a - Math.floor(a))*x


				if (INFOjs.length < Math.floor(a)) {
					// # of images is less than number of images possible per row.
					console.log('thumb.setpadding(): Total # images in row ' + INFOjs.length)
					b =  iw - x*INFOjs.length
				}

				console.log("thumb.setpadding(): Total extra space = " + b);
				console.log("thumb.setpadding(): Setting left padding to " +  Math.floor(b/2))
				$("#thumbbrowseframe").css('padding-left', Math.floor(b/2))

				if (el)
					fillrow(el)
			}
			
			function loadone(i) {

				var fixed = false;
				if (i > INFOjs.length-1) return;
				thumb.Nset = thumb.Nset+1;
				if (thumb.Nset == INFOjs.length-1) {
					$("#instructions").html("All images requested.");
					$("#instructions2").html("All images requested.");
				}

				var src = VIVIZ["galleries"][galleryid]["thumbdirdecoded"] + INFOjs[i]['ThumbFile'];
				var srcfull = VIVIZ["galleries"][galleryid]["fulldirdecoded"] + INFOjs[i]['FullFile'];

				$('<img class="thumbbrowse loading"/>')
					.width(newWidth || tw || 100)
					.attr("src", src)
					.attr("srcfull", srcfull)
					.attr("id",i)
					.css("height",newHeight || th || 100)
					.attr("title",objToString(INFOjs[i]))
					.error(function () {
						$(this).removeClass("loading");
						$(this).addClass("loaderror");
						$(this).attr("src","css/transparent.png");
						$(this).width(newWidth || tw || 100);
						$(this).height(newHeight || th || 100);
						if (th) {
							$('.loaderror').css('height',th);
						}
						if (tw > 0 && !fixed) {fixed = true;$(".loaderror").width(tw)}
					})
					.load(function () {

						$(this).removeClass("loading");

						// See caveats at https://api.jquery.com/load-event/
						// This checks if load event was fired after error event
						// (and after class was set, hopefully.)
						var err = $(this).hasClass('loaderror')

						thumb.Nloaded = thumb.Nloaded + 1
						if (!loadone.first && !err) {
							console.log("thumb.setthumbs.loadone(): First thumbnail loaded.")

							loadone.first = true

							// Set thumbWidth and Height in VIVIZ["galleries"][galleryid]
							var tmp = setWH(this, 'thumb')

							tw = VIVIZ["galleries"][galleryid]["thumbWidth"]
							th = VIVIZ["galleries"][galleryid]["thumbHeight"]

							setslider()
						} else {
							console.log("thumb.setthumbs.loadone(): Thumbnail loaded.")
						}

						$(this).width(newWidth || tw)
						$(this).height(newHeight || th)
						
						setpadding(this)
						loadmore()

					})
					.appendTo($(wrapper + ' #thumbbrowseframe'))		
			}
			
			function fillrow(el) {
				var delta = 0;
				if (!el) {
					//el = $(wrapper + " #thumbbrowseframe img:first")
				}

				if (loadone.first) {
					console.log("thumb.setthumbs.fillrow(): #thumbbrowseframe "
						+ "innerWidth:" + $("#thumbbrowseframe").innerWidth())
					console.log("thumb.setthumbs.fillrow(): #thumbbrowseframe "
						+ "img:first outerWidth:" + $(el).outerWidth())

					var a = Math.floor($("#thumbbrowseframe").innerWidth()/$(el).outerWidth())

					console.log("thumb.setthumbs.fillrow(): Images per row = " + a)
					if (maxLength < a) {
						console.log("thumb.setthumbs.fillrow(): Changing maxLength from " + maxLength + " to " + a)
						maxLength = a
					} else {
						var c = a*Math.ceil(maxLength/a)
						console.log("thumb.setthumbs.fillrow(): Changing maxLength from " + maxLength + " to " + c)
						maxLength = c
					}
					console.log("thumb.setthumbs.fillrow(): thumb.Nset = " + thumb.Nset)

					var delta = a - (thumb.Nset % a)
					if (delta == a) {
						// Last row is full
						delta = 0
					}
					console.log("thumb.setthumbs.fillrow(): Room for " + delta + " more images")
				}	

				if (!isFinite(delta)) {
					console.log("thumb.setthumbs.fillrow(): Delta is not finite")
					return
				}

				Nl = thumb.Nset;
				for (var j = Nl; j < Nl+delta; j++) {
					loadone(j)
				}
			}

			function setscrolltrigger() {
				$(window).unbind('scroll');
				$(window).scroll(function (e) {
					var Nset = thumb.Nset
					if (Nset + maxLength > INFOjs.length - 1) {
						console.log("thumb.setthumbs.setscrolltrigger(): Nset + maxLength > # images. Resetting maxLength.")
						maxLength = INFOjs.length-Nset
						for (var j = Nset; j < Nset+maxLength; j++) {
							loadone(j)
						}
						setthumbbindings()

						$(window).unbind('scroll')
					}
					// Hidden space below is 
					// $(document).height() - ($(window).scrollTop() + $(window).height())
					// Want hidden space to be at least 2*th
					if (2*th + $(window).scrollTop() + $(window).height() >= $(document).height()) {
						console.log("thumb.setthumbs.setscrolltrigger(): Scroll triggered & criteria satisfied.")
						console.log("thumb.setthumbs.setscrolltrigger(): maxLength = "
							+ maxLength + ", first thumbheight = " + th)
						console.log("thumb.setthumbs.setscrolltrigger(): "
							+ "2*th + $(window).scrollTop() + $(window).height() = "
							+ (2*th + $(window).scrollTop() + $(window).height()))
						console.log("thumb.setthumbs.setscrolltrigger(): $(document).height() = " + ($(document).height()))

						// TODO: The following code is duplicated in loadmore().
						for (var j = Nset; j < Nset+maxLength; j++) {
							loadone(j)
						}
						setthumbbindings()
					} else {
						console.log("thumb.setthumbs.setscrolltrigger(): Scroll triggered, but criteria not satisfied.")
					}
				})
			}
		}
	}

}</script>

		<link rel="icon" type="image/ico" href="css/favicon.ico">
		<style>
/* Start definitions from bootstrap.css */
body {
  margin: 0;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 13px;
  line-height: 18px;
  color: #333333;
  background-color: #ffffff;
}

body .ui-tooltip {
	border: 1px solid black;
	background: white;
}
body .ui-widget-content {
	background: white;
}
img.full {
	z-index: 0;
	vertical-align: middle;
}

/* Corner radius */
.ui-corner-all, .ui-corner-top, .ui-corner-left, .ui-corner-tl { -moz-border-radius-topleft: 6px; -webkit-border-top-left-radius: 6px; -khtml-border-top-left-radius: 6px; border-top-left-radius: 6px; }
.ui-corner-all, .ui-corner-top, .ui-corner-right, .ui-corner-tr { -moz-border-radius-topright: 6px; -webkit-border-top-right-radius: 6px; -khtml-border-top-right-radius: 6px; border-top-right-radius: 6px; }
.ui-corner-all, .ui-corner-bottom, .ui-corner-left, .ui-corner-bl { -moz-border-radius-bottomleft: 6px; -webkit-border-bottom-left-radius: 6px; -khtml-border-bottom-left-radius: 6px; border-bottom-left-radius: 6px; }
.ui-corner-all, .ui-corner-bottom, .ui-corner-right, .ui-corner-br { -moz-border-radius-bottomright: 6px; -webkit-border-bottom-right-radius: 6px; -khtml-border-bottom-right-radius: 6px; border-bottom-right-radius: 6px; }

.ui-widget-content { border: 1px solid #666666; background: #000000 url("css/ui-darkness/images/ui-bg_inset-soft_25_000000_1x100.png") 50% bottom repeat-x; color: #000000; }
.ui-widget-content a { color: #000000; }
.ui-widget input, .ui-widget select, .ui-widget textarea, .ui-widget button { font-family: Segoe UI, Arial, sans-serif; font-size: 1em; }

.ui-widget { font-family: Segoe UI, Arial, sans-serif; font-size: 1.1em; }
.ui-widget .ui-widget { font-size: 1em; }

.well {
  min-height: 10px;
  padding: 2px;
  margin-bottom: 2px;
  background-color: #f5f5f5;
  border: 1px solid #eee;
  border: 1px solid rgba(0, 0, 0, 0.05);
  -webkit-border-radius: 4px;
     -moz-border-radius: 4px;
          border-radius: 4px;
  -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
     -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
          box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
}


.btn {
  display: inline-block;
  *display: inline;
  padding: 4px 10px 4px;
  margin-bottom: 0;
  *margin-left: .3em;
  font-size: 13px;
  line-height: 18px;
  *line-height: 20px;
  color: #333333;
  text-align: center;
  text-shadow: 0 1px 1px rgba(255, 255, 255, 0.75);
  vertical-align: middle;
  cursor: pointer;
  background-color: #f5f5f5;
  *background-color: #e6e6e6;
  background-image: -ms-linear-gradient(top, #ffffff, #e6e6e6);
  background-image: -webkit-gradient(linear, 0 0, 0 100%, from(#ffffff), to(#e6e6e6));
  background-image: -webkit-linear-gradient(top, #ffffff, #e6e6e6);
  background-image: -o-linear-gradient(top, #ffffff, #e6e6e6);
  background-image: linear-gradient(top, #ffffff, #e6e6e6);
  background-image: -moz-linear-gradient(top, #ffffff, #e6e6e6);
  background-repeat: repeat-x;
  border: 1px solid #cccccc;
  *border: 0;
  border-color: rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.1) rgba(0, 0, 0, 0.25);
  border-color: #e6e6e6 #e6e6e6 #bfbfbf;
  border-bottom-color: #b3b3b3;
  -webkit-border-radius: 4px;
     -moz-border-radius: 4px;
          border-radius: 4px;
  filter: progid:dximagetransform.microsoft.gradient(startColorstr='#ffffff', endColorstr='#e6e6e6', GradientType=0);
  filter: progid:dximagetransform.microsoft.gradient(enabled=false);
  *zoom: 1;
  -webkit-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
     -moz-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
          box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
}

.btn:hover,
.btn:active,
.btn.active,
.btn.disabled,
.btn[disabled] {
  background-color: #e6e6e6;
  *background-color: #d9d9d9;
}

.btn:active,
.btn.active {
  background-color: #cccccc \9;
}

.btn:first-child {
  *margin-left: 0;
}

.btn:hover {
  color: #333333;
  text-decoration: none;
  background-color: #e6e6e6;
  *background-color: #d9d9d9;
  /* Buttons in IE7 don't get borders, so darken on hover */

  background-position: 0 -15px;
  -webkit-transition: background-position 0.1s linear;
     -moz-transition: background-position 0.1s linear;
      -ms-transition: background-position 0.1s linear;
       -o-transition: background-position 0.1s linear;
          transition: background-position 0.1s linear;
}

.btn:focus {
  outline: thin dotted #333;
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}

.btn.active,
.btn:active {
  background-color: #e6e6e6;
  background-color: #d9d9d9 \9;
  background-image: none;
  outline: 0;
  -webkit-box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
     -moz-box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
          box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
}

.btn.disabled,
.btn[disabled] {
  cursor: default;
  background-color: #e6e6e6;
  background-image: none;
  opacity: 0.65;
  filter: alpha(opacity=65);
  -webkit-box-shadow: none;
     -moz-box-shadow: none;
          box-shadow: none;
}

h1,
h2,
h3,
h4,
h5,
h6 {
  margin: 0;
  font-family: inherit;
  font-weight: bold;
  color: inherit;
  text-rendering: optimizelegibility;
}

h4,
h5,
h6 {
  line-height: 18px;
}

h4 {
  font-size: 14px;
}

select {
  width: 120px;
  border: 1px solid #bbb;
}

select[multiple],
select[size] {
  height: auto;
}

select:focus,
input[type="file"]:focus,
input[type="radio"]:focus,
input[type="checkbox"]:focus {
  outline: thin dotted #333;
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}

button,
input,
select,
textarea {
  margin: 0;
  font-size: 100%;
  vertical-align: middle;
}

select {
  display: inline-block;
  height: 28px;
  padding: 4px;
  font-size: 13px;
  line-height: 28px;
  color: #555555;
  font-weight:bold;
}
/* End definitions from bootstrap.css */

select #gallery {
	width: 15em;
}

#g-container #gallerythumbframe {
	overflow-y: auto;
	overflow-x: hidden;
	float: left;
	text-align: center;
}
#g-container table {
	border: 0px solid green;
	table-layout: fixed;
}
#g-container td {
	border: 0px solid green;
}
#g-container .gallerythumbbrowse {
  overflow-y: auto;
  margin:auto;
  border: 2px solid white; /*3px*/
}
#g-container .error {
  border: 2px solid red;

}
#g-container .inactive {
  border: 2px solid white;
}
#g-container .active {
  border: 2px solid blue;
}
#g-container > button {
	background-color: white;
	padding: 0px 0px;
	border:0px;
	color: black;
	font-weight:bold;
	font-size:12pt;
	cursor:pointer;
}

#t-container > button {
	background-color: white;
	padding: 0px 0px;
	border:0px;
	color: black;
	font-weight:bold;
	font-size:12pt;
	cursor:pointer;
}
#t-container #thumbbrowseoverlay {
	z-index:1;
}

#thumbframe {
	float: left;
	text-align:left;
	z-index:0;
}

#t-container .loaderror {
    border: 2px solid red;
}
#t-container .active {
    border: 2px solid blue;
}
#t-container .loading.thumbbrowse {
    border: 2px solid gray;
}
.thumbbrowse {
	border:solid white 2px;
	vertical-align:top;
	margin:auto;
	z-index:1;
}
.thumbbrowsetop {
	filter:alpha(opacity=90);
	opacity:0.90;
	position: absolute;
	display:none;
	z-index:-1;
}
</style>

		<script type="text/javascript">/*! jQuery v1.7.2 jquery.com | jquery.org/license */
(function(a,b){function cy(a){return f.isWindow(a)?a:a.nodeType===9?a.defaultView||a.parentWindow:!1}function cu(a){if(!cj[a]){var b=c.body,d=f("<"+a+">").appendTo(b),e=d.css("display");d.remove();if(e==="none"||e===""){ck||(ck=c.createElement("iframe"),ck.frameBorder=ck.width=ck.height=0),b.appendChild(ck);if(!cl||!ck.createElement)cl=(ck.contentWindow||ck.contentDocument).document,cl.write((f.support.boxModel?"<!doctype html>":"")+"<html><body>"),cl.close();d=cl.createElement(a),cl.body.appendChild(d),e=f.css(d,"display"),b.removeChild(ck)}cj[a]=e}return cj[a]}function ct(a,b){var c={};f.each(cp.concat.apply([],cp.slice(0,b)),function(){c[this]=a});return c}function cs(){cq=b}function cr(){setTimeout(cs,0);return cq=f.now()}function ci(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}function ch(){try{return new a.XMLHttpRequest}catch(b){}}function cb(a,c){a.dataFilter&&(c=a.dataFilter(c,a.dataType));var d=a.dataTypes,e={},g,h,i=d.length,j,k=d[0],l,m,n,o,p;for(g=1;g<i;g++){if(g===1)for(h in a.converters)typeof h=="string"&&(e[h.toLowerCase()]=a.converters[h]);l=k,k=d[g];if(k==="*")k=l;else if(l!=="*"&&l!==k){m=l+" "+k,n=e[m]||e["* "+k];if(!n){p=b;for(o in e){j=o.split(" ");if(j[0]===l||j[0]==="*"){p=e[j[1]+" "+k];if(p){o=e[o],o===!0?n=p:p===!0&&(n=o);break}}}}!n&&!p&&f.error("No conversion from "+m.replace(" "," to ")),n!==!0&&(c=n?n(c):p(o(c)))}}return c}function ca(a,c,d){var e=a.contents,f=a.dataTypes,g=a.responseFields,h,i,j,k;for(i in g)i in d&&(c[g[i]]=d[i]);while(f[0]==="*")f.shift(),h===b&&(h=a.mimeType||c.getResponseHeader("content-type"));if(h)for(i in e)if(e[i]&&e[i].test(h)){f.unshift(i);break}if(f[0]in d)j=f[0];else{for(i in d){if(!f[0]||a.converters[i+" "+f[0]]){j=i;break}k||(k=i)}j=j||k}if(j){j!==f[0]&&f.unshift(j);return d[j]}}function b_(a,b,c,d){if(f.isArray(b))f.each(b,function(b,e){c||bD.test(a)?d(a,e):b_(a+"["+(typeof e=="object"?b:"")+"]",e,c,d)});else if(!c&&f.type(b)==="object")for(var e in b)b_(a+"["+e+"]",b[e],c,d);else d(a,b)}function b$(a,c){var d,e,g=f.ajaxSettings.flatOptions||{};for(d in c)c[d]!==b&&((g[d]?a:e||(e={}))[d]=c[d]);e&&f.extend(!0,a,e)}function bZ(a,c,d,e,f,g){f=f||c.dataTypes[0],g=g||{},g[f]=!0;var h=a[f],i=0,j=h?h.length:0,k=a===bS,l;for(;i<j&&(k||!l);i++)l=h[i](c,d,e),typeof l=="string"&&(!k||g[l]?l=b:(c.dataTypes.unshift(l),l=bZ(a,c,d,e,l,g)));(k||!l)&&!g["*"]&&(l=bZ(a,c,d,e,"*",g));return l}function bY(a){return function(b,c){typeof b!="string"&&(c=b,b="*");if(f.isFunction(c)){var d=b.toLowerCase().split(bO),e=0,g=d.length,h,i,j;for(;e<g;e++)h=d[e],j=/^\+/.test(h),j&&(h=h.substr(1)||"*"),i=a[h]=a[h]||[],i[j?"unshift":"push"](c)}}}function bB(a,b,c){var d=b==="width"?a.offsetWidth:a.offsetHeight,e=b==="width"?1:0,g=4;if(d>0){if(c!=="border")for(;e<g;e+=2)c||(d-=parseFloat(f.css(a,"padding"+bx[e]))||0),c==="margin"?d+=parseFloat(f.css(a,c+bx[e]))||0:d-=parseFloat(f.css(a,"border"+bx[e]+"Width"))||0;return d+"px"}d=by(a,b);if(d<0||d==null)d=a.style[b];if(bt.test(d))return d;d=parseFloat(d)||0;if(c)for(;e<g;e+=2)d+=parseFloat(f.css(a,"padding"+bx[e]))||0,c!=="padding"&&(d+=parseFloat(f.css(a,"border"+bx[e]+"Width"))||0),c==="margin"&&(d+=parseFloat(f.css(a,c+bx[e]))||0);return d+"px"}function bo(a){var b=c.createElement("div");bh.appendChild(b),b.innerHTML=a.outerHTML;return b.firstChild}function bn(a){var b=(a.nodeName||"").toLowerCase();b==="input"?bm(a):b!=="script"&&typeof a.getElementsByTagName!="undefined"&&f.grep(a.getElementsByTagName("input"),bm)}function bm(a){if(a.type==="checkbox"||a.type==="radio")a.defaultChecked=a.checked}function bl(a){return typeof a.getElementsByTagName!="undefined"?a.getElementsByTagName("*"):typeof a.querySelectorAll!="undefined"?a.querySelectorAll("*"):[]}function bk(a,b){var c;b.nodeType===1&&(b.clearAttributes&&b.clearAttributes(),b.mergeAttributes&&b.mergeAttributes(a),c=b.nodeName.toLowerCase(),c==="object"?b.outerHTML=a.outerHTML:c!=="input"||a.type!=="checkbox"&&a.type!=="radio"?c==="option"?b.selected=a.defaultSelected:c==="input"||c==="textarea"?b.defaultValue=a.defaultValue:c==="script"&&b.text!==a.text&&(b.text=a.text):(a.checked&&(b.defaultChecked=b.checked=a.checked),b.value!==a.value&&(b.value=a.value)),b.removeAttribute(f.expando),b.removeAttribute("_submit_attached"),b.removeAttribute("_change_attached"))}function bj(a,b){if(b.nodeType===1&&!!f.hasData(a)){var c,d,e,g=f._data(a),h=f._data(b,g),i=g.events;if(i){delete h.handle,h.events={};for(c in i)for(d=0,e=i[c].length;d<e;d++)f.event.add(b,c,i[c][d])}h.data&&(h.data=f.extend({},h.data))}}function bi(a,b){return f.nodeName(a,"table")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function U(a){var b=V.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}function T(a,b,c){b=b||0;if(f.isFunction(b))return f.grep(a,function(a,d){var e=!!b.call(a,d,a);return e===c});if(b.nodeType)return f.grep(a,function(a,d){return a===b===c});if(typeof b=="string"){var d=f.grep(a,function(a){return a.nodeType===1});if(O.test(b))return f.filter(b,d,!c);b=f.filter(b,d)}return f.grep(a,function(a,d){return f.inArray(a,b)>=0===c})}function S(a){return!a||!a.parentNode||a.parentNode.nodeType===11}function K(){return!0}function J(){return!1}function n(a,b,c){var d=b+"defer",e=b+"queue",g=b+"mark",h=f._data(a,d);h&&(c==="queue"||!f._data(a,e))&&(c==="mark"||!f._data(a,g))&&setTimeout(function(){!f._data(a,e)&&!f._data(a,g)&&(f.removeData(a,d,!0),h.fire())},0)}function m(a){for(var b in a){if(b==="data"&&f.isEmptyObject(a[b]))continue;if(b!=="toJSON")return!1}return!0}function l(a,c,d){if(d===b&&a.nodeType===1){var e="data-"+c.replace(k,"-$1").toLowerCase();d=a.getAttribute(e);if(typeof d=="string"){try{d=d==="true"?!0:d==="false"?!1:d==="null"?null:f.isNumeric(d)?+d:j.test(d)?f.parseJSON(d):d}catch(g){}f.data(a,c,d)}else d=b}return d}function h(a){var b=g[a]={},c,d;a=a.split(/\s+/);for(c=0,d=a.length;c<d;c++)b[a[c]]=!0;return b}var c=a.document,d=a.navigator,e=a.location,f=function(){function J(){if(!e.isReady){try{c.documentElement.doScroll("left")}catch(a){setTimeout(J,1);return}e.ready()}}var e=function(a,b){return new e.fn.init(a,b,h)},f=a.jQuery,g=a.$,h,i=/^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,j=/\S/,k=/^\s+/,l=/\s+$/,m=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,n=/^[\],:{}\s]*$/,o=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,p=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,q=/(?:^|:|,)(?:\s*\[)+/g,r=/(webkit)[ \/]([\w.]+)/,s=/(opera)(?:.*version)?[ \/]([\w.]+)/,t=/(msie) ([\w.]+)/,u=/(mozilla)(?:.*? rv:([\w.]+))?/,v=/-([a-z]|[0-9])/ig,w=/^-ms-/,x=function(a,b){return(b+"").toUpperCase()},y=d.userAgent,z,A,B,C=Object.prototype.toString,D=Object.prototype.hasOwnProperty,E=Array.prototype.push,F=Array.prototype.slice,G=String.prototype.trim,H=Array.prototype.indexOf,I={};e.fn=e.prototype={constructor:e,init:function(a,d,f){var g,h,j,k;if(!a)return this;if(a.nodeType){this.context=this[0]=a,this.length=1;return this}if(a==="body"&&!d&&c.body){this.context=c,this[0]=c.body,this.selector=a,this.length=1;return this}if(typeof a=="string"){a.charAt(0)!=="<"||a.charAt(a.length-1)!==">"||a.length<3?g=i.exec(a):g=[null,a,null];if(g&&(g[1]||!d)){if(g[1]){d=d instanceof e?d[0]:d,k=d?d.ownerDocument||d:c,j=m.exec(a),j?e.isPlainObject(d)?(a=[c.createElement(j[1])],e.fn.attr.call(a,d,!0)):a=[k.createElement(j[1])]:(j=e.buildFragment([g[1]],[k]),a=(j.cacheable?e.clone(j.fragment):j.fragment).childNodes);return e.merge(this,a)}h=c.getElementById(g[2]);if(h&&h.parentNode){if(h.id!==g[2])return f.find(a);this.length=1,this[0]=h}this.context=c,this.selector=a;return this}return!d||d.jquery?(d||f).find(a):this.constructor(d).find(a)}if(e.isFunction(a))return f.ready(a);a.selector!==b&&(this.selector=a.selector,this.context=a.context);return e.makeArray(a,this)},selector:"",jquery:"1.7.2",length:0,size:function(){return this.length},toArray:function(){return F.call(this,0)},get:function(a){return a==null?this.toArray():a<0?this[this.length+a]:this[a]},pushStack:function(a,b,c){var d=this.constructor();e.isArray(a)?E.apply(d,a):e.merge(d,a),d.prevObject=this,d.context=this.context,b==="find"?d.selector=this.selector+(this.selector?" ":"")+c:b&&(d.selector=this.selector+"."+b+"("+c+")");return d},each:function(a,b){return e.each(this,a,b)},ready:function(a){e.bindReady(),A.add(a);return this},eq:function(a){a=+a;return a===-1?this.slice(a):this.slice(a,a+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(F.apply(this,arguments),"slice",F.call(arguments).join(","))},map:function(a){return this.pushStack(e.map(this,function(b,c){return a.call(b,c,b)}))},end:function(){return this.prevObject||this.constructor(null)},push:E,sort:[].sort,splice:[].splice},e.fn.init.prototype=e.fn,e.extend=e.fn.extend=function(){var a,c,d,f,g,h,i=arguments[0]||{},j=1,k=arguments.length,l=!1;typeof i=="boolean"&&(l=i,i=arguments[1]||{},j=2),typeof i!="object"&&!e.isFunction(i)&&(i={}),k===j&&(i=this,--j);for(;j<k;j++)if((a=arguments[j])!=null)for(c in a){d=i[c],f=a[c];if(i===f)continue;l&&f&&(e.isPlainObject(f)||(g=e.isArray(f)))?(g?(g=!1,h=d&&e.isArray(d)?d:[]):h=d&&e.isPlainObject(d)?d:{},i[c]=e.extend(l,h,f)):f!==b&&(i[c]=f)}return i},e.extend({noConflict:function(b){a.$===e&&(a.$=g),b&&a.jQuery===e&&(a.jQuery=f);return e},isReady:!1,readyWait:1,holdReady:function(a){a?e.readyWait++:e.ready(!0)},ready:function(a){if(a===!0&&!--e.readyWait||a!==!0&&!e.isReady){if(!c.body)return setTimeout(e.ready,1);e.isReady=!0;if(a!==!0&&--e.readyWait>0)return;A.fireWith(c,[e]),e.fn.trigger&&e(c).trigger("ready").off("ready")}},bindReady:function(){if(!A){A=e.Callbacks("once memory");if(c.readyState==="complete")return setTimeout(e.ready,1);if(c.addEventListener)c.addEventListener("DOMContentLoaded",B,!1),a.addEventListener("load",e.ready,!1);else if(c.attachEvent){c.attachEvent("onreadystatechange",B),a.attachEvent("onload",e.ready);var b=!1;try{b=a.frameElement==null}catch(d){}c.documentElement.doScroll&&b&&J()}}},isFunction:function(a){return e.type(a)==="function"},isArray:Array.isArray||function(a){return e.type(a)==="array"},isWindow:function(a){return a!=null&&a==a.window},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return a==null?String(a):I[C.call(a)]||"object"},isPlainObject:function(a){if(!a||e.type(a)!=="object"||a.nodeType||e.isWindow(a))return!1;try{if(a.constructor&&!D.call(a,"constructor")&&!D.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}var d;for(d in a);return d===b||D.call(a,d)},isEmptyObject:function(a){for(var b in a)return!1;return!0},error:function(a){throw new Error(a)},parseJSON:function(b){if(typeof b!="string"||!b)return null;b=e.trim(b);if(a.JSON&&a.JSON.parse)return a.JSON.parse(b);if(n.test(b.replace(o,"@").replace(p,"]").replace(q,"")))return(new Function("return "+b))();e.error("Invalid JSON: "+b)},parseXML:function(c){if(typeof c!="string"||!c)return null;var d,f;try{a.DOMParser?(f=new DOMParser,d=f.parseFromString(c,"text/xml")):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(c))}catch(g){d=b}(!d||!d.documentElement||d.getElementsByTagName("parsererror").length)&&e.error("Invalid XML: "+c);return d},noop:function(){},globalEval:function(b){b&&j.test(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(w,"ms-").replace(v,x)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toUpperCase()===b.toUpperCase()},each:function(a,c,d){var f,g=0,h=a.length,i=h===b||e.isFunction(a);if(d){if(i){for(f in a)if(c.apply(a[f],d)===!1)break}else for(;g<h;)if(c.apply(a[g++],d)===!1)break}else if(i){for(f in a)if(c.call(a[f],f,a[f])===!1)break}else for(;g<h;)if(c.call(a[g],g,a[g++])===!1)break;return a},trim:G?function(a){return a==null?"":G.call(a)}:function(a){return a==null?"":(a+"").replace(k,"").replace(l,"")},makeArray:function(a,b){var c=b||[];if(a!=null){var d=e.type(a);a.length==null||d==="string"||d==="function"||d==="regexp"||e.isWindow(a)?E.call(c,a):e.merge(c,a)}return c},inArray:function(a,b,c){var d;if(b){if(H)return H.call(b,a,c);d=b.length,c=c?c<0?Math.max(0,d+c):c:0;for(;c<d;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,c){var d=a.length,e=0;if(typeof c.length=="number")for(var f=c.length;e<f;e++)a[d++]=c[e];else while(c[e]!==b)a[d++]=c[e++];a.length=d;return a},grep:function(a,b,c){var d=[],e;c=!!c;for(var f=0,g=a.length;f<g;f++)e=!!b(a[f],f),c!==e&&d.push(a[f]);return d},map:function(a,c,d){var f,g,h=[],i=0,j=a.length,k=a instanceof e||j!==b&&typeof j=="number"&&(j>0&&a[0]&&a[j-1]||j===0||e.isArray(a));if(k)for(;i<j;i++)f=c(a[i],i,d),f!=null&&(h[h.length]=f);else for(g in a)f=c(a[g],g,d),f!=null&&(h[h.length]=f);return h.concat.apply([],h)},guid:1,proxy:function(a,c){if(typeof c=="string"){var d=a[c];c=a,a=d}if(!e.isFunction(a))return b;var f=F.call(arguments,2),g=function(){return a.apply(c,f.concat(F.call(arguments)))};g.guid=a.guid=a.guid||g.guid||e.guid++;return g},access:function(a,c,d,f,g,h,i){var j,k=d==null,l=0,m=a.length;if(d&&typeof d=="object"){for(l in d)e.access(a,c,l,d[l],1,h,f);g=1}else if(f!==b){j=i===b&&e.isFunction(f),k&&(j?(j=c,c=function(a,b,c){return j.call(e(a),c)}):(c.call(a,f),c=null));if(c)for(;l<m;l++)c(a[l],d,j?f.call(a[l],l,c(a[l],d)):f,i);g=1}return g?a:k?c.call(a):m?c(a[0],d):h},now:function(){return(new Date).getTime()},uaMatch:function(a){a=a.toLowerCase();var b=r.exec(a)||s.exec(a)||t.exec(a)||a.indexOf("compatible")<0&&u.exec(a)||[];return{browser:b[1]||"",version:b[2]||"0"}},sub:function(){function a(b,c){return new a.fn.init(b,c)}e.extend(!0,a,this),a.superclass=this,a.fn=a.prototype=this(),a.fn.constructor=a,a.sub=this.sub,a.fn.init=function(d,f){f&&f instanceof e&&!(f instanceof a)&&(f=a(f));return e.fn.init.call(this,d,f,b)},a.fn.init.prototype=a.fn;var b=a(c);return a},browser:{}}),e.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(a,b){I["[object "+b+"]"]=b.toLowerCase()}),z=e.uaMatch(y),z.browser&&(e.browser[z.browser]=!0,e.browser.version=z.version),e.browser.webkit&&(e.browser.safari=!0),j.test("")&&(k=/^[\s\xA0]+/,l=/[\s\xA0]+$/),h=e(c),c.addEventListener?B=function(){c.removeEventListener("DOMContentLoaded",B,!1),e.ready()}:c.attachEvent&&(B=function(){c.readyState==="complete"&&(c.detachEvent("onreadystatechange",B),e.ready())});return e}(),g={};f.Callbacks=function(a){a=a?g[a]||h(a):{};var c=[],d=[],e,i,j,k,l,m,n=function(b){var d,e,g,h,i;for(d=0,e=b.length;d<e;d++)g=b[d],h=f.type(g),h==="array"?n(g):h==="function"&&(!a.unique||!p.has(g))&&c.push(g)},o=function(b,f){f=f||[],e=!a.memory||[b,f],i=!0,j=!0,m=k||0,k=0,l=c.length;for(;c&&m<l;m++)if(c[m].apply(b,f)===!1&&a.stopOnFalse){e=!0;break}j=!1,c&&(a.once?e===!0?p.disable():c=[]:d&&d.length&&(e=d.shift(),p.fireWith(e[0],e[1])))},p={add:function(){if(c){var a=c.length;n(arguments),j?l=c.length:e&&e!==!0&&(k=a,o(e[0],e[1]))}return this},remove:function(){if(c){var b=arguments,d=0,e=b.length;for(;d<e;d++)for(var f=0;f<c.length;f++)if(b[d]===c[f]){j&&f<=l&&(l--,f<=m&&m--),c.splice(f--,1);if(a.unique)break}}return this},has:function(a){if(c){var b=0,d=c.length;for(;b<d;b++)if(a===c[b])return!0}return!1},empty:function(){c=[];return this},disable:function(){c=d=e=b;return this},disabled:function(){return!c},lock:function(){d=b,(!e||e===!0)&&p.disable();return this},locked:function(){return!d},fireWith:function(b,c){d&&(j?a.once||d.push([b,c]):(!a.once||!e)&&o(b,c));return this},fire:function(){p.fireWith(this,arguments);return this},fired:function(){return!!i}};return p};var i=[].slice;f.extend({Deferred:function(a){var b=f.Callbacks("once memory"),c=f.Callbacks("once memory"),d=f.Callbacks("memory"),e="pending",g={resolve:b,reject:c,notify:d},h={done:b.add,fail:c.add,progress:d.add,state:function(){return e},isResolved:b.fired,isRejected:c.fired,then:function(a,b,c){i.done(a).fail(b).progress(c);return this},always:function(){i.done.apply(i,arguments).fail.apply(i,arguments);return this},pipe:function(a,b,c){return f.Deferred(function(d){f.each({done:[a,"resolve"],fail:[b,"reject"],progress:[c,"notify"]},function(a,b){var c=b[0],e=b[1],g;f.isFunction(c)?i[a](function(){g=c.apply(this,arguments),g&&f.isFunction(g.promise)?g.promise().then(d.resolve,d.reject,d.notify):d[e+"With"](this===i?d:this,[g])}):i[a](d[e])})}).promise()},promise:function(a){if(a==null)a=h;else for(var b in h)a[b]=h[b];return a}},i=h.promise({}),j;for(j in g)i[j]=g[j].fire,i[j+"With"]=g[j].fireWith;i.done(function(){e="resolved"},c.disable,d.lock).fail(function(){e="rejected"},b.disable,d.lock),a&&a.call(i,i);return i},when:function(a){function m(a){return function(b){e[a]=arguments.length>1?i.call(arguments,0):b,j.notifyWith(k,e)}}function l(a){return function(c){b[a]=arguments.length>1?i.call(arguments,0):c,--g||j.resolveWith(j,b)}}var b=i.call(arguments,0),c=0,d=b.length,e=Array(d),g=d,h=d,j=d<=1&&a&&f.isFunction(a.promise)?a:f.Deferred(),k=j.promise();if(d>1){for(;c<d;c++)b[c]&&b[c].promise&&f.isFunction(b[c].promise)?b[c].promise().then(l(c),j.reject,m(c)):--g;g||j.resolveWith(j,b)}else j!==a&&j.resolveWith(j,d?[a]:[]);return k}}),f.support=function(){var b,d,e,g,h,i,j,k,l,m,n,o,p=c.createElement("div"),q=c.documentElement;p.setAttribute("className","t"),p.innerHTML="   <link/><table></table><a href='/a' style='top:1px;float:left;opacity:.55;'>a</a><input type='checkbox'/>",d=p.getElementsByTagName("*"),e=p.getElementsByTagName("a")[0];if(!d||!d.length||!e)return{};g=c.createElement("select"),h=g.appendChild(c.createElement("option")),i=p.getElementsByTagName("input")[0],b={leadingWhitespace:p.firstChild.nodeType===3,tbody:!p.getElementsByTagName("tbody").length,htmlSerialize:!!p.getElementsByTagName("link").length,style:/top/.test(e.getAttribute("style")),hrefNormalized:e.getAttribute("href")==="/a",opacity:/^0.55/.test(e.style.opacity),cssFloat:!!e.style.cssFloat,checkOn:i.value==="on",optSelected:h.selected,getSetAttribute:p.className!=="t",enctype:!!c.createElement("form").enctype,html5Clone:c.createElement("nav").cloneNode(!0).outerHTML!=="<:nav></:nav>",submitBubbles:!0,changeBubbles:!0,focusinBubbles:!1,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0,pixelMargin:!0},f.boxModel=b.boxModel=c.compatMode==="CSS1Compat",i.checked=!0,b.noCloneChecked=i.cloneNode(!0).checked,g.disabled=!0,b.optDisabled=!h.disabled;try{delete p.test}catch(r){b.deleteExpando=!1}!p.addEventListener&&p.attachEvent&&p.fireEvent&&(p.attachEvent("onclick",function(){b.noCloneEvent=!1}),p.cloneNode(!0).fireEvent("onclick")),i=c.createElement("input"),i.value="t",i.setAttribute("type","radio"),b.radioValue=i.value==="t",i.setAttribute("checked","checked"),i.setAttribute("name","t"),p.appendChild(i),j=c.createDocumentFragment(),j.appendChild(p.lastChild),b.checkClone=j.cloneNode(!0).cloneNode(!0).lastChild.checked,b.appendChecked=i.checked,j.removeChild(i),j.appendChild(p);if(p.attachEvent)for(n in{submit:1,change:1,focusin:1})m="on"+n,o=m in p,o||(p.setAttribute(m,"return;"),o=typeof p[m]=="function"),b[n+"Bubbles"]=o;j.removeChild(p),j=g=h=p=i=null,f(function(){var d,e,g,h,i,j,l,m,n,q,r,s,t,u=c.getElementsByTagName("body")[0];!u||(m=1,t="padding:0;margin:0;border:",r="position:absolute;top:0;left:0;width:1px;height:1px;",s=t+"0;visibility:hidden;",n="style='"+r+t+"5px solid #000;",q="<div "+n+"display:block;'><div style='"+t+"0;display:block;overflow:hidden;'></div></div>"+"<table "+n+"' cellpadding='0' cellspacing='0'>"+"<tr><td></td></tr></table>",d=c.createElement("div"),d.style.cssText=s+"width:0;height:0;position:static;top:0;margin-top:"+m+"px",u.insertBefore(d,u.firstChild),p=c.createElement("div"),d.appendChild(p),p.innerHTML="<table><tr><td style='"+t+"0;display:none'></td><td>t</td></tr></table>",k=p.getElementsByTagName("td"),o=k[0].offsetHeight===0,k[0].style.display="",k[1].style.display="none",b.reliableHiddenOffsets=o&&k[0].offsetHeight===0,a.getComputedStyle&&(p.innerHTML="",l=c.createElement("div"),l.style.width="0",l.style.marginRight="0",p.style.width="2px",p.appendChild(l),b.reliableMarginRight=(parseInt((a.getComputedStyle(l,null)||{marginRight:0}).marginRight,10)||0)===0),typeof p.style.zoom!="undefined"&&(p.innerHTML="",p.style.width=p.style.padding="1px",p.style.border=0,p.style.overflow="hidden",p.style.display="inline",p.style.zoom=1,b.inlineBlockNeedsLayout=p.offsetWidth===3,p.style.display="block",p.style.overflow="visible",p.innerHTML="<div style='width:5px;'></div>",b.shrinkWrapBlocks=p.offsetWidth!==3),p.style.cssText=r+s,p.innerHTML=q,e=p.firstChild,g=e.firstChild,i=e.nextSibling.firstChild.firstChild,j={doesNotAddBorder:g.offsetTop!==5,doesAddBorderForTableAndCells:i.offsetTop===5},g.style.position="fixed",g.style.top="20px",j.fixedPosition=g.offsetTop===20||g.offsetTop===15,g.style.position=g.style.top="",e.style.overflow="hidden",e.style.position="relative",j.subtractsBorderForOverflowNotVisible=g.offsetTop===-5,j.doesNotIncludeMarginInBodyOffset=u.offsetTop!==m,a.getComputedStyle&&(p.style.marginTop="1%",b.pixelMargin=(a.getComputedStyle(p,null)||{marginTop:0}).marginTop!=="1%"),typeof d.style.zoom!="undefined"&&(d.style.zoom=1),u.removeChild(d),l=p=d=null,f.extend(b,j))});return b}();var j=/^(?:\{.*\}|\[.*\])$/,k=/([A-Z])/g;f.extend({cache:{},uuid:0,expando:"jQuery"+(f.fn.jquery+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(a){a=a.nodeType?f.cache[a[f.expando]]:a[f.expando];return!!a&&!m(a)},data:function(a,c,d,e){if(!!f.acceptData(a)){var g,h,i,j=f.expando,k=typeof c=="string",l=a.nodeType,m=l?f.cache:a,n=l?a[j]:a[j]&&j,o=c==="events";if((!n||!m[n]||!o&&!e&&!m[n].data)&&k&&d===b)return;n||(l?a[j]=n=++f.uuid:n=j),m[n]||(m[n]={},l||(m[n].toJSON=f.noop));if(typeof c=="object"||typeof c=="function")e?m[n]=f.extend(m[n],c):m[n].data=f.extend(m[n].data,c);g=h=m[n],e||(h.data||(h.data={}),h=h.data),d!==b&&(h[f.camelCase(c)]=d);if(o&&!h[c])return g.events;k?(i=h[c],i==null&&(i=h[f.camelCase(c)])):i=h;return i}},removeData:function(a,b,c){if(!!f.acceptData(a)){var d,e,g,h=f.expando,i=a.nodeType,j=i?f.cache:a,k=i?a[h]:h;if(!j[k])return;if(b){d=c?j[k]:j[k].data;if(d){f.isArray(b)||(b in d?b=[b]:(b=f.camelCase(b),b in d?b=[b]:b=b.split(" ")));for(e=0,g=b.length;e<g;e++)delete d[b[e]];if(!(c?m:f.isEmptyObject)(d))return}}if(!c){delete j[k].data;if(!m(j[k]))return}f.support.deleteExpando||!j.setInterval?delete j[k]:j[k]=null,i&&(f.support.deleteExpando?delete a[h]:a.removeAttribute?a.removeAttribute(h):a[h]=null)}},_data:function(a,b,c){return f.data(a,b,c,!0)},acceptData:function(a){if(a.nodeName){var b=f.noData[a.nodeName.toLowerCase()];if(b)return b!==!0&&a.getAttribute("classid")===b}return!0}}),f.fn.extend({data:function(a,c){var d,e,g,h,i,j=this[0],k=0,m=null;if(a===b){if(this.length){m=f.data(j);if(j.nodeType===1&&!f._data(j,"parsedAttrs")){g=j.attributes;for(i=g.length;k<i;k++)h=g[k].name,h.indexOf("data-")===0&&(h=f.camelCase(h.substring(5)),l(j,h,m[h]));f._data(j,"parsedAttrs",!0)}}return m}if(typeof a=="object")return this.each(function(){f.data(this,a)});d=a.split(".",2),d[1]=d[1]?"."+d[1]:"",e=d[1]+"!";return f.access(this,function(c){if(c===b){m=this.triggerHandler("getData"+e,[d[0]]),m===b&&j&&(m=f.data(j,a),m=l(j,a,m));return m===b&&d[1]?this.data(d[0]):m}d[1]=c,this.each(function(){var b=f(this);b.triggerHandler("setData"+e,d),f.data(this,a,c),b.triggerHandler("changeData"+e,d)})},null,c,arguments.length>1,null,!1)},removeData:function(a){return this.each(function(){f.removeData(this,a)})}}),f.extend({_mark:function(a,b){a&&(b=(b||"fx")+"mark",f._data(a,b,(f._data(a,b)||0)+1))},_unmark:function(a,b,c){a!==!0&&(c=b,b=a,a=!1);if(b){c=c||"fx";var d=c+"mark",e=a?0:(f._data(b,d)||1)-1;e?f._data(b,d,e):(f.removeData(b,d,!0),n(b,c,"mark"))}},queue:function(a,b,c){var d;if(a){b=(b||"fx")+"queue",d=f._data(a,b),c&&(!d||f.isArray(c)?d=f._data(a,b,f.makeArray(c)):d.push(c));return d||[]}},dequeue:function(a,b){b=b||"fx";var c=f.queue(a,b),d=c.shift(),e={};d==="inprogress"&&(d=c.shift()),d&&(b==="fx"&&c.unshift("inprogress"),f._data(a,b+".run",e),d.call(a,function(){f.dequeue(a,b)},e)),c.length||(f.removeData(a,b+"queue "+b+".run",!0),n(a,b,"queue"))}}),f.fn.extend({queue:function(a,c){var d=2;typeof a!="string"&&(c=a,a="fx",d--);if(arguments.length<d)return f.queue(this[0],a);return c===b?this:this.each(function(){var b=f.queue(this,a,c);a==="fx"&&b[0]!=="inprogress"&&f.dequeue(this,a)})},dequeue:function(a){return this.each(function(){f.dequeue(this,a)})},delay:function(a,b){a=f.fx?f.fx.speeds[a]||a:a,b=b||"fx";return this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,c){function m(){--h||d.resolveWith(e,[e])}typeof a!="string"&&(c=a,a=b),a=a||"fx";var d=f.Deferred(),e=this,g=e.length,h=1,i=a+"defer",j=a+"queue",k=a+"mark",l;while(g--)if(l=f.data(e[g],i,b,!0)||(f.data(e[g],j,b,!0)||f.data(e[g],k,b,!0))&&f.data(e[g],i,f.Callbacks("once memory"),!0))h++,l.add(m);m();return d.promise(c)}});var o=/[\n\t\r]/g,p=/\s+/,q=/\r/g,r=/^(?:button|input)$/i,s=/^(?:button|input|object|select|textarea)$/i,t=/^a(?:rea)?$/i,u=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,v=f.support.getSetAttribute,w,x,y;f.fn.extend({attr:function(a,b){return f.access(this,f.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){f.removeAttr(this,a)})},prop:function(a,b){return f.access(this,f.prop,a,b,arguments.length>1)},removeProp:function(a){a=f.propFix[a]||a;return this.each(function(){try{this[a]=b,delete this[a]}catch(c){}})},addClass:function(a){var b,c,d,e,g,h,i;if(f.isFunction(a))return this.each(function(b){f(this).addClass(a.call(this,b,this.className))});if(a&&typeof a=="string"){b=a.split(p);for(c=0,d=this.length;c<d;c++){e=this[c];if(e.nodeType===1)if(!e.className&&b.length===1)e.className=a;else{g=" "+e.className+" ";for(h=0,i=b.length;h<i;h++)~g.indexOf(" "+b[h]+" ")||(g+=b[h]+" ");e.className=f.trim(g)}}}return this},removeClass:function(a){var c,d,e,g,h,i,j;if(f.isFunction(a))return this.each(function(b){f(this).removeClass(a.call(this,b,this.className))});if(a&&typeof a=="string"||a===b){c=(a||"").split(p);for(d=0,e=this.length;d<e;d++){g=this[d];if(g.nodeType===1&&g.className)if(a){h=(" "+g.className+" ").replace(o," ");for(i=0,j=c.length;i<j;i++)h=h.replace(" "+c[i]+" "," ");g.className=f.trim(h)}else g.className=""}}return this},toggleClass:function(a,b){var c=typeof a,d=typeof b=="boolean";if(f.isFunction(a))return this.each(function(c){f(this).toggleClass(a.call(this,c,this.className,b),b)});return this.each(function(){if(c==="string"){var e,g=0,h=f(this),i=b,j=a.split(p);while(e=j[g++])i=d?i:!h.hasClass(e),h[i?"addClass":"removeClass"](e)}else if(c==="undefined"||c==="boolean")this.className&&f._data(this,"__className__",this.className),this.className=this.className||a===!1?"":f._data(this,"__className__")||""})},hasClass:function(a){var b=" "+a+" ",c=0,d=this.length;for(;c<d;c++)if(this[c].nodeType===1&&(" "+this[c].className+" ").replace(o," ").indexOf(b)>-1)return!0;return!1},val:function(a){var c,d,e,g=this[0];{if(!!arguments.length){e=f.isFunction(a);return this.each(function(d){var g=f(this),h;if(this.nodeType===1){e?h=a.call(this,d,g.val()):h=a,h==null?h="":typeof h=="number"?h+="":f.isArray(h)&&(h=f.map(h,function(a){return a==null?"":a+""})),c=f.valHooks[this.type]||f.valHooks[this.nodeName.toLowerCase()];if(!c||!("set"in c)||c.set(this,h,"value")===b)this.value=h}})}if(g){c=f.valHooks[g.type]||f.valHooks[g.nodeName.toLowerCase()];if(c&&"get"in c&&(d=c.get(g,"value"))!==b)return d;d=g.value;return typeof d=="string"?d.replace(q,""):d==null?"":d}}}}),f.extend({valHooks:{option:{get:function(a){var b=a.attributes.value;return!b||b.specified?a.value:a.text}},select:{get:function(a){var b,c,d,e,g=a.selectedIndex,h=[],i=a.options,j=a.type==="select-one";if(g<0)return null;c=j?g:0,d=j?g+1:i.length;for(;c<d;c++){e=i[c];if(e.selected&&(f.support.optDisabled?!e.disabled:e.getAttribute("disabled")===null)&&(!e.parentNode.disabled||!f.nodeName(e.parentNode,"optgroup"))){b=f(e).val();if(j)return b;h.push(b)}}if(j&&!h.length&&i.length)return f(i[g]).val();return h},set:function(a,b){var c=f.makeArray(b);f(a).find("option").each(function(){this.selected=f.inArray(f(this).val(),c)>=0}),c.length||(a.selectedIndex=-1);return c}}},attrFn:{val:!0,css:!0,html:!0,text:!0,data:!0,width:!0,height:!0,offset:!0},attr:function(a,c,d,e){var g,h,i,j=a.nodeType;if(!!a&&j!==3&&j!==8&&j!==2){if(e&&c in f.attrFn)return f(a)[c](d);if(typeof a.getAttribute=="undefined")return f.prop(a,c,d);i=j!==1||!f.isXMLDoc(a),i&&(c=c.toLowerCase(),h=f.attrHooks[c]||(u.test(c)?x:w));if(d!==b){if(d===null){f.removeAttr(a,c);return}if(h&&"set"in h&&i&&(g=h.set(a,d,c))!==b)return g;a.setAttribute(c,""+d);return d}if(h&&"get"in h&&i&&(g=h.get(a,c))!==null)return g;g=a.getAttribute(c);return g===null?b:g}},removeAttr:function(a,b){var c,d,e,g,h,i=0;if(b&&a.nodeType===1){d=b.toLowerCase().split(p),g=d.length;for(;i<g;i++)e=d[i],e&&(c=f.propFix[e]||e,h=u.test(e),h||f.attr(a,e,""),a.removeAttribute(v?e:c),h&&c in a&&(a[c]=!1))}},attrHooks:{type:{set:function(a,b){if(r.test(a.nodeName)&&a.parentNode)f.error("type property can't be changed");else if(!f.support.radioValue&&b==="radio"&&f.nodeName(a,"input")){var c=a.value;a.setAttribute("type",b),c&&(a.value=c);return b}}},value:{get:function(a,b){if(w&&f.nodeName(a,"button"))return w.get(a,b);return b in a?a.value:null},set:function(a,b,c){if(w&&f.nodeName(a,"button"))return w.set(a,b,c);a.value=b}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(a,c,d){var e,g,h,i=a.nodeType;if(!!a&&i!==3&&i!==8&&i!==2){h=i!==1||!f.isXMLDoc(a),h&&(c=f.propFix[c]||c,g=f.propHooks[c]);return d!==b?g&&"set"in g&&(e=g.set(a,d,c))!==b?e:a[c]=d:g&&"get"in g&&(e=g.get(a,c))!==null?e:a[c]}},propHooks:{tabIndex:{get:function(a){var c=a.getAttributeNode("tabindex");return c&&c.specified?parseInt(c.value,10):s.test(a.nodeName)||t.test(a.nodeName)&&a.href?0:b}}}}),f.attrHooks.tabindex=f.propHooks.tabIndex,x={get:function(a,c){var d,e=f.prop(a,c);return e===!0||typeof e!="boolean"&&(d=a.getAttributeNode(c))&&d.nodeValue!==!1?c.toLowerCase():b},set:function(a,b,c){var d;b===!1?f.removeAttr(a,c):(d=f.propFix[c]||c,d in a&&(a[d]=!0),a.setAttribute(c,c.toLowerCase()));return c}},v||(y={name:!0,id:!0,coords:!0},w=f.valHooks.button={get:function(a,c){var d;d=a.getAttributeNode(c);return d&&(y[c]?d.nodeValue!=="":d.specified)?d.nodeValue:b},set:function(a,b,d){var e=a.getAttributeNode(d);e||(e=c.createAttribute(d),a.setAttributeNode(e));return e.nodeValue=b+""}},f.attrHooks.tabindex.set=w.set,f.each(["width","height"],function(a,b){f.attrHooks[b]=f.extend(f.attrHooks[b],{set:function(a,c){if(c===""){a.setAttribute(b,"auto");return c}}})}),f.attrHooks.contenteditable={get:w.get,set:function(a,b,c){b===""&&(b="false"),w.set(a,b,c)}}),f.support.hrefNormalized||f.each(["href","src","width","height"],function(a,c){f.attrHooks[c]=f.extend(f.attrHooks[c],{get:function(a){var d=a.getAttribute(c,2);return d===null?b:d}})}),f.support.style||(f.attrHooks.style={get:function(a){return a.style.cssText.toLowerCase()||b},set:function(a,b){return a.style.cssText=""+b}}),f.support.optSelected||(f.propHooks.selected=f.extend(f.propHooks.selected,{get:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex);return null}})),f.support.enctype||(f.propFix.enctype="encoding"),f.support.checkOn||f.each(["radio","checkbox"],function(){f.valHooks[this]={get:function(a){return a.getAttribute("value")===null?"on":a.value}}}),f.each(["radio","checkbox"],function(){f.valHooks[this]=f.extend(f.valHooks[this],{set:function(a,b){if(f.isArray(b))return a.checked=f.inArray(f(a).val(),b)>=0}})});var z=/^(?:textarea|input|select)$/i,A=/^([^\.]*)?(?:\.(.+))?$/,B=/(?:^|\s)hover(\.\S+)?\b/,C=/^key/,D=/^(?:mouse|contextmenu)|click/,E=/^(?:focusinfocus|focusoutblur)$/,F=/^(\w*)(?:#([\w\-]+))?(?:\.([\w\-]+))?$/,G=function(
a){var b=F.exec(a);b&&(b[1]=(b[1]||"").toLowerCase(),b[3]=b[3]&&new RegExp("(?:^|\\s)"+b[3]+"(?:\\s|$)"));return b},H=function(a,b){var c=a.attributes||{};return(!b[1]||a.nodeName.toLowerCase()===b[1])&&(!b[2]||(c.id||{}).value===b[2])&&(!b[3]||b[3].test((c["class"]||{}).value))},I=function(a){return f.event.special.hover?a:a.replace(B,"mouseenter$1 mouseleave$1")};f.event={add:function(a,c,d,e,g){var h,i,j,k,l,m,n,o,p,q,r,s;if(!(a.nodeType===3||a.nodeType===8||!c||!d||!(h=f._data(a)))){d.handler&&(p=d,d=p.handler,g=p.selector),d.guid||(d.guid=f.guid++),j=h.events,j||(h.events=j={}),i=h.handle,i||(h.handle=i=function(a){return typeof f!="undefined"&&(!a||f.event.triggered!==a.type)?f.event.dispatch.apply(i.elem,arguments):b},i.elem=a),c=f.trim(I(c)).split(" ");for(k=0;k<c.length;k++){l=A.exec(c[k])||[],m=l[1],n=(l[2]||"").split(".").sort(),s=f.event.special[m]||{},m=(g?s.delegateType:s.bindType)||m,s=f.event.special[m]||{},o=f.extend({type:m,origType:l[1],data:e,handler:d,guid:d.guid,selector:g,quick:g&&G(g),namespace:n.join(".")},p),r=j[m];if(!r){r=j[m]=[],r.delegateCount=0;if(!s.setup||s.setup.call(a,e,n,i)===!1)a.addEventListener?a.addEventListener(m,i,!1):a.attachEvent&&a.attachEvent("on"+m,i)}s.add&&(s.add.call(a,o),o.handler.guid||(o.handler.guid=d.guid)),g?r.splice(r.delegateCount++,0,o):r.push(o),f.event.global[m]=!0}a=null}},global:{},remove:function(a,b,c,d,e){var g=f.hasData(a)&&f._data(a),h,i,j,k,l,m,n,o,p,q,r,s;if(!!g&&!!(o=g.events)){b=f.trim(I(b||"")).split(" ");for(h=0;h<b.length;h++){i=A.exec(b[h])||[],j=k=i[1],l=i[2];if(!j){for(j in o)f.event.remove(a,j+b[h],c,d,!0);continue}p=f.event.special[j]||{},j=(d?p.delegateType:p.bindType)||j,r=o[j]||[],m=r.length,l=l?new RegExp("(^|\\.)"+l.split(".").sort().join("\\.(?:.*\\.)?")+"(\\.|$)"):null;for(n=0;n<r.length;n++)s=r[n],(e||k===s.origType)&&(!c||c.guid===s.guid)&&(!l||l.test(s.namespace))&&(!d||d===s.selector||d==="**"&&s.selector)&&(r.splice(n--,1),s.selector&&r.delegateCount--,p.remove&&p.remove.call(a,s));r.length===0&&m!==r.length&&((!p.teardown||p.teardown.call(a,l)===!1)&&f.removeEvent(a,j,g.handle),delete o[j])}f.isEmptyObject(o)&&(q=g.handle,q&&(q.elem=null),f.removeData(a,["events","handle"],!0))}},customEvent:{getData:!0,setData:!0,changeData:!0},trigger:function(c,d,e,g){if(!e||e.nodeType!==3&&e.nodeType!==8){var h=c.type||c,i=[],j,k,l,m,n,o,p,q,r,s;if(E.test(h+f.event.triggered))return;h.indexOf("!")>=0&&(h=h.slice(0,-1),k=!0),h.indexOf(".")>=0&&(i=h.split("."),h=i.shift(),i.sort());if((!e||f.event.customEvent[h])&&!f.event.global[h])return;c=typeof c=="object"?c[f.expando]?c:new f.Event(h,c):new f.Event(h),c.type=h,c.isTrigger=!0,c.exclusive=k,c.namespace=i.join("."),c.namespace_re=c.namespace?new RegExp("(^|\\.)"+i.join("\\.(?:.*\\.)?")+"(\\.|$)"):null,o=h.indexOf(":")<0?"on"+h:"";if(!e){j=f.cache;for(l in j)j[l].events&&j[l].events[h]&&f.event.trigger(c,d,j[l].handle.elem,!0);return}c.result=b,c.target||(c.target=e),d=d!=null?f.makeArray(d):[],d.unshift(c),p=f.event.special[h]||{};if(p.trigger&&p.trigger.apply(e,d)===!1)return;r=[[e,p.bindType||h]];if(!g&&!p.noBubble&&!f.isWindow(e)){s=p.delegateType||h,m=E.test(s+h)?e:e.parentNode,n=null;for(;m;m=m.parentNode)r.push([m,s]),n=m;n&&n===e.ownerDocument&&r.push([n.defaultView||n.parentWindow||a,s])}for(l=0;l<r.length&&!c.isPropagationStopped();l++)m=r[l][0],c.type=r[l][1],q=(f._data(m,"events")||{})[c.type]&&f._data(m,"handle"),q&&q.apply(m,d),q=o&&m[o],q&&f.acceptData(m)&&q.apply(m,d)===!1&&c.preventDefault();c.type=h,!g&&!c.isDefaultPrevented()&&(!p._default||p._default.apply(e.ownerDocument,d)===!1)&&(h!=="click"||!f.nodeName(e,"a"))&&f.acceptData(e)&&o&&e[h]&&(h!=="focus"&&h!=="blur"||c.target.offsetWidth!==0)&&!f.isWindow(e)&&(n=e[o],n&&(e[o]=null),f.event.triggered=h,e[h](),f.event.triggered=b,n&&(e[o]=n));return c.result}},dispatch:function(c){c=f.event.fix(c||a.event);var d=(f._data(this,"events")||{})[c.type]||[],e=d.delegateCount,g=[].slice.call(arguments,0),h=!c.exclusive&&!c.namespace,i=f.event.special[c.type]||{},j=[],k,l,m,n,o,p,q,r,s,t,u;g[0]=c,c.delegateTarget=this;if(!i.preDispatch||i.preDispatch.call(this,c)!==!1){if(e&&(!c.button||c.type!=="click")){n=f(this),n.context=this.ownerDocument||this;for(m=c.target;m!=this;m=m.parentNode||this)if(m.disabled!==!0){p={},r=[],n[0]=m;for(k=0;k<e;k++)s=d[k],t=s.selector,p[t]===b&&(p[t]=s.quick?H(m,s.quick):n.is(t)),p[t]&&r.push(s);r.length&&j.push({elem:m,matches:r})}}d.length>e&&j.push({elem:this,matches:d.slice(e)});for(k=0;k<j.length&&!c.isPropagationStopped();k++){q=j[k],c.currentTarget=q.elem;for(l=0;l<q.matches.length&&!c.isImmediatePropagationStopped();l++){s=q.matches[l];if(h||!c.namespace&&!s.namespace||c.namespace_re&&c.namespace_re.test(s.namespace))c.data=s.data,c.handleObj=s,o=((f.event.special[s.origType]||{}).handle||s.handler).apply(q.elem,g),o!==b&&(c.result=o,o===!1&&(c.preventDefault(),c.stopPropagation()))}}i.postDispatch&&i.postDispatch.call(this,c);return c.result}},props:"attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){a.which==null&&(a.which=b.charCode!=null?b.charCode:b.keyCode);return a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,d){var e,f,g,h=d.button,i=d.fromElement;a.pageX==null&&d.clientX!=null&&(e=a.target.ownerDocument||c,f=e.documentElement,g=e.body,a.pageX=d.clientX+(f&&f.scrollLeft||g&&g.scrollLeft||0)-(f&&f.clientLeft||g&&g.clientLeft||0),a.pageY=d.clientY+(f&&f.scrollTop||g&&g.scrollTop||0)-(f&&f.clientTop||g&&g.clientTop||0)),!a.relatedTarget&&i&&(a.relatedTarget=i===a.target?d.toElement:i),!a.which&&h!==b&&(a.which=h&1?1:h&2?3:h&4?2:0);return a}},fix:function(a){if(a[f.expando])return a;var d,e,g=a,h=f.event.fixHooks[a.type]||{},i=h.props?this.props.concat(h.props):this.props;a=f.Event(g);for(d=i.length;d;)e=i[--d],a[e]=g[e];a.target||(a.target=g.srcElement||c),a.target.nodeType===3&&(a.target=a.target.parentNode),a.metaKey===b&&(a.metaKey=a.ctrlKey);return h.filter?h.filter(a,g):a},special:{ready:{setup:f.bindReady},load:{noBubble:!0},focus:{delegateType:"focusin"},blur:{delegateType:"focusout"},beforeunload:{setup:function(a,b,c){f.isWindow(this)&&(this.onbeforeunload=c)},teardown:function(a,b){this.onbeforeunload===b&&(this.onbeforeunload=null)}}},simulate:function(a,b,c,d){var e=f.extend(new f.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?f.event.trigger(e,null,b):f.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},f.event.handle=f.event.dispatch,f.removeEvent=c.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)}:function(a,b,c){a.detachEvent&&a.detachEvent("on"+b,c)},f.Event=function(a,b){if(!(this instanceof f.Event))return new f.Event(a,b);a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||a.returnValue===!1||a.getPreventDefault&&a.getPreventDefault()?K:J):this.type=a,b&&f.extend(this,b),this.timeStamp=a&&a.timeStamp||f.now(),this[f.expando]=!0},f.Event.prototype={preventDefault:function(){this.isDefaultPrevented=K;var a=this.originalEvent;!a||(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){this.isPropagationStopped=K;var a=this.originalEvent;!a||(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=K,this.stopPropagation()},isDefaultPrevented:J,isPropagationStopped:J,isImmediatePropagationStopped:J},f.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){f.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c=this,d=a.relatedTarget,e=a.handleObj,g=e.selector,h;if(!d||d!==c&&!f.contains(c,d))a.type=e.origType,h=e.handler.apply(this,arguments),a.type=b;return h}}}),f.support.submitBubbles||(f.event.special.submit={setup:function(){if(f.nodeName(this,"form"))return!1;f.event.add(this,"click._submit keypress._submit",function(a){var c=a.target,d=f.nodeName(c,"input")||f.nodeName(c,"button")?c.form:b;d&&!d._submit_attached&&(f.event.add(d,"submit._submit",function(a){a._submit_bubble=!0}),d._submit_attached=!0)})},postDispatch:function(a){a._submit_bubble&&(delete a._submit_bubble,this.parentNode&&!a.isTrigger&&f.event.simulate("submit",this.parentNode,a,!0))},teardown:function(){if(f.nodeName(this,"form"))return!1;f.event.remove(this,"._submit")}}),f.support.changeBubbles||(f.event.special.change={setup:function(){if(z.test(this.nodeName)){if(this.type==="checkbox"||this.type==="radio")f.event.add(this,"propertychange._change",function(a){a.originalEvent.propertyName==="checked"&&(this._just_changed=!0)}),f.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1,f.event.simulate("change",this,a,!0))});return!1}f.event.add(this,"beforeactivate._change",function(a){var b=a.target;z.test(b.nodeName)&&!b._change_attached&&(f.event.add(b,"change._change",function(a){this.parentNode&&!a.isSimulated&&!a.isTrigger&&f.event.simulate("change",this.parentNode,a,!0)}),b._change_attached=!0)})},handle:function(a){var b=a.target;if(this!==b||a.isSimulated||a.isTrigger||b.type!=="radio"&&b.type!=="checkbox")return a.handleObj.handler.apply(this,arguments)},teardown:function(){f.event.remove(this,"._change");return z.test(this.nodeName)}}),f.support.focusinBubbles||f.each({focus:"focusin",blur:"focusout"},function(a,b){var d=0,e=function(a){f.event.simulate(b,a.target,f.event.fix(a),!0)};f.event.special[b]={setup:function(){d++===0&&c.addEventListener(a,e,!0)},teardown:function(){--d===0&&c.removeEventListener(a,e,!0)}}}),f.fn.extend({on:function(a,c,d,e,g){var h,i;if(typeof a=="object"){typeof c!="string"&&(d=d||c,c=b);for(i in a)this.on(i,c,d,a[i],g);return this}d==null&&e==null?(e=c,d=c=b):e==null&&(typeof c=="string"?(e=d,d=b):(e=d,d=c,c=b));if(e===!1)e=J;else if(!e)return this;g===1&&(h=e,e=function(a){f().off(a);return h.apply(this,arguments)},e.guid=h.guid||(h.guid=f.guid++));return this.each(function(){f.event.add(this,a,e,d,c)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,c,d){if(a&&a.preventDefault&&a.handleObj){var e=a.handleObj;f(a.delegateTarget).off(e.namespace?e.origType+"."+e.namespace:e.origType,e.selector,e.handler);return this}if(typeof a=="object"){for(var g in a)this.off(g,c,a[g]);return this}if(c===!1||typeof c=="function")d=c,c=b;d===!1&&(d=J);return this.each(function(){f.event.remove(this,a,d,c)})},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},live:function(a,b,c){f(this.context).on(a,this.selector,b,c);return this},die:function(a,b){f(this.context).off(a,this.selector||"**",b);return this},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return arguments.length==1?this.off(a,"**"):this.off(b,a,c)},trigger:function(a,b){return this.each(function(){f.event.trigger(a,b,this)})},triggerHandler:function(a,b){if(this[0])return f.event.trigger(a,b,this[0],!0)},toggle:function(a){var b=arguments,c=a.guid||f.guid++,d=0,e=function(c){var e=(f._data(this,"lastToggle"+a.guid)||0)%d;f._data(this,"lastToggle"+a.guid,e+1),c.preventDefault();return b[e].apply(this,arguments)||!1};e.guid=c;while(d<b.length)b[d++].guid=c;return this.click(e)},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),f.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){f.fn[b]=function(a,c){c==null&&(c=a,a=null);return arguments.length>0?this.on(b,null,a,c):this.trigger(b)},f.attrFn&&(f.attrFn[b]=!0),C.test(b)&&(f.event.fixHooks[b]=f.event.keyHooks),D.test(b)&&(f.event.fixHooks[b]=f.event.mouseHooks)}),function(){function x(a,b,c,e,f,g){for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j){var k=!1;j=j[a];while(j){if(j[d]===c){k=e[j.sizset];break}if(j.nodeType===1){g||(j[d]=c,j.sizset=h);if(typeof b!="string"){if(j===b){k=!0;break}}else if(m.filter(b,[j]).length>0){k=j;break}}j=j[a]}e[h]=k}}}function w(a,b,c,e,f,g){for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j){var k=!1;j=j[a];while(j){if(j[d]===c){k=e[j.sizset];break}j.nodeType===1&&!g&&(j[d]=c,j.sizset=h);if(j.nodeName.toLowerCase()===b){k=j;break}j=j[a]}e[h]=k}}}var a=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,d="sizcache"+(Math.random()+"").replace(".",""),e=0,g=Object.prototype.toString,h=!1,i=!0,j=/\\/g,k=/\r\n/g,l=/\W/;[0,0].sort(function(){i=!1;return 0});var m=function(b,d,e,f){e=e||[],d=d||c;var h=d;if(d.nodeType!==1&&d.nodeType!==9)return[];if(!b||typeof b!="string")return e;var i,j,k,l,n,q,r,t,u=!0,v=m.isXML(d),w=[],x=b;do{a.exec(""),i=a.exec(x);if(i){x=i[3],w.push(i[1]);if(i[2]){l=i[3];break}}}while(i);if(w.length>1&&p.exec(b))if(w.length===2&&o.relative[w[0]])j=y(w[0]+w[1],d,f);else{j=o.relative[w[0]]?[d]:m(w.shift(),d);while(w.length)b=w.shift(),o.relative[b]&&(b+=w.shift()),j=y(b,j,f)}else{!f&&w.length>1&&d.nodeType===9&&!v&&o.match.ID.test(w[0])&&!o.match.ID.test(w[w.length-1])&&(n=m.find(w.shift(),d,v),d=n.expr?m.filter(n.expr,n.set)[0]:n.set[0]);if(d){n=f?{expr:w.pop(),set:s(f)}:m.find(w.pop(),w.length===1&&(w[0]==="~"||w[0]==="+")&&d.parentNode?d.parentNode:d,v),j=n.expr?m.filter(n.expr,n.set):n.set,w.length>0?k=s(j):u=!1;while(w.length)q=w.pop(),r=q,o.relative[q]?r=w.pop():q="",r==null&&(r=d),o.relative[q](k,r,v)}else k=w=[]}k||(k=j),k||m.error(q||b);if(g.call(k)==="[object Array]")if(!u)e.push.apply(e,k);else if(d&&d.nodeType===1)for(t=0;k[t]!=null;t++)k[t]&&(k[t]===!0||k[t].nodeType===1&&m.contains(d,k[t]))&&e.push(j[t]);else for(t=0;k[t]!=null;t++)k[t]&&k[t].nodeType===1&&e.push(j[t]);else s(k,e);l&&(m(l,h,e,f),m.uniqueSort(e));return e};m.uniqueSort=function(a){if(u){h=i,a.sort(u);if(h)for(var b=1;b<a.length;b++)a[b]===a[b-1]&&a.splice(b--,1)}return a},m.matches=function(a,b){return m(a,null,null,b)},m.matchesSelector=function(a,b){return m(b,null,null,[a]).length>0},m.find=function(a,b,c){var d,e,f,g,h,i;if(!a)return[];for(e=0,f=o.order.length;e<f;e++){h=o.order[e];if(g=o.leftMatch[h].exec(a)){i=g[1],g.splice(1,1);if(i.substr(i.length-1)!=="\\"){g[1]=(g[1]||"").replace(j,""),d=o.find[h](g,b,c);if(d!=null){a=a.replace(o.match[h],"");break}}}}d||(d=typeof b.getElementsByTagName!="undefined"?b.getElementsByTagName("*"):[]);return{set:d,expr:a}},m.filter=function(a,c,d,e){var f,g,h,i,j,k,l,n,p,q=a,r=[],s=c,t=c&&c[0]&&m.isXML(c[0]);while(a&&c.length){for(h in o.filter)if((f=o.leftMatch[h].exec(a))!=null&&f[2]){k=o.filter[h],l=f[1],g=!1,f.splice(1,1);if(l.substr(l.length-1)==="\\")continue;s===r&&(r=[]);if(o.preFilter[h]){f=o.preFilter[h](f,s,d,r,e,t);if(!f)g=i=!0;else if(f===!0)continue}if(f)for(n=0;(j=s[n])!=null;n++)j&&(i=k(j,f,n,s),p=e^i,d&&i!=null?p?g=!0:s[n]=!1:p&&(r.push(j),g=!0));if(i!==b){d||(s=r),a=a.replace(o.match[h],"");if(!g)return[];break}}if(a===q)if(g==null)m.error(a);else break;q=a}return s},m.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)};var n=m.getText=function(a){var b,c,d=a.nodeType,e="";if(d){if(d===1||d===9||d===11){if(typeof a.textContent=="string")return a.textContent;if(typeof a.innerText=="string")return a.innerText.replace(k,"");for(a=a.firstChild;a;a=a.nextSibling)e+=n(a)}else if(d===3||d===4)return a.nodeValue}else for(b=0;c=a[b];b++)c.nodeType!==8&&(e+=n(c));return e},o=m.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(a){return a.getAttribute("href")},type:function(a){return a.getAttribute("type")}},relative:{"+":function(a,b){var c=typeof b=="string",d=c&&!l.test(b),e=c&&!d;d&&(b=b.toLowerCase());for(var f=0,g=a.length,h;f<g;f++)if(h=a[f]){while((h=h.previousSibling)&&h.nodeType!==1);a[f]=e||h&&h.nodeName.toLowerCase()===b?h||!1:h===b}e&&m.filter(b,a,!0)},">":function(a,b){var c,d=typeof b=="string",e=0,f=a.length;if(d&&!l.test(b)){b=b.toLowerCase();for(;e<f;e++){c=a[e];if(c){var g=c.parentNode;a[e]=g.nodeName.toLowerCase()===b?g:!1}}}else{for(;e<f;e++)c=a[e],c&&(a[e]=d?c.parentNode:c.parentNode===b);d&&m.filter(b,a,!0)}},"":function(a,b,c){var d,f=e++,g=x;typeof b=="string"&&!l.test(b)&&(b=b.toLowerCase(),d=b,g=w),g("parentNode",b,f,a,d,c)},"~":function(a,b,c){var d,f=e++,g=x;typeof b=="string"&&!l.test(b)&&(b=b.toLowerCase(),d=b,g=w),g("previousSibling",b,f,a,d,c)}},find:{ID:function(a,b,c){if(typeof b.getElementById!="undefined"&&!c){var d=b.getElementById(a[1]);return d&&d.parentNode?[d]:[]}},NAME:function(a,b){if(typeof b.getElementsByName!="undefined"){var c=[],d=b.getElementsByName(a[1]);for(var e=0,f=d.length;e<f;e++)d[e].getAttribute("name")===a[1]&&c.push(d[e]);return c.length===0?null:c}},TAG:function(a,b){if(typeof b.getElementsByTagName!="undefined")return b.getElementsByTagName(a[1])}},preFilter:{CLASS:function(a,b,c,d,e,f){a=" "+a[1].replace(j,"")+" ";if(f)return a;for(var g=0,h;(h=b[g])!=null;g++)h&&(e^(h.className&&(" "+h.className+" ").replace(/[\t\n\r]/g," ").indexOf(a)>=0)?c||d.push(h):c&&(b[g]=!1));return!1},ID:function(a){return a[1].replace(j,"")},TAG:function(a,b){return a[1].replace(j,"").toLowerCase()},CHILD:function(a){if(a[1]==="nth"){a[2]||m.error(a[0]),a[2]=a[2].replace(/^\+|\s*/g,"");var b=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(a[2]==="even"&&"2n"||a[2]==="odd"&&"2n+1"||!/\D/.test(a[2])&&"0n+"+a[2]||a[2]);a[2]=b[1]+(b[2]||1)-0,a[3]=b[3]-0}else a[2]&&m.error(a[0]);a[0]=e++;return a},ATTR:function(a,b,c,d,e,f){var g=a[1]=a[1].replace(j,"");!f&&o.attrMap[g]&&(a[1]=o.attrMap[g]),a[4]=(a[4]||a[5]||"").replace(j,""),a[2]==="~="&&(a[4]=" "+a[4]+" ");return a},PSEUDO:function(b,c,d,e,f){if(b[1]==="not")if((a.exec(b[3])||"").length>1||/^\w/.test(b[3]))b[3]=m(b[3],null,null,c);else{var g=m.filter(b[3],c,d,!0^f);d||e.push.apply(e,g);return!1}else if(o.match.POS.test(b[0])||o.match.CHILD.test(b[0]))return!0;return b},POS:function(a){a.unshift(!0);return a}},filters:{enabled:function(a){return a.disabled===!1&&a.type!=="hidden"},disabled:function(a){return a.disabled===!0},checked:function(a){return a.checked===!0},selected:function(a){a.parentNode&&a.parentNode.selectedIndex;return a.selected===!0},parent:function(a){return!!a.firstChild},empty:function(a){return!a.firstChild},has:function(a,b,c){return!!m(c[3],a).length},header:function(a){return/h\d/i.test(a.nodeName)},text:function(a){var b=a.getAttribute("type"),c=a.type;return a.nodeName.toLowerCase()==="input"&&"text"===c&&(b===c||b===null)},radio:function(a){return a.nodeName.toLowerCase()==="input"&&"radio"===a.type},checkbox:function(a){return a.nodeName.toLowerCase()==="input"&&"checkbox"===a.type},file:function(a){return a.nodeName.toLowerCase()==="input"&&"file"===a.type},password:function(a){return a.nodeName.toLowerCase()==="input"&&"password"===a.type},submit:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"submit"===a.type},image:function(a){return a.nodeName.toLowerCase()==="input"&&"image"===a.type},reset:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"reset"===a.type},button:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&"button"===a.type||b==="button"},input:function(a){return/input|select|textarea|button/i.test(a.nodeName)},focus:function(a){return a===a.ownerDocument.activeElement}},setFilters:{first:function(a,b){return b===0},last:function(a,b,c,d){return b===d.length-1},even:function(a,b){return b%2===0},odd:function(a,b){return b%2===1},lt:function(a,b,c){return b<c[3]-0},gt:function(a,b,c){return b>c[3]-0},nth:function(a,b,c){return c[3]-0===b},eq:function(a,b,c){return c[3]-0===b}},filter:{PSEUDO:function(a,b,c,d){var e=b[1],f=o.filters[e];if(f)return f(a,c,b,d);if(e==="contains")return(a.textContent||a.innerText||n([a])||"").indexOf(b[3])>=0;if(e==="not"){var g=b[3];for(var h=0,i=g.length;h<i;h++)if(g[h]===a)return!1;return!0}m.error(e)},CHILD:function(a,b){var c,e,f,g,h,i,j,k=b[1],l=a;switch(k){case"only":case"first":while(l=l.previousSibling)if(l.nodeType===1)return!1;if(k==="first")return!0;l=a;case"last":while(l=l.nextSibling)if(l.nodeType===1)return!1;return!0;case"nth":c=b[2],e=b[3];if(c===1&&e===0)return!0;f=b[0],g=a.parentNode;if(g&&(g[d]!==f||!a.nodeIndex)){i=0;for(l=g.firstChild;l;l=l.nextSibling)l.nodeType===1&&(l.nodeIndex=++i);g[d]=f}j=a.nodeIndex-e;return c===0?j===0:j%c===0&&j/c>=0}},ID:function(a,b){return a.nodeType===1&&a.getAttribute("id")===b},TAG:function(a,b){return b==="*"&&a.nodeType===1||!!a.nodeName&&a.nodeName.toLowerCase()===b},CLASS:function(a,b){return(" "+(a.className||a.getAttribute("class"))+" ").indexOf(b)>-1},ATTR:function(a,b){var c=b[1],d=m.attr?m.attr(a,c):o.attrHandle[c]?o.attrHandle[c](a):a[c]!=null?a[c]:a.getAttribute(c),e=d+"",f=b[2],g=b[4];return d==null?f==="!=":!f&&m.attr?d!=null:f==="="?e===g:f==="*="?e.indexOf(g)>=0:f==="~="?(" "+e+" ").indexOf(g)>=0:g?f==="!="?e!==g:f==="^="?e.indexOf(g)===0:f==="$="?e.substr(e.length-g.length)===g:f==="|="?e===g||e.substr(0,g.length+1)===g+"-":!1:e&&d!==!1},POS:function(a,b,c,d){var e=b[2],f=o.setFilters[e];if(f)return f(a,c,b,d)}}},p=o.match.POS,q=function(a,b){return"\\"+(b-0+1)};for(var r in o.match)o.match[r]=new RegExp(o.match[r].source+/(?![^\[]*\])(?![^\(]*\))/.source),o.leftMatch[r]=new RegExp(/(^(?:.|\r|\n)*?)/.source+o.match[r].source.replace(/\\(\d+)/g,q));o.match.globalPOS=p;var s=function(a,b){a=Array.prototype.slice.call(a,0);if(b){b.push.apply(b,a);return b}return a};try{Array.prototype.slice.call(c.documentElement.childNodes,0)[0].nodeType}catch(t){s=function(a,b){var c=0,d=b||[];if(g.call(a)==="[object Array]")Array.prototype.push.apply(d,a);else if(typeof a.length=="number")for(var e=a.length;c<e;c++)d.push(a[c]);else for(;a[c];c++)d.push(a[c]);return d}}var u,v;c.documentElement.compareDocumentPosition?u=function(a,b){if(a===b){h=!0;return 0}if(!a.compareDocumentPosition||!b.compareDocumentPosition)return a.compareDocumentPosition?-1:1;return a.compareDocumentPosition(b)&4?-1:1}:(u=function(a,b){if(a===b){h=!0;return 0}if(a.sourceIndex&&b.sourceIndex)return a.sourceIndex-b.sourceIndex;var c,d,e=[],f=[],g=a.parentNode,i=b.parentNode,j=g;if(g===i)return v(a,b);if(!g)return-1;if(!i)return 1;while(j)e.unshift(j),j=j.parentNode;j=i;while(j)f.unshift(j),j=j.parentNode;c=e.length,d=f.length;for(var k=0;k<c&&k<d;k++)if(e[k]!==f[k])return v(e[k],f[k]);return k===c?v(a,f[k],-1):v(e[k],b,1)},v=function(a,b,c){if(a===b)return c;var d=a.nextSibling;while(d){if(d===b)return-1;d=d.nextSibling}return 1}),function(){var a=c.createElement("div"),d="script"+(new Date).getTime(),e=c.documentElement;a.innerHTML="<a name='"+d+"'/>",e.insertBefore(a,e.firstChild),c.getElementById(d)&&(o.find.ID=function(a,c,d){if(typeof c.getElementById!="undefined"&&!d){var e=c.getElementById(a[1]);return e?e.id===a[1]||typeof e.getAttributeNode!="undefined"&&e.getAttributeNode("id").nodeValue===a[1]?[e]:b:[]}},o.filter.ID=function(a,b){var c=typeof a.getAttributeNode!="undefined"&&a.getAttributeNode("id");return a.nodeType===1&&c&&c.nodeValue===b}),e.removeChild(a),e=a=null}(),function(){var a=c.createElement("div");a.appendChild(c.createComment("")),a.getElementsByTagName("*").length>0&&(o.find.TAG=function(a,b){var c=b.getElementsByTagName(a[1]);if(a[1]==="*"){var d=[];for(var e=0;c[e];e++)c[e].nodeType===1&&d.push(c[e]);c=d}return c}),a.innerHTML="<a href='#'></a>",a.firstChild&&typeof a.firstChild.getAttribute!="undefined"&&a.firstChild.getAttribute("href")!=="#"&&(o.attrHandle.href=function(a){return a.getAttribute("href",2)}),a=null}(),c.querySelectorAll&&function(){var a=m,b=c.createElement("div"),d="__sizzle__";b.innerHTML="<p class='TEST'></p>";if(!b.querySelectorAll||b.querySelectorAll(".TEST").length!==0){m=function(b,e,f,g){e=e||c;if(!g&&!m.isXML(e)){var h=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(b);if(h&&(e.nodeType===1||e.nodeType===9)){if(h[1])return s(e.getElementsByTagName(b),f);if(h[2]&&o.find.CLASS&&e.getElementsByClassName)return s(e.getElementsByClassName(h[2]),f)}if(e.nodeType===9){if(b==="body"&&e.body)return s([e.body],f);if(h&&h[3]){var i=e.getElementById(h[3]);if(!i||!i.parentNode)return s([],f);if(i.id===h[3])return s([i],f)}try{return s(e.querySelectorAll(b),f)}catch(j){}}else if(e.nodeType===1&&e.nodeName.toLowerCase()!=="object"){var k=e,l=e.getAttribute("id"),n=l||d,p=e.parentNode,q=/^\s*[+~]/.test(b);l?n=n.replace(/'/g,"\\$&"):e.setAttribute("id",n),q&&p&&(e=e.parentNode);try{if(!q||p)return s(e.querySelectorAll("[id='"+n+"'] "+b),f)}catch(r){}finally{l||k.removeAttribute("id")}}}return a(b,e,f,g)};for(var e in a)m[e]=a[e];b=null}}(),function(){var a=c.documentElement,b=a.matchesSelector||a.mozMatchesSelector||a.webkitMatchesSelector||a.msMatchesSelector;if(b){var d=!b.call(c.createElement("div"),"div"),e=!1;try{b.call(c.documentElement,"[test!='']:sizzle")}catch(f){e=!0}m.matchesSelector=function(a,c){c=c.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!m.isXML(a))try{if(e||!o.match.PSEUDO.test(c)&&!/!=/.test(c)){var f=b.call(a,c);if(f||!d||a.document&&a.document.nodeType!==11)return f}}catch(g){}return m(c,null,null,[a]).length>0}}}(),function(){var a=c.createElement("div");a.innerHTML="<div class='test e'></div><div class='test'></div>";if(!!a.getElementsByClassName&&a.getElementsByClassName("e").length!==0){a.lastChild.className="e";if(a.getElementsByClassName("e").length===1)return;o.order.splice(1,0,"CLASS"),o.find.CLASS=function(a,b,c){if(typeof b.getElementsByClassName!="undefined"&&!c)return b.getElementsByClassName(a[1])},a=null}}(),c.documentElement.contains?m.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):!0)}:c.documentElement.compareDocumentPosition?m.contains=function(a,b){return!!(a.compareDocumentPosition(b)&16)}:m.contains=function(){return!1},m.isXML=function(a){var b=(a?a.ownerDocument||a:0).documentElement;return b?b.nodeName!=="HTML":!1};var y=function(a,b,c){var d,e=[],f="",g=b.nodeType?[b]:b;while(d=o.match.PSEUDO.exec(a))f+=d[0],a=a.replace(o.match.PSEUDO,"");a=o.relative[a]?a+"*":a;for(var h=0,i=g.length;h<i;h++)m(a,g[h],e,c);return m.filter(f,e)};m.attr=f.attr,m.selectors.attrMap={},f.find=m,f.expr=m.selectors,f.expr[":"]=f.expr.filters,f.unique=m.uniqueSort,f.text=m.getText,f.isXMLDoc=m.isXML,f.contains=m.contains}();var L=/Until$/,M=/^(?:parents|prevUntil|prevAll)/,N=/,/,O=/^.[^:#\[\.,]*$/,P=Array.prototype.slice,Q=f.expr.match.globalPOS,R={children:!0,contents:!0,next:!0,prev:!0};f.fn.extend({find:function(a){var b=this,c,d;if(typeof a!="string")return f(a).filter(function(){for(c=0,d=b.length;c<d;c++)if(f.contains(b[c],this))return!0});var e=this.pushStack("","find",a),g,h,i;for(c=0,d=this.length;c<d;c++){g=e.length,f.find(a,this[c],e);if(c>0)for(h=g;h<e.length;h++)for(i=0;i<g;i++)if(e[i]===e[h]){e.splice(h--,1);break}}return e},has:function(a){var b=f(a);return this.filter(function(){for(var a=0,c=b.length;a<c;a++)if(f.contains(this,b[a]))return!0})},not:function(a){return this.pushStack(T(this,a,!1),"not",a)},filter:function(a){return this.pushStack(T(this,a,!0),"filter",a)},is:function(a){return!!a&&(typeof a=="string"?Q.test(a)?f(a,this.context).index(this[0])>=0:f.filter(a,this).length>0:this.filter(a).length>0)},closest:function(a,b){var c=[],d,e,g=this[0];if(f.isArray(a)){var h=1;while(g&&g.ownerDocument&&g!==b){for(d=0;d<a.length;d++)f(g).is(a[d])&&c.push({selector:a[d],elem:g,level:h});g=g.parentNode,h++}return c}var i=Q.test(a)||typeof a!="string"?f(a,b||this.context):0;for(d=0,e=this.length;d<e;d++){g=this[d];while(g){if(i?i.index(g)>-1:f.find.matchesSelector(g,a)){c.push(g);break}g=g.parentNode;if(!g||!g.ownerDocument||g===b||g.nodeType===11)break}}c=c.length>1?f.unique(c):c;return this.pushStack(c,"closest",a)},index:function(a){if(!a)return this[0]&&this[0].parentNode?this.prevAll().length:-1;if(typeof a=="string")return f.inArray(this[0],f(a));return f.inArray(a.jquery?a[0]:a,this)},add:function(a,b){var c=typeof a=="string"?f(a,b):f.makeArray(a&&a.nodeType?[a]:a),d=f.merge(this.get(),c);return this.pushStack(S(c[0])||S(d[0])?d:f.unique(d))},andSelf:function(){return this.add(this.prevObject)}}),f.each({parent:function(a){var b=a.parentNode;return b&&b.nodeType!==11?b:null},parents:function(a){return f.dir(a,"parentNode")},parentsUntil:function(a,b,c){return f.dir(a,"parentNode",c)},next:function(a){return f.nth(a,2,"nextSibling")},prev:function(a){return f.nth(a,2,"previousSibling")},nextAll:function(a){return f.dir(a,"nextSibling")},prevAll:function(a){return f.dir(a,"previousSibling")},nextUntil:function(a,b,c){return f.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return f.dir(a,"previousSibling",c)},siblings:function(a){return f.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return f.sibling(a.firstChild)},contents:function(a){return f.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:f.makeArray(a.childNodes)}},function(a,b){f.fn[a]=function(c,d){var e=f.map(this,b,c);L.test(a)||(d=c),d&&typeof d=="string"&&(e=f.filter(d,e)),e=this.length>1&&!R[a]?f.unique(e):e,(this.length>1||N.test(d))&&M.test(a)&&(e=e.reverse());return this.pushStack(e,a,P.call(arguments).join(","))}}),f.extend({filter:function(a,b,c){c&&(a=":not("+a+")");return b.length===1?f.find.matchesSelector(b[0],a)?[b[0]]:[]:f.find.matches(a,b)},dir:function(a,c,d){var e=[],g=a[c];while(g&&g.nodeType!==9&&(d===b||g.nodeType!==1||!f(g).is(d)))g.nodeType===1&&e.push(g),g=g[c];return e},nth:function(a,b,c,d){b=b||1;var e=0;for(;a;a=a[c])if(a.nodeType===1&&++e===b)break;return a},sibling:function(a,b){var c=[];for(;a;a=a.nextSibling)a.nodeType===1&&a!==b&&c.push(a);return c}});var V="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",W=/ jQuery\d+="(?:\d+|null)"/g,X=/^\s+/,Y=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,Z=/<([\w:]+)/,$=/<tbody/i,_=/<|&#?\w+;/,ba=/<(?:script|style)/i,bb=/<(?:script|object|embed|option|style)/i,bc=new RegExp("<(?:"+V+")[\\s/>]","i"),bd=/checked\s*(?:[^=]|=\s*.checked.)/i,be=/\/(java|ecma)script/i,bf=/^\s*<!(?:\[CDATA\[|\-\-)/,bg={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]},bh=U(c);bg.optgroup=bg.option,bg.tbody=bg.tfoot=bg.colgroup=bg.caption=bg.thead,bg.th=bg.td,f.support.htmlSerialize||(bg._default=[1,"div<div>","</div>"]),f.fn.extend({text:function(a){return f.access(this,function(a){return a===b?f.text(this):this.empty().append((this[0]&&this[0].ownerDocument||c).createTextNode(a))},null,a,arguments.length)},wrapAll:function(a){if(f.isFunction(a))return this.each(function(b){f(this).wrapAll(a.call(this,b))});if(this[0]){var b=f(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&a.firstChild.nodeType===1)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){if(f.isFunction(a))return this.each(function(b){f(this).wrapInner(a.call(this,b))});return this.each(function(){var b=f(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=f.isFunction(a);return this.each(function(c){f(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){f.nodeName(this,"body")||f(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.appendChild(a)})},prepend:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.insertBefore(a,this.firstChild)})},before:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this)});if(arguments.length){var a=f
.clean(arguments);a.push.apply(a,this.toArray());return this.pushStack(a,"before",arguments)}},after:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this.nextSibling)});if(arguments.length){var a=this.pushStack(this,"after",arguments);a.push.apply(a,f.clean(arguments));return a}},remove:function(a,b){for(var c=0,d;(d=this[c])!=null;c++)if(!a||f.filter(a,[d]).length)!b&&d.nodeType===1&&(f.cleanData(d.getElementsByTagName("*")),f.cleanData([d])),d.parentNode&&d.parentNode.removeChild(d);return this},empty:function(){for(var a=0,b;(b=this[a])!=null;a++){b.nodeType===1&&f.cleanData(b.getElementsByTagName("*"));while(b.firstChild)b.removeChild(b.firstChild)}return this},clone:function(a,b){a=a==null?!1:a,b=b==null?a:b;return this.map(function(){return f.clone(this,a,b)})},html:function(a){return f.access(this,function(a){var c=this[0]||{},d=0,e=this.length;if(a===b)return c.nodeType===1?c.innerHTML.replace(W,""):null;if(typeof a=="string"&&!ba.test(a)&&(f.support.leadingWhitespace||!X.test(a))&&!bg[(Z.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(Y,"<$1></$2>");try{for(;d<e;d++)c=this[d]||{},c.nodeType===1&&(f.cleanData(c.getElementsByTagName("*")),c.innerHTML=a);c=0}catch(g){}}c&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(a){if(this[0]&&this[0].parentNode){if(f.isFunction(a))return this.each(function(b){var c=f(this),d=c.html();c.replaceWith(a.call(this,b,d))});typeof a!="string"&&(a=f(a).detach());return this.each(function(){var b=this.nextSibling,c=this.parentNode;f(this).remove(),b?f(b).before(a):f(c).append(a)})}return this.length?this.pushStack(f(f.isFunction(a)?a():a),"replaceWith",a):this},detach:function(a){return this.remove(a,!0)},domManip:function(a,c,d){var e,g,h,i,j=a[0],k=[];if(!f.support.checkClone&&arguments.length===3&&typeof j=="string"&&bd.test(j))return this.each(function(){f(this).domManip(a,c,d,!0)});if(f.isFunction(j))return this.each(function(e){var g=f(this);a[0]=j.call(this,e,c?g.html():b),g.domManip(a,c,d)});if(this[0]){i=j&&j.parentNode,f.support.parentNode&&i&&i.nodeType===11&&i.childNodes.length===this.length?e={fragment:i}:e=f.buildFragment(a,this,k),h=e.fragment,h.childNodes.length===1?g=h=h.firstChild:g=h.firstChild;if(g){c=c&&f.nodeName(g,"tr");for(var l=0,m=this.length,n=m-1;l<m;l++)d.call(c?bi(this[l],g):this[l],e.cacheable||m>1&&l<n?f.clone(h,!0,!0):h)}k.length&&f.each(k,function(a,b){b.src?f.ajax({type:"GET",global:!1,url:b.src,async:!1,dataType:"script"}):f.globalEval((b.text||b.textContent||b.innerHTML||"").replace(bf,"/*$0*/")),b.parentNode&&b.parentNode.removeChild(b)})}return this}}),f.buildFragment=function(a,b,d){var e,g,h,i,j=a[0];b&&b[0]&&(i=b[0].ownerDocument||b[0]),i.createDocumentFragment||(i=c),a.length===1&&typeof j=="string"&&j.length<512&&i===c&&j.charAt(0)==="<"&&!bb.test(j)&&(f.support.checkClone||!bd.test(j))&&(f.support.html5Clone||!bc.test(j))&&(g=!0,h=f.fragments[j],h&&h!==1&&(e=h)),e||(e=i.createDocumentFragment(),f.clean(a,i,e,d)),g&&(f.fragments[j]=h?e:1);return{fragment:e,cacheable:g}},f.fragments={},f.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){f.fn[a]=function(c){var d=[],e=f(c),g=this.length===1&&this[0].parentNode;if(g&&g.nodeType===11&&g.childNodes.length===1&&e.length===1){e[b](this[0]);return this}for(var h=0,i=e.length;h<i;h++){var j=(h>0?this.clone(!0):this).get();f(e[h])[b](j),d=d.concat(j)}return this.pushStack(d,a,e.selector)}}),f.extend({clone:function(a,b,c){var d,e,g,h=f.support.html5Clone||f.isXMLDoc(a)||!bc.test("<"+a.nodeName+">")?a.cloneNode(!0):bo(a);if((!f.support.noCloneEvent||!f.support.noCloneChecked)&&(a.nodeType===1||a.nodeType===11)&&!f.isXMLDoc(a)){bk(a,h),d=bl(a),e=bl(h);for(g=0;d[g];++g)e[g]&&bk(d[g],e[g])}if(b){bj(a,h);if(c){d=bl(a),e=bl(h);for(g=0;d[g];++g)bj(d[g],e[g])}}d=e=null;return h},clean:function(a,b,d,e){var g,h,i,j=[];b=b||c,typeof b.createElement=="undefined"&&(b=b.ownerDocument||b[0]&&b[0].ownerDocument||c);for(var k=0,l;(l=a[k])!=null;k++){typeof l=="number"&&(l+="");if(!l)continue;if(typeof l=="string")if(!_.test(l))l=b.createTextNode(l);else{l=l.replace(Y,"<$1></$2>");var m=(Z.exec(l)||["",""])[1].toLowerCase(),n=bg[m]||bg._default,o=n[0],p=b.createElement("div"),q=bh.childNodes,r;b===c?bh.appendChild(p):U(b).appendChild(p),p.innerHTML=n[1]+l+n[2];while(o--)p=p.lastChild;if(!f.support.tbody){var s=$.test(l),t=m==="table"&&!s?p.firstChild&&p.firstChild.childNodes:n[1]==="<table>"&&!s?p.childNodes:[];for(i=t.length-1;i>=0;--i)f.nodeName(t[i],"tbody")&&!t[i].childNodes.length&&t[i].parentNode.removeChild(t[i])}!f.support.leadingWhitespace&&X.test(l)&&p.insertBefore(b.createTextNode(X.exec(l)[0]),p.firstChild),l=p.childNodes,p&&(p.parentNode.removeChild(p),q.length>0&&(r=q[q.length-1],r&&r.parentNode&&r.parentNode.removeChild(r)))}var u;if(!f.support.appendChecked)if(l[0]&&typeof (u=l.length)=="number")for(i=0;i<u;i++)bn(l[i]);else bn(l);l.nodeType?j.push(l):j=f.merge(j,l)}if(d){g=function(a){return!a.type||be.test(a.type)};for(k=0;j[k];k++){h=j[k];if(e&&f.nodeName(h,"script")&&(!h.type||be.test(h.type)))e.push(h.parentNode?h.parentNode.removeChild(h):h);else{if(h.nodeType===1){var v=f.grep(h.getElementsByTagName("script"),g);j.splice.apply(j,[k+1,0].concat(v))}d.appendChild(h)}}}return j},cleanData:function(a){var b,c,d=f.cache,e=f.event.special,g=f.support.deleteExpando;for(var h=0,i;(i=a[h])!=null;h++){if(i.nodeName&&f.noData[i.nodeName.toLowerCase()])continue;c=i[f.expando];if(c){b=d[c];if(b&&b.events){for(var j in b.events)e[j]?f.event.remove(i,j):f.removeEvent(i,j,b.handle);b.handle&&(b.handle.elem=null)}g?delete i[f.expando]:i.removeAttribute&&i.removeAttribute(f.expando),delete d[c]}}}});var bp=/alpha\([^)]*\)/i,bq=/opacity=([^)]*)/,br=/([A-Z]|^ms)/g,bs=/^[\-+]?(?:\d*\.)?\d+$/i,bt=/^-?(?:\d*\.)?\d+(?!px)[^\d\s]+$/i,bu=/^([\-+])=([\-+.\de]+)/,bv=/^margin/,bw={position:"absolute",visibility:"hidden",display:"block"},bx=["Top","Right","Bottom","Left"],by,bz,bA;f.fn.css=function(a,c){return f.access(this,function(a,c,d){return d!==b?f.style(a,c,d):f.css(a,c)},a,c,arguments.length>1)},f.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=by(a,"opacity");return c===""?"1":c}return a.style.opacity}}},cssNumber:{fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":f.support.cssFloat?"cssFloat":"styleFloat"},style:function(a,c,d,e){if(!!a&&a.nodeType!==3&&a.nodeType!==8&&!!a.style){var g,h,i=f.camelCase(c),j=a.style,k=f.cssHooks[i];c=f.cssProps[i]||i;if(d===b){if(k&&"get"in k&&(g=k.get(a,!1,e))!==b)return g;return j[c]}h=typeof d,h==="string"&&(g=bu.exec(d))&&(d=+(g[1]+1)*+g[2]+parseFloat(f.css(a,c)),h="number");if(d==null||h==="number"&&isNaN(d))return;h==="number"&&!f.cssNumber[i]&&(d+="px");if(!k||!("set"in k)||(d=k.set(a,d))!==b)try{j[c]=d}catch(l){}}},css:function(a,c,d){var e,g;c=f.camelCase(c),g=f.cssHooks[c],c=f.cssProps[c]||c,c==="cssFloat"&&(c="float");if(g&&"get"in g&&(e=g.get(a,!0,d))!==b)return e;if(by)return by(a,c)},swap:function(a,b,c){var d={},e,f;for(f in b)d[f]=a.style[f],a.style[f]=b[f];e=c.call(a);for(f in b)a.style[f]=d[f];return e}}),f.curCSS=f.css,c.defaultView&&c.defaultView.getComputedStyle&&(bz=function(a,b){var c,d,e,g,h=a.style;b=b.replace(br,"-$1").toLowerCase(),(d=a.ownerDocument.defaultView)&&(e=d.getComputedStyle(a,null))&&(c=e.getPropertyValue(b),c===""&&!f.contains(a.ownerDocument.documentElement,a)&&(c=f.style(a,b))),!f.support.pixelMargin&&e&&bv.test(b)&&bt.test(c)&&(g=h.width,h.width=c,c=e.width,h.width=g);return c}),c.documentElement.currentStyle&&(bA=function(a,b){var c,d,e,f=a.currentStyle&&a.currentStyle[b],g=a.style;f==null&&g&&(e=g[b])&&(f=e),bt.test(f)&&(c=g.left,d=a.runtimeStyle&&a.runtimeStyle.left,d&&(a.runtimeStyle.left=a.currentStyle.left),g.left=b==="fontSize"?"1em":f,f=g.pixelLeft+"px",g.left=c,d&&(a.runtimeStyle.left=d));return f===""?"auto":f}),by=bz||bA,f.each(["height","width"],function(a,b){f.cssHooks[b]={get:function(a,c,d){if(c)return a.offsetWidth!==0?bB(a,b,d):f.swap(a,bw,function(){return bB(a,b,d)})},set:function(a,b){return bs.test(b)?b+"px":b}}}),f.support.opacity||(f.cssHooks.opacity={get:function(a,b){return bq.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?parseFloat(RegExp.$1)/100+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=f.isNumeric(b)?"alpha(opacity="+b*100+")":"",g=d&&d.filter||c.filter||"";c.zoom=1;if(b>=1&&f.trim(g.replace(bp,""))===""){c.removeAttribute("filter");if(d&&!d.filter)return}c.filter=bp.test(g)?g.replace(bp,e):g+" "+e}}),f(function(){f.support.reliableMarginRight||(f.cssHooks.marginRight={get:function(a,b){return f.swap(a,{display:"inline-block"},function(){return b?by(a,"margin-right"):a.style.marginRight})}})}),f.expr&&f.expr.filters&&(f.expr.filters.hidden=function(a){var b=a.offsetWidth,c=a.offsetHeight;return b===0&&c===0||!f.support.reliableHiddenOffsets&&(a.style&&a.style.display||f.css(a,"display"))==="none"},f.expr.filters.visible=function(a){return!f.expr.filters.hidden(a)}),f.each({margin:"",padding:"",border:"Width"},function(a,b){f.cssHooks[a+b]={expand:function(c){var d,e=typeof c=="string"?c.split(" "):[c],f={};for(d=0;d<4;d++)f[a+bx[d]+b]=e[d]||e[d-2]||e[0];return f}}});var bC=/%20/g,bD=/\[\]$/,bE=/\r?\n/g,bF=/#.*$/,bG=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,bH=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,bI=/^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,bJ=/^(?:GET|HEAD)$/,bK=/^\/\//,bL=/\?/,bM=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,bN=/^(?:select|textarea)/i,bO=/\s+/,bP=/([?&])_=[^&]*/,bQ=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/,bR=f.fn.load,bS={},bT={},bU,bV,bW=["*/"]+["*"];try{bU=e.href}catch(bX){bU=c.createElement("a"),bU.href="",bU=bU.href}bV=bQ.exec(bU.toLowerCase())||[],f.fn.extend({load:function(a,c,d){if(typeof a!="string"&&bR)return bR.apply(this,arguments);if(!this.length)return this;var e=a.indexOf(" ");if(e>=0){var g=a.slice(e,a.length);a=a.slice(0,e)}var h="GET";c&&(f.isFunction(c)?(d=c,c=b):typeof c=="object"&&(c=f.param(c,f.ajaxSettings.traditional),h="POST"));var i=this;f.ajax({url:a,type:h,dataType:"html",data:c,complete:function(a,b,c){c=a.responseText,a.isResolved()&&(a.done(function(a){c=a}),i.html(g?f("<div>").append(c.replace(bM,"")).find(g):c)),d&&i.each(d,[c,b,a])}});return this},serialize:function(){return f.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?f.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||bN.test(this.nodeName)||bH.test(this.type))}).map(function(a,b){var c=f(this).val();return c==null?null:f.isArray(c)?f.map(c,function(a,c){return{name:b.name,value:a.replace(bE,"\r\n")}}):{name:b.name,value:c.replace(bE,"\r\n")}}).get()}}),f.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){f.fn[b]=function(a){return this.on(b,a)}}),f.each(["get","post"],function(a,c){f[c]=function(a,d,e,g){f.isFunction(d)&&(g=g||e,e=d,d=b);return f.ajax({type:c,url:a,data:d,success:e,dataType:g})}}),f.extend({getScript:function(a,c){return f.get(a,b,c,"script")},getJSON:function(a,b,c){return f.get(a,b,c,"json")},ajaxSetup:function(a,b){b?b$(a,f.ajaxSettings):(b=a,a=f.ajaxSettings),b$(a,b);return a},ajaxSettings:{url:bU,isLocal:bI.test(bV[1]),global:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",processData:!0,async:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":bW},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":a.String,"text html":!0,"text json":f.parseJSON,"text xml":f.parseXML},flatOptions:{context:!0,url:!0}},ajaxPrefilter:bY(bS),ajaxTransport:bY(bT),ajax:function(a,c){function w(a,c,l,m){if(s!==2){s=2,q&&clearTimeout(q),p=b,n=m||"",v.readyState=a>0?4:0;var o,r,u,w=c,x=l?ca(d,v,l):b,y,z;if(a>=200&&a<300||a===304){if(d.ifModified){if(y=v.getResponseHeader("Last-Modified"))f.lastModified[k]=y;if(z=v.getResponseHeader("Etag"))f.etag[k]=z}if(a===304)w="notmodified",o=!0;else try{r=cb(d,x),w="success",o=!0}catch(A){w="parsererror",u=A}}else{u=w;if(!w||a)w="error",a<0&&(a=0)}v.status=a,v.statusText=""+(c||w),o?h.resolveWith(e,[r,w,v]):h.rejectWith(e,[v,w,u]),v.statusCode(j),j=b,t&&g.trigger("ajax"+(o?"Success":"Error"),[v,d,o?r:u]),i.fireWith(e,[v,w]),t&&(g.trigger("ajaxComplete",[v,d]),--f.active||f.event.trigger("ajaxStop"))}}typeof a=="object"&&(c=a,a=b),c=c||{};var d=f.ajaxSetup({},c),e=d.context||d,g=e!==d&&(e.nodeType||e instanceof f)?f(e):f.event,h=f.Deferred(),i=f.Callbacks("once memory"),j=d.statusCode||{},k,l={},m={},n,o,p,q,r,s=0,t,u,v={readyState:0,setRequestHeader:function(a,b){if(!s){var c=a.toLowerCase();a=m[c]=m[c]||a,l[a]=b}return this},getAllResponseHeaders:function(){return s===2?n:null},getResponseHeader:function(a){var c;if(s===2){if(!o){o={};while(c=bG.exec(n))o[c[1].toLowerCase()]=c[2]}c=o[a.toLowerCase()]}return c===b?null:c},overrideMimeType:function(a){s||(d.mimeType=a);return this},abort:function(a){a=a||"abort",p&&p.abort(a),w(0,a);return this}};h.promise(v),v.success=v.done,v.error=v.fail,v.complete=i.add,v.statusCode=function(a){if(a){var b;if(s<2)for(b in a)j[b]=[j[b],a[b]];else b=a[v.status],v.then(b,b)}return this},d.url=((a||d.url)+"").replace(bF,"").replace(bK,bV[1]+"//"),d.dataTypes=f.trim(d.dataType||"*").toLowerCase().split(bO),d.crossDomain==null&&(r=bQ.exec(d.url.toLowerCase()),d.crossDomain=!(!r||r[1]==bV[1]&&r[2]==bV[2]&&(r[3]||(r[1]==="http:"?80:443))==(bV[3]||(bV[1]==="http:"?80:443)))),d.data&&d.processData&&typeof d.data!="string"&&(d.data=f.param(d.data,d.traditional)),bZ(bS,d,c,v);if(s===2)return!1;t=d.global,d.type=d.type.toUpperCase(),d.hasContent=!bJ.test(d.type),t&&f.active++===0&&f.event.trigger("ajaxStart");if(!d.hasContent){d.data&&(d.url+=(bL.test(d.url)?"&":"?")+d.data,delete d.data),k=d.url;if(d.cache===!1){var x=f.now(),y=d.url.replace(bP,"$1_="+x);d.url=y+(y===d.url?(bL.test(d.url)?"&":"?")+"_="+x:"")}}(d.data&&d.hasContent&&d.contentType!==!1||c.contentType)&&v.setRequestHeader("Content-Type",d.contentType),d.ifModified&&(k=k||d.url,f.lastModified[k]&&v.setRequestHeader("If-Modified-Since",f.lastModified[k]),f.etag[k]&&v.setRequestHeader("If-None-Match",f.etag[k])),v.setRequestHeader("Accept",d.dataTypes[0]&&d.accepts[d.dataTypes[0]]?d.accepts[d.dataTypes[0]]+(d.dataTypes[0]!=="*"?", "+bW+"; q=0.01":""):d.accepts["*"]);for(u in d.headers)v.setRequestHeader(u,d.headers[u]);if(d.beforeSend&&(d.beforeSend.call(e,v,d)===!1||s===2)){v.abort();return!1}for(u in{success:1,error:1,complete:1})v[u](d[u]);p=bZ(bT,d,c,v);if(!p)w(-1,"No Transport");else{v.readyState=1,t&&g.trigger("ajaxSend",[v,d]),d.async&&d.timeout>0&&(q=setTimeout(function(){v.abort("timeout")},d.timeout));try{s=1,p.send(l,w)}catch(z){if(s<2)w(-1,z);else throw z}}return v},param:function(a,c){var d=[],e=function(a,b){b=f.isFunction(b)?b():b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};c===b&&(c=f.ajaxSettings.traditional);if(f.isArray(a)||a.jquery&&!f.isPlainObject(a))f.each(a,function(){e(this.name,this.value)});else for(var g in a)b_(g,a[g],c,e);return d.join("&").replace(bC,"+")}}),f.extend({active:0,lastModified:{},etag:{}});var cc=f.now(),cd=/(\=)\?(&|$)|\?\?/i;f.ajaxSetup({jsonp:"callback",jsonpCallback:function(){return f.expando+"_"+cc++}}),f.ajaxPrefilter("json jsonp",function(b,c,d){var e=typeof b.data=="string"&&/^application\/x\-www\-form\-urlencoded/.test(b.contentType);if(b.dataTypes[0]==="jsonp"||b.jsonp!==!1&&(cd.test(b.url)||e&&cd.test(b.data))){var g,h=b.jsonpCallback=f.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,i=a[h],j=b.url,k=b.data,l="$1"+h+"$2";b.jsonp!==!1&&(j=j.replace(cd,l),b.url===j&&(e&&(k=k.replace(cd,l)),b.data===k&&(j+=(/\?/.test(j)?"&":"?")+b.jsonp+"="+h))),b.url=j,b.data=k,a[h]=function(a){g=[a]},d.always(function(){a[h]=i,g&&f.isFunction(i)&&a[h](g[0])}),b.converters["script json"]=function(){g||f.error(h+" was not called");return g[0]},b.dataTypes[0]="json";return"script"}}),f.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(a){f.globalEval(a);return a}}}),f.ajaxPrefilter("script",function(a){a.cache===b&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),f.ajaxTransport("script",function(a){if(a.crossDomain){var d,e=c.head||c.getElementsByTagName("head")[0]||c.documentElement;return{send:function(f,g){d=c.createElement("script"),d.async="async",a.scriptCharset&&(d.charset=a.scriptCharset),d.src=a.url,d.onload=d.onreadystatechange=function(a,c){if(c||!d.readyState||/loaded|complete/.test(d.readyState))d.onload=d.onreadystatechange=null,e&&d.parentNode&&e.removeChild(d),d=b,c||g(200,"success")},e.insertBefore(d,e.firstChild)},abort:function(){d&&d.onload(0,1)}}}});var ce=a.ActiveXObject?function(){for(var a in cg)cg[a](0,1)}:!1,cf=0,cg;f.ajaxSettings.xhr=a.ActiveXObject?function(){return!this.isLocal&&ch()||ci()}:ch,function(a){f.extend(f.support,{ajax:!!a,cors:!!a&&"withCredentials"in a})}(f.ajaxSettings.xhr()),f.support.ajax&&f.ajaxTransport(function(c){if(!c.crossDomain||f.support.cors){var d;return{send:function(e,g){var h=c.xhr(),i,j;c.username?h.open(c.type,c.url,c.async,c.username,c.password):h.open(c.type,c.url,c.async);if(c.xhrFields)for(j in c.xhrFields)h[j]=c.xhrFields[j];c.mimeType&&h.overrideMimeType&&h.overrideMimeType(c.mimeType),!c.crossDomain&&!e["X-Requested-With"]&&(e["X-Requested-With"]="XMLHttpRequest");try{for(j in e)h.setRequestHeader(j,e[j])}catch(k){}h.send(c.hasContent&&c.data||null),d=function(a,e){var j,k,l,m,n;try{if(d&&(e||h.readyState===4)){d=b,i&&(h.onreadystatechange=f.noop,ce&&delete cg[i]);if(e)h.readyState!==4&&h.abort();else{j=h.status,l=h.getAllResponseHeaders(),m={},n=h.responseXML,n&&n.documentElement&&(m.xml=n);try{m.text=h.responseText}catch(a){}try{k=h.statusText}catch(o){k=""}!j&&c.isLocal&&!c.crossDomain?j=m.text?200:404:j===1223&&(j=204)}}}catch(p){e||g(-1,p)}m&&g(j,k,m,l)},!c.async||h.readyState===4?d():(i=++cf,ce&&(cg||(cg={},f(a).unload(ce)),cg[i]=d),h.onreadystatechange=d)},abort:function(){d&&d(0,1)}}}});var cj={},ck,cl,cm=/^(?:toggle|show|hide)$/,cn=/^([+\-]=)?([\d+.\-]+)([a-z%]*)$/i,co,cp=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]],cq;f.fn.extend({show:function(a,b,c){var d,e;if(a||a===0)return this.animate(ct("show",3),a,b,c);for(var g=0,h=this.length;g<h;g++)d=this[g],d.style&&(e=d.style.display,!f._data(d,"olddisplay")&&e==="none"&&(e=d.style.display=""),(e===""&&f.css(d,"display")==="none"||!f.contains(d.ownerDocument.documentElement,d))&&f._data(d,"olddisplay",cu(d.nodeName)));for(g=0;g<h;g++){d=this[g];if(d.style){e=d.style.display;if(e===""||e==="none")d.style.display=f._data(d,"olddisplay")||""}}return this},hide:function(a,b,c){if(a||a===0)return this.animate(ct("hide",3),a,b,c);var d,e,g=0,h=this.length;for(;g<h;g++)d=this[g],d.style&&(e=f.css(d,"display"),e!=="none"&&!f._data(d,"olddisplay")&&f._data(d,"olddisplay",e));for(g=0;g<h;g++)this[g].style&&(this[g].style.display="none");return this},_toggle:f.fn.toggle,toggle:function(a,b,c){var d=typeof a=="boolean";f.isFunction(a)&&f.isFunction(b)?this._toggle.apply(this,arguments):a==null||d?this.each(function(){var b=d?a:f(this).is(":hidden");f(this)[b?"show":"hide"]()}):this.animate(ct("toggle",3),a,b,c);return this},fadeTo:function(a,b,c,d){return this.filter(":hidden").css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){function g(){e.queue===!1&&f._mark(this);var b=f.extend({},e),c=this.nodeType===1,d=c&&f(this).is(":hidden"),g,h,i,j,k,l,m,n,o,p,q;b.animatedProperties={};for(i in a){g=f.camelCase(i),i!==g&&(a[g]=a[i],delete a[i]);if((k=f.cssHooks[g])&&"expand"in k){l=k.expand(a[g]),delete a[g];for(i in l)i in a||(a[i]=l[i])}}for(g in a){h=a[g],f.isArray(h)?(b.animatedProperties[g]=h[1],h=a[g]=h[0]):b.animatedProperties[g]=b.specialEasing&&b.specialEasing[g]||b.easing||"swing";if(h==="hide"&&d||h==="show"&&!d)return b.complete.call(this);c&&(g==="height"||g==="width")&&(b.overflow=[this.style.overflow,this.style.overflowX,this.style.overflowY],f.css(this,"display")==="inline"&&f.css(this,"float")==="none"&&(!f.support.inlineBlockNeedsLayout||cu(this.nodeName)==="inline"?this.style.display="inline-block":this.style.zoom=1))}b.overflow!=null&&(this.style.overflow="hidden");for(i in a)j=new f.fx(this,b,i),h=a[i],cm.test(h)?(q=f._data(this,"toggle"+i)||(h==="toggle"?d?"show":"hide":0),q?(f._data(this,"toggle"+i,q==="show"?"hide":"show"),j[q]()):j[h]()):(m=cn.exec(h),n=j.cur(),m?(o=parseFloat(m[2]),p=m[3]||(f.cssNumber[i]?"":"px"),p!=="px"&&(f.style(this,i,(o||1)+p),n=(o||1)/j.cur()*n,f.style(this,i,n+p)),m[1]&&(o=(m[1]==="-="?-1:1)*o+n),j.custom(n,o,p)):j.custom(n,h,""));return!0}var e=f.speed(b,c,d);if(f.isEmptyObject(a))return this.each(e.complete,[!1]);a=f.extend({},a);return e.queue===!1?this.each(g):this.queue(e.queue,g)},stop:function(a,c,d){typeof a!="string"&&(d=c,c=a,a=b),c&&a!==!1&&this.queue(a||"fx",[]);return this.each(function(){function h(a,b,c){var e=b[c];f.removeData(a,c,!0),e.stop(d)}var b,c=!1,e=f.timers,g=f._data(this);d||f._unmark(!0,this);if(a==null)for(b in g)g[b]&&g[b].stop&&b.indexOf(".run")===b.length-4&&h(this,g,b);else g[b=a+".run"]&&g[b].stop&&h(this,g,b);for(b=e.length;b--;)e[b].elem===this&&(a==null||e[b].queue===a)&&(d?e[b](!0):e[b].saveState(),c=!0,e.splice(b,1));(!d||!c)&&f.dequeue(this,a)})}}),f.each({slideDown:ct("show",1),slideUp:ct("hide",1),slideToggle:ct("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){f.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),f.extend({speed:function(a,b,c){var d=a&&typeof a=="object"?f.extend({},a):{complete:c||!c&&b||f.isFunction(a)&&a,duration:a,easing:c&&b||b&&!f.isFunction(b)&&b};d.duration=f.fx.off?0:typeof d.duration=="number"?d.duration:d.duration in f.fx.speeds?f.fx.speeds[d.duration]:f.fx.speeds._default;if(d.queue==null||d.queue===!0)d.queue="fx";d.old=d.complete,d.complete=function(a){f.isFunction(d.old)&&d.old.call(this),d.queue?f.dequeue(this,d.queue):a!==!1&&f._unmark(this)};return d},easing:{linear:function(a){return a},swing:function(a){return-Math.cos(a*Math.PI)/2+.5}},timers:[],fx:function(a,b,c){this.options=b,this.elem=a,this.prop=c,b.orig=b.orig||{}}}),f.fx.prototype={update:function(){this.options.step&&this.options.step.call(this.elem,this.now,this),(f.fx.step[this.prop]||f.fx.step._default)(this)},cur:function(){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null))return this.elem[this.prop];var a,b=f.css(this.elem,this.prop);return isNaN(a=parseFloat(b))?!b||b==="auto"?0:b:a},custom:function(a,c,d){function h(a){return e.step(a)}var e=this,g=f.fx;this.startTime=cq||cr(),this.end=c,this.now=this.start=a,this.pos=this.state=0,this.unit=d||this.unit||(f.cssNumber[this.prop]?"":"px"),h.queue=this.options.queue,h.elem=this.elem,h.saveState=function(){f._data(e.elem,"fxshow"+e.prop)===b&&(e.options.hide?f._data(e.elem,"fxshow"+e.prop,e.start):e.options.show&&f._data(e.elem,"fxshow"+e.prop,e.end))},h()&&f.timers.push(h)&&!co&&(co=setInterval(g.tick,g.interval))},show:function(){var a=f._data(this.elem,"fxshow"+this.prop);this.options.orig[this.prop]=a||f.style(this.elem,this.prop),this.options.show=!0,a!==b?this.custom(this.cur(),a):this.custom(this.prop==="width"||this.prop==="height"?1:0,this.cur()),f(this.elem).show()},hide:function(){this.options.orig[this.prop]=f._data(this.elem,"fxshow"+this.prop)||f.style(this.elem,this.prop),this.options.hide=!0,this.custom(this.cur(),0)},step:function(a){var b,c,d,e=cq||cr(),g=!0,h=this.elem,i=this.options;if(a||e>=i.duration+this.startTime){this.now=this.end,this.pos=this.state=1,this.update(),i.animatedProperties[this.prop]=!0;for(b in i.animatedProperties)i.animatedProperties[b]!==!0&&(g=!1);if(g){i.overflow!=null&&!f.support.shrinkWrapBlocks&&f.each(["","X","Y"],function(a,b){h.style["overflow"+b]=i.overflow[a]}),i.hide&&f(h).hide();if(i.hide||i.show)for(b in i.animatedProperties)f.style(h,b,i.orig[b]),f.removeData(h,"fxshow"+b,!0),f.removeData(h,"toggle"+b,!0);d=i.complete,d&&(i.complete=!1,d.call(h))}return!1}i.duration==Infinity?this.now=e:(c=e-this.startTime,this.state=c/i.duration,this.pos=f.easing[i.animatedProperties[this.prop]](this.state,c,0,1,i.duration),this.now=this.start+(this.end-this.start)*this.pos),this.update();return!0}},f.extend(f.fx,{tick:function(){var a,b=f.timers,c=0;for(;c<b.length;c++)a=b[c],!a()&&b[c]===a&&b.splice(c--,1);b.length||f.fx.stop()},interval:13,stop:function(){clearInterval(co),co=null},speeds:{slow:600,fast:200,_default:400},step:{opacity:function(a){f.style(a.elem,"opacity",a.now)},_default:function(a){a.elem.style&&a.elem.style[a.prop]!=null?a.elem.style[a.prop]=a.now+a.unit:a.elem[a.prop]=a.now}}}),f.each(cp.concat.apply([],cp),function(a,b){b.indexOf("margin")&&(f.fx.step[b]=function(a){f.style(a.elem,b,Math.max(0,a.now)+a.unit)})}),f.expr&&f.expr.filters&&(f.expr.filters.animated=function(a){return f.grep(f.timers,function(b){return a===b.elem}).length});var cv,cw=/^t(?:able|d|h)$/i,cx=/^(?:body|html)$/i;"getBoundingClientRect"in c.documentElement?cv=function(a,b,c,d){try{d=a.getBoundingClientRect()}catch(e){}if(!d||!f.contains(c,a))return d?{top:d.top,left:d.left}:{top:0,left:0};var g=b.body,h=cy(b),i=c.clientTop||g.clientTop||0,j=c.clientLeft||g.clientLeft||0,k=h.pageYOffset||f.support.boxModel&&c.scrollTop||g.scrollTop,l=h.pageXOffset||f.support.boxModel&&c.scrollLeft||g.scrollLeft,m=d.top+k-i,n=d.left+l-j;return{top:m,left:n}}:cv=function(a,b,c){var d,e=a.offsetParent,g=a,h=b.body,i=b.defaultView,j=i?i.getComputedStyle(a,null):a.currentStyle,k=a.offsetTop,l=a.offsetLeft;while((a=a.parentNode)&&a!==h&&a!==c){if(f.support.fixedPosition&&j.position==="fixed")break;d=i?i.getComputedStyle(a,null):a.currentStyle,k-=a.scrollTop,l-=a.scrollLeft,a===e&&(k+=a.offsetTop,l+=a.offsetLeft,f.support.doesNotAddBorder&&(!f.support.doesAddBorderForTableAndCells||!cw.test(a.nodeName))&&(k+=parseFloat(d.borderTopWidth)||0,l+=parseFloat(d.borderLeftWidth)||0),g=e,e=a.offsetParent),f.support.subtractsBorderForOverflowNotVisible&&d.overflow!=="visible"&&(k+=parseFloat(d.borderTopWidth)||0,l+=parseFloat(d.borderLeftWidth)||0),j=d}if(j.position==="relative"||j.position==="static")k+=h.offsetTop,l+=h.offsetLeft;f.support.fixedPosition&&j.position==="fixed"&&(k+=Math.max(c.scrollTop,h.scrollTop),l+=Math.max(c.scrollLeft,h.scrollLeft));return{top:k,left:l}},f.fn.offset=function(a){if(arguments.length)return a===b?this:this.each(function(b){f.offset.setOffset(this,a,b)});var c=this[0],d=c&&c.ownerDocument;if(!d)return null;if(c===d.body)return f.offset.bodyOffset(c);return cv(c,d,d.documentElement)},f.offset={bodyOffset:function(a){var b=a.offsetTop,c=a.offsetLeft;f.support.doesNotIncludeMarginInBodyOffset&&(b+=parseFloat(f.css(a,"marginTop"))||0,c+=parseFloat(f.css(a,"marginLeft"))||0);return{top:b,left:c}},setOffset:function(a,b,c){var d=f.css(a,"position");d==="static"&&(a.style.position="relative");var e=f(a),g=e.offset(),h=f.css(a,"top"),i=f.css(a,"left"),j=(d==="absolute"||d==="fixed")&&f.inArray("auto",[h,i])>-1,k={},l={},m,n;j?(l=e.position(),m=l.top,n=l.left):(m=parseFloat(h)||0,n=parseFloat(i)||0),f.isFunction(b)&&(b=b.call(a,c,g)),b.top!=null&&(k.top=b.top-g.top+m),b.left!=null&&(k.left=b.left-g.left+n),"using"in b?b.using.call(a,k):e.css(k)}},f.fn.extend({position:function(){if(!this[0])return null;var a=this[0],b=this.offsetParent(),c=this.offset(),d=cx.test(b[0].nodeName)?{top:0,left:0}:b.offset();c.top-=parseFloat(f.css(a,"marginTop"))||0,c.left-=parseFloat(f.css(a,"marginLeft"))||0,d.top+=parseFloat(f.css(b[0],"borderTopWidth"))||0,d.left+=parseFloat(f.css(b[0],"borderLeftWidth"))||0;return{top:c.top-d.top,left:c.left-d.left}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||c.body;while(a&&!cx.test(a.nodeName)&&f.css(a,"position")==="static")a=a.offsetParent;return a})}}),f.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,c){var d=/Y/.test(c);f.fn[a]=function(e){return f.access(this,function(a,e,g){var h=cy(a);if(g===b)return h?c in h?h[c]:f.support.boxModel&&h.document.documentElement[e]||h.document.body[e]:a[e];h?h.scrollTo(d?f(h).scrollLeft():g,d?g:f(h).scrollTop()):a[e]=g},a,e,arguments.length,null)}}),f.each({Height:"height",Width:"width"},function(a,c){var d="client"+a,e="scroll"+a,g="offset"+a;f.fn["inner"+a]=function(){var a=this[0];return a?a.style?parseFloat(f.css(a,c,"padding")):this[c]():null},f.fn["outer"+a]=function(a){var b=this[0];return b?b.style?parseFloat(f.css(b,c,a?"margin":"border")):this[c]():null},f.fn[c]=function(a){return f.access(this,function(a,c,h){var i,j,k,l;if(f.isWindow(a)){i=a.document,j=i.documentElement[d];return f.support.boxModel&&j||i.body&&i.body[d]||j}if(a.nodeType===9){i=a.documentElement;if(i[d]>=i[e])return i[d];return Math.max(a.body[e],i[e],a.body[g],i[g])}if(h===b){k=f.css(a,c),l=parseFloat(k);return f.isNumeric(l)?l:k}f(a).css(c,h)},c,a,arguments.length,null)}}),a.jQuery=a.$=f,typeof define=="function"&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return f})})(window);</script>
		<script type="text/javascript">// Based on http://paulgueller.com/2011/04/26/parse-the-querystring-with-jquery/
jQuery.extend({
	  parseQueryString: function (def) {
		var nvpair = {}
		var qs = window.location.hash.replace(/^#/,'')
		var pairs = qs.split('&')
		$.each(pairs, function(i, v){
			var pair = v.split('=')
			if ((typeof(pair[1]) === "undefined") && def) {
			  nvpair[def] = pair[0]	  	
			} else {
				if (pair[0] !== '') {
					nvpair[pair[0]] = pair[1]
				}
			}
		})
		return nvpair
	  }
	})
</script>
		<script type="text/javascript">/**
 * jQuery.ScrollTo - Easy element scrolling using jQuery.
 * Copyright (c) 2007-2008 Ariel Flesler - aflesler(at)gmail(dot)com | http://flesler.blogspot.com
 * Dual licensed under MIT and GPL.
 * Date: 9/11/2008
 * @author Ariel Flesler
 * @version 1.4
 *
 * http://flesler.blogspot.com/2007/10/jqueryscrollto.html
 */
;(function(h){var m=h.scrollTo=function(b,c,g){h(window).scrollTo(b,c,g)};m.defaults={axis:'y',duration:1};m.window=function(b){return h(window).scrollable()};h.fn.scrollable=function(){return this.map(function(){var b=this.parentWindow||this.defaultView,c=this.nodeName=='#document'?b.frameElement||b:this,g=c.contentDocument||(c.contentWindow||c).document,i=c.setInterval;return c.nodeName=='IFRAME'||i&&h.browser.safari?g.body:i?g.documentElement:this})};h.fn.scrollTo=function(r,j,a){if(typeof j=='object'){a=j;j=0}if(typeof a=='function')a={onAfter:a};a=h.extend({},m.defaults,a);j=j||a.speed||a.duration;a.queue=a.queue&&a.axis.length>1;if(a.queue)j/=2;a.offset=n(a.offset);a.over=n(a.over);return this.scrollable().each(function(){var k=this,o=h(k),d=r,l,e={},p=o.is('html,body');switch(typeof d){case'number':case'string':if(/^([+-]=)?\d+(px)?$/.test(d)){d=n(d);break}d=h(d,this);case'object':if(d.is||d.style)l=(d=h(d)).offset()}h.each(a.axis.split(''),function(b,c){var g=c=='x'?'Left':'Top',i=g.toLowerCase(),f='scroll'+g,s=k[f],t=c=='x'?'Width':'Height',v=t.toLowerCase();if(l){e[f]=l[i]+(p?0:s-o.offset()[i]);if(a.margin){e[f]-=parseInt(d.css('margin'+g))||0;e[f]-=parseInt(d.css('border'+g+'Width'))||0}e[f]+=a.offset[i]||0;if(a.over[i])e[f]+=d[v]()*a.over[i]}else e[f]=d[i];if(/^\d+$/.test(e[f]))e[f]=e[f]<=0?0:Math.min(e[f],u(t));if(!b&&a.queue){if(s!=e[f])q(a.onAfterFirst);delete e[f]}});q(a.onAfter);function q(b){o.animate(e,j,a.easing,b&&function(){b.call(this,r,a)})};function u(b){var c='scroll'+b,g=k.ownerDocument;return p?Math.max(g.documentElement[c],g.body[c]):k[c]}}).end()};function n(b){return typeof b=='object'?b:{top:b,left:b}}})(jQuery);</script>
		<script type="text/javascript">/*!
 * jQuery hashchange event - v1.3 - 7/21/2010
 * http://benalman.com/projects/jquery-hashchange-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */

// Script: jQuery hashchange event
//
// *Version: 1.3, Last updated: 7/21/2010*
// 
// Project Home - http://benalman.com/projects/jquery-hashchange-plugin/
// GitHub       - http://github.com/cowboy/jquery-hashchange/
// Source       - http://github.com/cowboy/jquery-hashchange/raw/master/jquery.ba-hashchange.js
// (Minified)   - http://github.com/cowboy/jquery-hashchange/raw/master/jquery.ba-hashchange.min.js (0.8kb gzipped)
// 
// About: License
// 
// Copyright (c) 2010 "Cowboy" Ben Alman,
// Dual licensed under the MIT and GPL licenses.
// http://benalman.com/about/license/
// 
// About: Examples
// 
// These working examples, complete with fully commented code, illustrate a few
// ways in which this plugin can be used.
// 
// hashchange event - http://benalman.com/code/projects/jquery-hashchange/examples/hashchange/
// document.domain - http://benalman.com/code/projects/jquery-hashchange/examples/document_domain/
// 
// About: Support and Testing
// 
// Information about what version or versions of jQuery this plugin has been
// tested with, what browsers it has been tested in, and where the unit tests
// reside (so you can test it yourself).
// 
// jQuery Versions - 1.2.6, 1.3.2, 1.4.1, 1.4.2
// Browsers Tested - Internet Explorer 6-8, Firefox 2-4, Chrome 5-6, Safari 3.2-5,
//                   Opera 9.6-10.60, iPhone 3.1, Android 1.6-2.2, BlackBerry 4.6-5.
// Unit Tests      - http://benalman.com/code/projects/jquery-hashchange/unit/
// 
// About: Known issues
// 
// While this jQuery hashchange event implementation is quite stable and
// robust, there are a few unfortunate browser bugs surrounding expected
// hashchange event-based behaviors, independent of any JavaScript
// window.onhashchange abstraction. See the following examples for more
// information:
// 
// Chrome: Back Button - http://benalman.com/code/projects/jquery-hashchange/examples/bug-chrome-back-button/
// Firefox: Remote XMLHttpRequest - http://benalman.com/code/projects/jquery-hashchange/examples/bug-firefox-remote-xhr/
// WebKit: Back Button in an Iframe - http://benalman.com/code/projects/jquery-hashchange/examples/bug-webkit-hash-iframe/
// Safari: Back Button from a different domain - http://benalman.com/code/projects/jquery-hashchange/examples/bug-safari-back-from-diff-domain/
// 
// Also note that should a browser natively support the window.onhashchange 
// event, but not report that it does, the fallback polling loop will be used.
// 
// About: Release History
// 
// 1.3   - (7/21/2010) Reorganized IE6/7 Iframe code to make it more
//         "removable" for mobile-only development. Added IE6/7 document.title
//         support. Attempted to make Iframe as hidden as possible by using
//         techniques from http://www.paciellogroup.com/blog/?p=604. Added 
//         support for the "shortcut" format $(window).hashchange( fn ) and
//         $(window).hashchange() like jQuery provides for built-in events.
//         Renamed jQuery.hashchangeDelay to <jQuery.fn.hashchange.delay> and
//         lowered its default value to 50. Added <jQuery.fn.hashchange.domain>
//         and <jQuery.fn.hashchange.src> properties plus document-domain.html
//         file to address access denied issues when setting document.domain in
//         IE6/7.
// 1.2   - (2/11/2010) Fixed a bug where coming back to a page using this plugin
//         from a page on another domain would cause an error in Safari 4. Also,
//         IE6/7 Iframe is now inserted after the body (this actually works),
//         which prevents the page from scrolling when the event is first bound.
//         Event can also now be bound before DOM ready, but it won't be usable
//         before then in IE6/7.
// 1.1   - (1/21/2010) Incorporated document.documentMode test to fix IE8 bug
//         where browser version is incorrectly reported as 8.0, despite
//         inclusion of the X-UA-Compatible IE=EmulateIE7 meta tag.
// 1.0   - (1/9/2010) Initial Release. Broke out the jQuery BBQ event.special
//         window.onhashchange functionality into a separate plugin for users
//         who want just the basic event & back button support, without all the
//         extra awesomeness that BBQ provides. This plugin will be included as
//         part of jQuery BBQ, but also be available separately.

(function($,window,undefined){
  '$:nomunge'; // Used by YUI compressor.
  
  // Reused string.
  var str_hashchange = 'hashchange',
    
    // Method / object references.
    doc = document,
    fake_onhashchange,
    special = $.event.special,
    
    // Does the browser support window.onhashchange? Note that IE8 running in
    // IE7 compatibility mode reports true for 'onhashchange' in window, even
    // though the event isn't supported, so also test document.documentMode.
    doc_mode = doc.documentMode,
    supports_onhashchange = 'on' + str_hashchange in window && ( doc_mode === undefined || doc_mode > 7 );
  
  // Get location.hash (or what you'd expect location.hash to be) sans any
  // leading #. Thanks for making this necessary, Firefox!
  function get_fragment( url ) {
    url = url || location.href;
    return '#' + url.replace( /^[^#]*#?(.*)$/, '$1' );
  };
  
  // Method: jQuery.fn.hashchange
  // 
  // Bind a handler to the window.onhashchange event or trigger all bound
  // window.onhashchange event handlers. This behavior is consistent with
  // jQuery's built-in event handlers.
  // 
  // Usage:
  // 
  // > jQuery(window).hashchange( [ handler ] );
  // 
  // Arguments:
  // 
  //  handler - (Function) Optional handler to be bound to the hashchange
  //    event. This is a "shortcut" for the more verbose form:
  //    jQuery(window).bind( 'hashchange', handler ). If handler is omitted,
  //    all bound window.onhashchange event handlers will be triggered. This
  //    is a shortcut for the more verbose
  //    jQuery(window).trigger( 'hashchange' ). These forms are described in
  //    the <hashchange event> section.
  // 
  // Returns:
  // 
  //  (jQuery) The initial jQuery collection of elements.
  
  // Allow the "shortcut" format $(elem).hashchange( fn ) for binding and
  // $(elem).hashchange() for triggering, like jQuery does for built-in events.
  $.fn[ str_hashchange ] = function( fn ) {
    return fn ? this.bind( str_hashchange, fn ) : this.trigger( str_hashchange );
  };
  
  // Property: jQuery.fn.hashchange.delay
  // 
  // The numeric interval (in milliseconds) at which the <hashchange event>
  // polling loop executes. Defaults to 50.
  
  // Property: jQuery.fn.hashchange.domain
  // 
  // If you're setting document.domain in your JavaScript, and you want hash
  // history to work in IE6/7, not only must this property be set, but you must
  // also set document.domain BEFORE jQuery is loaded into the page. This
  // property is only applicable if you are supporting IE6/7 (or IE8 operating
  // in "IE7 compatibility" mode).
  // 
  // In addition, the <jQuery.fn.hashchange.src> property must be set to the
  // path of the included "document-domain.html" file, which can be renamed or
  // modified if necessary (note that the document.domain specified must be the
  // same in both your main JavaScript as well as in this file).
  // 
  // Usage:
  // 
  // jQuery.fn.hashchange.domain = document.domain;
  
  // Property: jQuery.fn.hashchange.src
  // 
  // If, for some reason, you need to specify an Iframe src file (for example,
  // when setting document.domain as in <jQuery.fn.hashchange.domain>), you can
  // do so using this property. Note that when using this property, history
  // won't be recorded in IE6/7 until the Iframe src file loads. This property
  // is only applicable if you are supporting IE6/7 (or IE8 operating in "IE7
  // compatibility" mode).
  // 
  // Usage:
  // 
  // jQuery.fn.hashchange.src = 'path/to/file.html';
  
  $.fn[ str_hashchange ].delay = 50;
  /*
  $.fn[ str_hashchange ].domain = null;
  $.fn[ str_hashchange ].src = null;
  */
  
  // Event: hashchange event
  // 
  // Fired when location.hash changes. In browsers that support it, the native
  // HTML5 window.onhashchange event is used, otherwise a polling loop is
  // initialized, running every <jQuery.fn.hashchange.delay> milliseconds to
  // see if the hash has changed. In IE6/7 (and IE8 operating in "IE7
  // compatibility" mode), a hidden Iframe is created to allow the back button
  // and hash-based history to work.
  // 
  // Usage as described in <jQuery.fn.hashchange>:
  // 
  // > // Bind an event handler.
  // > jQuery(window).hashchange( function(e) {
  // >   var hash = location.hash;
  // >   ...
  // > });
  // > 
  // > // Manually trigger the event handler.
  // > jQuery(window).hashchange();
  // 
  // A more verbose usage that allows for event namespacing:
  // 
  // > // Bind an event handler.
  // > jQuery(window).bind( 'hashchange', function(e) {
  // >   var hash = location.hash;
  // >   ...
  // > });
  // > 
  // > // Manually trigger the event handler.
  // > jQuery(window).trigger( 'hashchange' );
  // 
  // Additional Notes:
  // 
  // * The polling loop and Iframe are not created until at least one handler
  //   is actually bound to the 'hashchange' event.
  // * If you need the bound handler(s) to execute immediately, in cases where
  //   a location.hash exists on page load, via bookmark or page refresh for
  //   example, use jQuery(window).hashchange() or the more verbose 
  //   jQuery(window).trigger( 'hashchange' ).
  // * The event can be bound before DOM ready, but since it won't be usable
  //   before then in IE6/7 (due to the necessary Iframe), recommended usage is
  //   to bind it inside a DOM ready handler.
  
  // Override existing $.event.special.hashchange methods (allowing this plugin
  // to be defined after jQuery BBQ in BBQ's source code).
  special[ str_hashchange ] = $.extend( special[ str_hashchange ], {
    
    // Called only when the first 'hashchange' event is bound to window.
    setup: function() {
      // If window.onhashchange is supported natively, there's nothing to do..
      if ( supports_onhashchange ) { return false; }
      
      // Otherwise, we need to create our own. And we don't want to call this
      // until the user binds to the event, just in case they never do, since it
      // will create a polling loop and possibly even a hidden Iframe.
      $( fake_onhashchange.start );
    },
    
    // Called only when the last 'hashchange' event is unbound from window.
    teardown: function() {
      // If window.onhashchange is supported natively, there's nothing to do..
      if ( supports_onhashchange ) { return false; }
      
      // Otherwise, we need to stop ours (if possible).
      $( fake_onhashchange.stop );
    }
    
  });
  
  // fake_onhashchange does all the work of triggering the window.onhashchange
  // event for browsers that don't natively support it, including creating a
  // polling loop to watch for hash changes and in IE 6/7 creating a hidden
  // Iframe to enable back and forward.
  fake_onhashchange = (function(){
    var self = {},
      timeout_id,
      
      // Remember the initial hash so it doesn't get triggered immediately.
      last_hash = get_fragment(),
      
      fn_retval = function(val){ return val; },
      history_set = fn_retval,
      history_get = fn_retval;
    
    // Start the polling loop.
    self.start = function() {
      timeout_id || poll();
    };
    
    // Stop the polling loop.
    self.stop = function() {
      timeout_id && clearTimeout( timeout_id );
      timeout_id = undefined;
    };
    
    // This polling loop checks every $.fn.hashchange.delay milliseconds to see
    // if location.hash has changed, and triggers the 'hashchange' event on
    // window when necessary.
    function poll() {
      var hash = get_fragment(),
        history_hash = history_get( last_hash );
      
      if ( hash !== last_hash ) {
        history_set( last_hash = hash, history_hash );
        
        $(window).trigger( str_hashchange );
        
      } else if ( history_hash !== last_hash ) {
        location.href = location.href.replace( /#.*/, '' ) + history_hash;
      }
      
      timeout_id = setTimeout( poll, $.fn[ str_hashchange ].delay );
    };
    
    // vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
    // vvvvvvvvvvvvvvvvvvv REMOVE IF NOT SUPPORTING IE6/7/8 vvvvvvvvvvvvvvvvvvv
    // vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
    $.browser.msie && !supports_onhashchange && (function(){
      // Not only do IE6/7 need the "magical" Iframe treatment, but so does IE8
      // when running in "IE7 compatibility" mode.
      
      var iframe,
        iframe_src;
      
      // When the event is bound and polling starts in IE 6/7, create a hidden
      // Iframe for history handling.
      self.start = function(){
        if ( !iframe ) {
          iframe_src = $.fn[ str_hashchange ].src;
          iframe_src = iframe_src && iframe_src + get_fragment();
          
          // Create hidden Iframe. Attempt to make Iframe as hidden as possible
          // by using techniques from http://www.paciellogroup.com/blog/?p=604.
          iframe = $('<iframe tabindex="-1" title="empty"/>').hide()
            
            // When Iframe has completely loaded, initialize the history and
            // start polling.
            .one( 'load', function(){
              iframe_src || history_set( get_fragment() );
              poll();
            })
            
            // Load Iframe src if specified, otherwise nothing.
            .attr( 'src', iframe_src || 'javascript:0' )
            
            // Append Iframe after the end of the body to prevent unnecessary
            // initial page scrolling (yes, this works).
            .insertAfter( 'body' )[0].contentWindow;
          
          // Whenever `document.title` changes, update the Iframe's title to
          // prettify the back/next history menu entries. Since IE sometimes
          // errors with "Unspecified error" the very first time this is set
          // (yes, very useful) wrap this with a try/catch block.
          doc.onpropertychange = function(){
            try {
              if ( event.propertyName === 'title' ) {
                iframe.document.title = doc.title;
              }
            } catch(e) {}
          };
          
        }
      };
      
      // Override the "stop" method since an IE6/7 Iframe was created. Even
      // if there are no longer any bound event handlers, the polling loop
      // is still necessary for back/next to work at all!
      self.stop = fn_retval;
      
      // Get history by looking at the hidden Iframe's location.hash.
      history_get = function() {
        return get_fragment( iframe.location.href );
      };
      
      // Set a new history item by opening and then closing the Iframe
      // document, *then* setting its location.hash. If document.domain has
      // been set, update that as well.
      history_set = function( hash, history_hash ) {
        var iframe_doc = iframe.document,
          domain = $.fn[ str_hashchange ].domain;
        
        if ( hash !== history_hash ) {
          // Update Iframe with any initial `document.title` that might be set.
          iframe_doc.title = doc.title;
          
          // Opening the Iframe's document after it has been closed is what
          // actually adds a history entry.
          iframe_doc.open();
          
          // Set document.domain for the Iframe document as well, if necessary.
          
          iframe_doc.close();
          
          // Update the Iframe's hash, for great justice.
          iframe.location.hash = hash;
        }
      };
      
    })();
    // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    // ^^^^^^^^^^^^^^^^^^^ REMOVE IF NOT SUPPORTING IE6/7/8 ^^^^^^^^^^^^^^^^^^^
    // ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    
    return self;
  })();
  
})(jQuery,this);</script>

		<script type="text/javascript"> http://www.bennadel.com/blog/1504-Ask-Ben-Parsing-CSV-Strings-With-Javascript-Exec-Regular-Expression-Command.htm
// This will parse a delimited string into an array of
// arrays. The default delimiter is the comma, but this
// can be overriden in the second argument.
function CSVToArray( strData, strDelimiter ){
// Check to see if the delimiter is defined. If not,
// then default to comma.
strDelimiter = (strDelimiter || ",");
 
// Create a regular expression to parse the CSV values.
var objPattern = new RegExp(
(
// Delimiters.
"(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
 
// Quoted fields.
"(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
 
// Standard fields.
"([^\"\\" + strDelimiter + "\\r\\n]*))"
),
"gi"
);
 
 
// Create an array to hold our data. Give the array
// a default empty first row.
var arrData = [[]];
 
// Create an array to hold our individual pattern
// matching groups.
var arrMatches = null;
 
 
// Keep looping over the regular expression matches
// until we can no longer find a match.
while (arrMatches = objPattern.exec( strData )){
 
// Get the delimiter that was found.
var strMatchedDelimiter = arrMatches[ 1 ];
 
// Check to see if the given delimiter has a length
// (is not the start of string) and if it matches
// field delimiter. If id does not, then we know
// that this delimiter is a row delimiter.
if (
strMatchedDelimiter.length &&
(strMatchedDelimiter != strDelimiter)
){
 
// Since we have reached a new row of data,
// add an empty row to our data array.
arrData.push( [] );
 
}
 
 
// Now that we have our delimiter out of the way,
// let's check to see which kind of value we
// captured (quoted or unquoted).
if (arrMatches[ 2 ]){
 
// We found a quoted value. When we capture
// this value, unescape any double quotes.
var strMatchedValue = arrMatches[ 2 ].replace(
new RegExp( "\"\"", "g" ),
"\""
);
 
} else {
 
// We found a non-quoted value.
var strMatchedValue = arrMatches[ 3 ];
 
}
 
 
// Now that we have our value string, let's add
// it to the data array.
arrData[ arrData.length - 1 ].push( strMatchedValue );
}
 
// Return the parsed data.
return( arrData );
}</script>
		<script type="text/javascript">/*
 strftime for Javascript
 Copyright (c) 2008, Philip S Tellis <philip@bluesmoon.info>
 All rights reserved.
 
 This code is distributed under the terms of the BSD licence
 
 Redistribution and use of this software in source and binary forms, with or without modification,
 are permitted provided that the following conditions are met:

   * Redistributions of source code must retain the above copyright notice, this list of conditions
     and the following disclaimer.
   * Redistributions in binary form must reproduce the above copyright notice, this list of
     conditions and the following disclaimer in the documentation and/or other materials provided
     with the distribution.
   * The names of the contributors to this file may not be used to endorse or promote products
     derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED
WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/**
 * \file strftime.js
 * \author Philip S Tellis \<philip@bluesmoon.info\>
 * \version 1.3
 * \date 2008/06
 * \brief Javascript implementation of strftime
 * 
 * Implements strftime for the Date object in javascript based on the PHP implementation described at
 * http://www.php.net/strftime  This is in turn based on the Open Group specification defined
 * at http://www.opengroup.org/onlinepubs/007908799/xsh/strftime.html This implementation does not
 * include modified conversion specifiers (i.e., Ex and Ox)
 *
 * The following format specifiers are supported:
 *
 * \copydoc formats
 *
 * \%a, \%A, \%b and \%B should be localised for non-English locales.
 *
 * \par Usage:
 * This library may be used as follows:
 * \code
 *     var d = new Date();
 *
 *     var ymd = d.strftime('%Y/%m/%d');
 *     var iso = d.strftime('%Y-%m-%dT%H:%M:%S%z');
 *
 * \endcode
 *
 * \sa \link Date.prototype.strftime Date.strftime \endlink for a description of each of the supported format specifiers
 * \sa Date.ext.locales for localisation information
 * \sa http://www.php.net/strftime for the PHP implementation which is the basis for this
 * \sa http://tech.bluesmoon.info/2008/04/strftime-in-javascript.html for feedback
 */

//! Date extension object - all supporting objects go in here.
Date.ext = {};

//! Utility methods
Date.ext.util = {};

/**
\brief Left pad a number with something
\details Takes a number and pads it to the left with the passed in pad character
\param x	The number to pad
\param pad	The string to pad with
\param r	[optional] Upper limit for pad.  A value of 10 pads to 2 digits, a value of 100 pads to 3 digits.
		Default is 10.

\return The number left padded with the pad character.  This function returns a string and not a number.
*/
Date.ext.util.xPad=function(x, pad, r)
{
	if(typeof(r) == 'undefined')
	{
		r=10;
	}
	for( ; parseInt(x, 10)<r && r>1; r/=10)
		x = pad.toString() + x;
	return x.toString();
};

/**
\brief Currently selected locale.
\details
The locale for a specific date object may be changed using \code Date.locale = "new-locale"; \endcode
The default will be based on the lang attribute of the HTML tag of your document
*/
Date.prototype.locale = 'en-GB';
//! \cond FALSE
if(document.getElementsByTagName('html') && document.getElementsByTagName('html')[0].lang)
{
	Date.prototype.locale = document.getElementsByTagName('html')[0].lang;
}
//! \endcond

/**
\brief Localised strings for days of the week and months of the year.
\details
To create your own local strings, add a locale object to the locales object.
The key of your object should be the same as your locale name.  For example:
   en-US,
   fr,
   fr-CH,
   de-DE
Names are case sensitive and are described at http://www.w3.org/TR/REC-html40/struct/dirlang.html#langcodes
Your locale object must contain the following keys:
\param a	Short names of days of week starting with Sunday
\param A	Long names days of week starting with Sunday
\param b	Short names of months of the year starting with January
\param B	Long names of months of the year starting with February
\param c	The preferred date and time representation in your locale
\param p	AM or PM in your locale
\param P	am or pm in your locale
\param x	The  preferred date representation for the current locale without the time.
\param X	The preferred time representation for the current locale without the date.

\sa Date.ext.locales.en for a sample implementation
\sa \ref localisation for detailed documentation on localising strftime for your own locale
*/
Date.ext.locales = { };

/**
 * \brief Localised strings for English (British).
 * \details
 * This will be used for any of the English dialects unless overridden by a country specific one.
 * This is the default locale if none specified
 */
Date.ext.locales.en = {
	a: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
	A: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
	b: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
	B: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
	c: '%a %d %b %Y %T %Z',
	p: ['AM', 'PM'],
	P: ['am', 'pm'],
	x: '%d/%m/%y',
	X: '%T'
};

//! \cond FALSE
// Localised strings for US English
Date.ext.locales['en-US'] = Date.ext.locales.en;
Date.ext.locales['en-US'].c = '%a %d %b %Y %r %Z';
Date.ext.locales['en-US'].x = '%D';
Date.ext.locales['en-US'].X = '%r';

// Localised strings for British English
Date.ext.locales['en-GB'] = Date.ext.locales.en;

// Localised strings for Australian English
Date.ext.locales['en-AU'] = Date.ext.locales['en-GB'];
//! \endcond

//! \brief List of supported format specifiers.
/**
 * \details
 * \arg \%a - abbreviated weekday name according to the current locale
 * \arg \%A - full weekday name according to the current locale
 * \arg \%b - abbreviated month name according to the current locale
 * \arg \%B - full month name according to the current locale
 * \arg \%c - preferred date and time representation for the current locale
 * \arg \%C - century number (the year divided by 100 and truncated to an integer, range 00 to 99)
 * \arg \%d - day of the month as a decimal number (range 01 to 31)
 * \arg \%D - same as %m/%d/%y
 * \arg \%e - day of the month as a decimal number, a single digit is preceded by a space (range ' 1' to '31')
 * \arg \%g - like %G, but without the century
 * \arg \%G - The 4-digit year corresponding to the ISO week number
 * \arg \%h - same as %b
 * \arg \%H - hour as a decimal number using a 24-hour clock (range 00 to 23)
 * \arg \%I - hour as a decimal number using a 12-hour clock (range 01 to 12)
 * \arg \%j - day of the year as a decimal number (range 001 to 366)
 * \arg \%m - month as a decimal number (range 01 to 12)
 * \arg \%M - minute as a decimal number
 * \arg \%n - newline character
 * \arg \%p - either `AM' or `PM' according to the given time value, or the corresponding strings for the current locale
 * \arg \%P - like %p, but lower case
 * \arg \%r - time in a.m. and p.m. notation equal to %I:%M:%S %p
 * \arg \%R - time in 24 hour notation equal to %H:%M
 * \arg \%S - second as a decimal number
 * \arg \%t - tab character
 * \arg \%T - current time, equal to %H:%M:%S
 * \arg \%u - weekday as a decimal number [1,7], with 1 representing Monday
 * \arg \%U - week number of the current year as a decimal number, starting with
 *            the first Sunday as the first day of the first week
 * \arg \%V - The ISO 8601:1988 week number of the current year as a decimal number,
 *            range 01 to 53, where week 1 is the first week that has at least 4 days
 *            in the current year, and with Monday as the first day of the week.
 * \arg \%w - day of the week as a decimal, Sunday being 0
 * \arg \%W - week number of the current year as a decimal number, starting with the
 *            first Monday as the first day of the first week
 * \arg \%x - preferred date representation for the current locale without the time
 * \arg \%X - preferred time representation for the current locale without the date
 * \arg \%y - year as a decimal number without a century (range 00 to 99)
 * \arg \%Y - year as a decimal number including the century
 * \arg \%z - numerical time zone representation
 * \arg \%Z - time zone name or abbreviation
 * \arg \%% - a literal `\%' character
 */
Date.ext.formats = {
	a: function(d) { return Date.ext.locales[d.locale].a[d.getDay()]; },
	A: function(d) { return Date.ext.locales[d.locale].A[d.getDay()]; },
	b: function(d) { return Date.ext.locales[d.locale].b[d.getMonth()]; },
	B: function(d) { return Date.ext.locales[d.locale].B[d.getMonth()]; },
	c: 'toLocaleString',
	C: function(d) { return Date.ext.util.xPad(parseInt(d.getFullYear()/100, 10), 0); },
	d: ['getDate', '0'],
	e: ['getDate', ' '],
	g: function(d) { return Date.ext.util.xPad(parseInt(Date.ext.util.G(d)/100, 10), 0); },
	G: function(d) {
			var y = d.getFullYear();
			var V = parseInt(Date.ext.formats.V(d), 10);
			var W = parseInt(Date.ext.formats.W(d), 10);

			if(W > V) {
				y++;
			} else if(W===0 && V>=52) {
				y--;
			}

			return y;
		},
	H: ['getHours', '0'],
	I: function(d) { var I=d.getHours()%12; return Date.ext.util.xPad(I===0?12:I, 0); },
	j: function(d) {
			var ms = d - new Date('' + d.getFullYear() + '/1/1 GMT');
			ms += d.getTimezoneOffset()*60000;
			var doy = parseInt(ms/60000/60/24, 10)+1;
			return Date.ext.util.xPad(doy, 0, 100);
		},
	m: function(d) { return Date.ext.util.xPad(d.getMonth()+1, 0); },
	M: ['getMinutes', '0'],
	p: function(d) { return Date.ext.locales[d.locale].p[d.getHours() >= 12 ? 1 : 0 ]; },
	P: function(d) { return Date.ext.locales[d.locale].P[d.getHours() >= 12 ? 1 : 0 ]; },
	S: ['getSeconds', '0'],
	u: function(d) { var dow = d.getDay(); return dow===0?7:dow; },
	U: function(d) {
			var doy = parseInt(Date.ext.formats.j(d), 10);
			var rdow = 6-d.getDay();
			var woy = parseInt((doy+rdow)/7, 10);
			return Date.ext.util.xPad(woy, 0);
		},
	V: function(d) {
			var woy = parseInt(Date.ext.formats.W(d), 10);
			var dow1_1 = (new Date('' + d.getFullYear() + '/1/1')).getDay();
			// First week is 01 and not 00 as in the case of %U and %W,
			// so we add 1 to the final result except if day 1 of the year
			// is a Monday (then %W returns 01).
			// We also need to subtract 1 if the day 1 of the year is 
			// Friday-Sunday, so the resulting equation becomes:
			var idow = woy + (dow1_1 > 4 || dow1_1 <= 1 ? 0 : 1);
			if(idow == 53 && (new Date('' + d.getFullYear() + '/12/31')).getDay() < 4)
			{
				idow = 1;
			}
			else if(idow === 0)
			{
				idow = Date.ext.formats.V(new Date('' + (d.getFullYear()-1) + '/12/31'));
			}

			return Date.ext.util.xPad(idow, 0);
		},
	w: 'getDay',
	W: function(d) {
			var doy = parseInt(Date.ext.formats.j(d), 10);
			var rdow = 7-Date.ext.formats.u(d);
			var woy = parseInt((doy+rdow)/7, 10);
			return Date.ext.util.xPad(woy, 0, 10);
		},
	y: function(d) { return Date.ext.util.xPad(d.getFullYear()%100, 0); },
	Y: 'getFullYear',
	z: function(d) {
			var o = d.getTimezoneOffset();
			var H = Date.ext.util.xPad(parseInt(Math.abs(o/60), 10), 0);
			var M = Date.ext.util.xPad(o%60, 0);
			return (o>0?'-':'+') + H + M;
		},
	Z: function(d) { return d.toString().replace(/^.*\(([^)]+)\)$/, '$1'); },
	'%': function(d) { return '%'; }
};

/**
\brief List of aggregate format specifiers.
\details
Aggregate format specifiers map to a combination of basic format specifiers.
These are implemented in terms of Date.ext.formats.

A format specifier that maps to 'locale' is read from Date.ext.locales[current-locale].

\sa Date.ext.formats
*/
Date.ext.aggregates = {
	c: 'locale',
	D: '%m/%d/%y',
	h: '%b',
	n: '\n',
	r: '%I:%M:%S %p',
	R: '%H:%M',
	t: '\t',
	T: '%H:%M:%S',
	x: 'locale',
	X: 'locale'
};

//! \cond FALSE
// Cache timezone values because they will never change for a given JS instance
Date.ext.aggregates.z = Date.ext.formats.z(new Date());
Date.ext.aggregates.Z = Date.ext.formats.Z(new Date());
//! \endcond

//! List of unsupported format specifiers.
/**
 * \details
 * All format specifiers supported by the PHP implementation are supported by
 * this javascript implementation.
 */
Date.ext.unsupported = { };


/**
 * \brief Formats the date according to the specified format.
 * \param fmt	The format to format the date in.  This may be a combination of the following:
 * \copydoc formats
 *
 * \return	A string representation of the date formatted based on the passed in parameter
 * \sa http://www.php.net/strftime for documentation on format specifiers
*/
Date.prototype.strftime=function(fmt)
{
	// Fix locale if declared locale hasn't been defined
	// After the first call this condition should never be entered unless someone changes the locale
	if(!(this.locale in Date.ext.locales))
	{
		if(this.locale.replace(/-[a-zA-Z]+$/, '') in Date.ext.locales)
		{
			this.locale = this.locale.replace(/-[a-zA-Z]+$/, '');
		}
		else
		{
			this.locale = 'en-GB';
		}
	}

	var d = this;
	// First replace aggregates
	while(fmt.match(/%[cDhnrRtTxXzZ]/))
	{
		fmt = fmt.replace(/%([cDhnrRtTxXzZ])/g, function(m0, m1)
				{
					var f = Date.ext.aggregates[m1];
					return (f == 'locale' ? Date.ext.locales[d.locale][m1] : f);
				});
	}


	// Now replace formats - we need a closure so that the date object gets passed through
	var str = fmt.replace(/%([aAbBCdegGHIjmMpPSuUVwWyY%])/g, function(m0, m1) 
			{
				var f = Date.ext.formats[m1];
				if(typeof(f) == 'string') {
					return d[f]();
				} else if(typeof(f) == 'function') {
					return f.call(d, d);
				} else if(typeof(f) == 'object' && typeof(f[0]) == 'string') {
					return Date.ext.util.xPad(d[f[0]](), f[1]);
				} else {
					return m1;
				}
			});
	d=null;
	return str;
};

/**
 * \mainpage strftime for Javascript
 *
 * \section toc Table of Contents
 * - \ref intro_sec
 * - <a class="el" href="strftime.js">Download full source</a> / <a class="el" href="strftime-min.js">minified</a>
 * - \subpage usage
 * - \subpage format_specifiers
 * - \subpage localisation
 * - \link strftime.js API Documentation \endlink
 * - \subpage demo
 * - \subpage changelog
 * - \subpage faq
 * - <a class="el" href="http://tech.bluesmoon.info/2008/04/strftime-in-javascript.html">Feedback</a>
 * - \subpage copyright_licence
 *
 * \section intro_sec Introduction
 *
 * C and PHP developers have had access to a built in strftime function for a long time.
 * This function is an easy way to format dates and times for various display needs.
 *
 * This library brings the flexibility of strftime to the javascript Date object
 *
 * Use this library if you frequently need to format dates in javascript in a variety of ways.  For example,
 * if you have PHP code that writes out formatted dates, and want to mimic the functionality using
 * progressively enhanced javascript, then this library can do exactly what you want.
 *
 *
 *
 *
 * \page usage Example usage
 *
 * \section usage_sec Usage
 * This library may be used as follows:
 * \code
 *     var d = new Date();
 *
 *     var ymd = d.strftime('%Y/%m/%d');
 *     var iso = d.strftime('%Y-%m-%dT%H:%M:%S%z');
 *
 * \endcode
 *
 * \subsection examples Examples
 * 
 * To get the current time in hours and minutes:
 * \code
 * 	var d = new Date();
 * 	d.strftime("%H:%M");
 * \endcode
 *
 * To get the current time with seconds in AM/PM notation:
 * \code
 * 	var d = new Date();
 * 	d.strftime("%r");
 * \endcode
 *
 * To get the year and day of the year for August 23, 2009:
 * \code
 * 	var d = new Date('2009/8/23');
 * 	d.strftime("%Y-%j");
 * \endcode
 *
 * \section demo_sec Demo
 *
 * Try your own examples on the \subpage demo page.  You can use any of the supported
 * \subpage format_specifiers.
 *
 *
 *
 *
 * \page localisation Localisation
 * You can localise strftime by implementing the short and long forms for days of the
 * week and months of the year, and the localised aggregates for the preferred date
 * and time representation for your locale.  You need to add your locale to the
 * Date.ext.locales object.
 *
 * \section localising_fr Localising for french
 *
 * For example, this is how we'd add French language strings to the locales object:
 * \dontinclude index.html
 * \skip Generic french
 * \until };
 * The % format specifiers are all defined in \ref formats.  You can use any of those.
 *
 * This locale definition may be included in your own source file, or in the HTML file
 * including \c strftime.js, however it must be defined \em after including \c strftime.js
 *
 * The above definition includes generic french strings and formats that are used in France.
 * Other french speaking countries may have other representations for dates and times, so we
 * need to override this for them.  For example, Canadian french uses a Y-m-d date format,
 * while French french uses d.m.Y.  We fix this by defining Canadian french to be the same
 * as generic french, and then override the format specifiers for \c x for the \c fr-CA locale:
 * \until End french
 *
 * You can now use any of the French locales at any time by setting \link Date.prototype.locale Date.locale \endlink
 * to \c "fr", \c "fr-FR", \c "fr-CA", or any other french dialect:
 * \code
 *     var d = new Date("2008/04/22");
 *     d.locale = "fr";
 *
 *     d.strftime("%A, %d %B == %x");
 * \endcode
 * will return:
 * \code
 *     mardi, 22 avril == 22.04.2008
 * \endcode
 * While changing the locale to "fr-CA":
 * \code
 *     d.locale = "fr-CA";
 *
 *     d.strftime("%A, %d %B == %x");
 * \endcode
 * will return:
 * \code
 *     mardi, 22 avril == 2008-04-22
 * \endcode
 *
 * You can use any of the format specifiers defined at \ref formats
 *
 * The locale for all dates defaults to the value of the \c lang attribute of your HTML document if
 * it is set, or to \c "en" otherwise.
 * \note
 * Your locale definitions \b MUST be added to the locale object before calling
 * \link Date.prototype.strftime Date.strftime \endlink.
 *
 * \sa \ref formats for a list of format specifiers that can be used in your definitions
 * for c, x and X.
 *
 * \section locale_names Locale names
 *
 * Locale names are defined in RFC 1766. Typically, a locale would be a two letter ISO639
 * defined language code and an optional ISO3166 defined country code separated by a -
 * 
 * eg: fr-FR, de-DE, hi-IN
 *
 * \sa http://www.ietf.org/rfc/rfc1766.txt
 * \sa http://www.loc.gov/standards/iso639-2/php/code_list.php
 * \sa http://www.iso.org/iso/country_codes/iso_3166_code_lists/english_country_names_and_code_elements.htm
 * 
 * \section locale_fallback Locale fallbacks
 *
 * If a locale object corresponding to the fully specified locale isn't found, an attempt will be made
 * to fall back to the two letter language code.  If a locale object corresponding to that isn't found
 * either, then the locale will fall back to \c "en".  No warning will be issued.
 *
 * For example, if we define a locale for de:
 * \until };
 * Then set the locale to \c "de-DE":
 * \code
 *     d.locale = "de-DE";
 *
 *     d.strftime("%a, %d %b");
 * \endcode
 * In this case, the \c "de" locale will be used since \c "de-DE" has not been defined:
 * \code
 *     Di, 22 Apr
 * \endcode
 *
 * Swiss german will return the same since it will also fall back to \c "de":
 * \code
 *     d.locale = "de-CH";
 *
 *     d.strftime("%a, %d %b");
 * \endcode
 * \code
 *     Di, 22 Apr
 * \endcode
 *
 * We need to override the \c a specifier for Swiss german, since it's different from German german:
 * \until End german
 * We now get the correct results:
 * \code
 *     d.locale = "de-CH";
 *
 *     d.strftime("%a, %d %b");
 * \endcode
 * \code
 *     Die, 22 Apr
 * \endcode
 *
 * \section builtin_locales Built in locales
 *
 * This library comes with pre-defined locales for en, en-GB, en-US and en-AU.
 *
 * 
 *
 *
 * \page format_specifiers Format specifiers
 * 
 * \section specifiers Format specifiers
 * strftime has several format specifiers defined by the Open group at 
 * http://www.opengroup.org/onlinepubs/007908799/xsh/strftime.html
 *
 * PHP added a few of its own, defined at http://www.php.net/strftime
 *
 * This javascript implementation supports all the PHP specifiers
 *
 * \subsection supp Supported format specifiers:
 * \copydoc formats
 * 
 * \subsection unsupportedformats Unsupported format specifiers:
 * \copydoc unsupported
 *
 *
 *
 *
 * \page demo strftime demo
 * <div style="float:right;width:45%;">
 * \copydoc formats
 * </div>
 * \htmlinclude index.html
 *
 *
 *
 *
 * \page faq FAQ
 * 
 * \section how_tos Usage
 *
 * \subsection howtouse Is there a manual on how to use this library?
 *
 * Yes, see \ref usage
 *
 * \subsection wheretoget Where can I get a minified version of this library?
 *
 * The minified version is available <a href="strftime-min.js" title="Minified strftime.js">here</a>.
 *
 * \subsection which_specifiers Which format specifiers are supported?
 *
 * See \ref format_specifiers
 *
 * \section whys Why?
 *
 * \subsection why_lib Why this library?
 *
 * I've used the strftime function in C, PHP and the Unix shell, and found it very useful
 * to do date formatting.  When I needed to do date formatting in javascript, I decided
 * that it made the most sense to just reuse what I'm already familiar with.
 *
 * \subsection why_another Why another strftime implementation for Javascript?
 *
 * Yes, there are other strftime implementations for Javascript, but I saw problems with
 * all of them that meant I couldn't use them directly.  Some implementations had bad
 * designs.  For example, iterating through all possible specifiers and scanning the string
 * for them.  Others were tied to specific libraries like prototype.
 *
 * Trying to extend any of the existing implementations would have required only slightly
 * less effort than writing this from scratch.  In the end it took me just about 3 hours
 * to write the code and about 6 hours battling with doxygen to write these docs.
 *
 * I also had an idea of how I wanted to implement this, so decided to try it.
 *
 * \subsection why_extend_date Why extend the Date class rather than subclass it?
 *
 * I tried subclassing Date and failed.  I didn't want to waste time on figuring
 * out if there was a problem in my code or if it just wasn't possible.  Adding to the
 * Date.prototype worked well, so I stuck with it.
 *
 * I did have some worries because of the way for..in loops got messed up after json.js added
 * to the Object.prototype, but that isn't an issue here since {} is not a subclass of Date.
 *
 * My last doubt was about the Date.ext namespace that I created.  I still don't like this,
 * but I felt that \c ext at least makes clear that this is external or an extension.
 *
 * It's quite possible that some future version of javascript will add an \c ext or a \c locale
 * or a \c strftime property/method to the Date class, but this library should probably
 * check for capabilities before doing what it does.
 *
 * \section curiosity Curiosity
 *
 * \subsection how_big How big is the code?
 *
 * \arg 26K bytes with documentation
 * \arg 4242 bytes minified using <a href="http://developer.yahoo.com/yui/compressor/">YUI Compressor</a>
 * \arg 1477 bytes minified and gzipped
 *
 * \subsection how_long How long did it take to write this?
 *
 * 15 minutes for the idea while I was composing this blog post:
 * http://tech.bluesmoon.info/2008/04/javascript-date-functions.html
 *
 * 3 hours in one evening to write v1.0 of the code and 6 hours the same
 * night to write the docs and this manual.  As you can tell, I'm fairly
 * sleepy.
 *
 * Versions 1.1 and 1.2 were done in a couple of hours each, and version 1.3
 * in under one hour.
 *
 * \section contributing Contributing
 *
 * \subsection how_to_rfe How can I request features or make suggestions?
 *
 * You can leave a comment on my blog post about this library here:
 * http://tech.bluesmoon.info/2008/04/strftime-in-javascript.html
 *
 * \subsection how_to_contribute Can I/How can I contribute code to this library?
 *
 * Yes, that would be very nice, thank you.  You can do various things.  You can make changes
 * to the library, and make a diff against the current file and mail me that diff at
 * philip@bluesmoon.info, or you could just host the new file on your own servers and add
 * your name to the copyright list at the top stating which parts you've added.
 *
 * If you do mail me a diff, let me know how you'd like to be listed in the copyright section.
 *
 * \subsection copyright_signover Who owns the copyright on contributed code?
 *
 * The contributor retains copyright on contributed code.
 *
 * In some cases I may use contributed code as a template and write the code myself.  In this
 * case I'll give the contributor credit for the idea, but will not add their name to the
 * copyright holders list.
 *
 *
 *
 *
 * \page copyright_licence Copyright & Licence
 *
 * \section copyright Copyright
 * \dontinclude strftime.js
 * \skip Copyright
 * \until rights
 *
 * \section licence Licence
 * \skip This code
 * \until SUCH DAMAGE.
 *
 *
 *
 * \page changelog ChangeLog
 *
 * \par 1.3 - 2008/06/17:
 * - Fixed padding issue with negative timezone offsets in %r
 *   reported and fixed by Mikko <mikko.heimola@iki.fi>
 * - Added support for %P
 * - Internationalised %r, %p and %P
 *
 * \par 1.2 - 2008/04/27:
 * - Fixed support for c (previously it just returned toLocaleString())
 * - Add support for c, x and X
 * - Add locales for en-GB, en-US and en-AU
 * - Make en-GB the default locale (previous was en)
 * - Added more localisation docs
 *
 * \par 1.1 - 2008/04/27:
 * - Fix bug in xPad which wasn't padding more than a single digit
 * - Fix bug in j which had an off by one error for days after March 10th because of daylight savings
 * - Add support for g, G, U, V and W
 *
 * \par 1.0 - 2008/04/22:
 * - Initial release with support for a, A, b, B, c, C, d, D, e, H, I, j, m, M, p, r, R, S, t, T, u, w, y, Y, z, Z, and %
 */
</script>
		<script type="text/javascript">/**
sprintf() for JavaScript 0.7-beta1
http://www.diveintojavascript.com/projects/javascript-sprintf

Copyright (c) Alexandru Marasteanu <alexaholic [at) gmail (dot] com>
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:
    * Redistributions of source code must retain the above copyright
      notice, this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.
    * Neither the name of sprintf() for JavaScript nor the
      names of its contributors may be used to endorse or promote products
      derived from this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL Alexandru Marasteanu BE LIABLE FOR ANY
DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


Changelog:
2010.09.06 - 0.7-beta1
  - features: vsprintf, support for named placeholders
  - enhancements: format cache, reduced global namespace pollution

2010.05.22 - 0.6:
 - reverted to 0.4 and fixed the bug regarding the sign of the number 0
 Note:
 Thanks to Raphael Pigulla <raph (at] n3rd [dot) org> (http://www.n3rd.org/)
 who warned me about a bug in 0.5, I discovered that the last update was
 a regress. I appologize for that.

2010.05.09 - 0.5:
 - bug fix: 0 is now preceeded with a + sign
 - bug fix: the sign was not at the right position on padded results (Kamal Abdali)
 - switched from GPL to BSD license

2007.10.21 - 0.4:
 - unit test and patch (David Baird)

2007.09.17 - 0.3:
 - bug fix: no longer throws exception on empty paramenters (Hans Pufal)

2007.09.11 - 0.2:
 - feature: added argument swapping

2007.04.03 - 0.1:
 - initial release
**/

var sprintf = (function() {
	function get_type(variable) {
		return Object.prototype.toString.call(variable).slice(8, -1).toLowerCase();
	}
	function str_repeat(input, multiplier) {
		for (var output = []; multiplier > 0; output[--multiplier] = input) {/* do nothing */}
		return output.join('');
	}

	var str_format = function() {
		if (!str_format.cache.hasOwnProperty(arguments[0])) {
			str_format.cache[arguments[0]] = str_format.parse(arguments[0]);
		}
		return str_format.format.call(null, str_format.cache[arguments[0]], arguments);
	};

	str_format.format = function(parse_tree, argv) {
		var cursor = 1, tree_length = parse_tree.length, node_type = '', arg, output = [], i, k, match, pad, pad_character, pad_length;
		for (i = 0; i < tree_length; i++) {
			node_type = get_type(parse_tree[i]);
			if (node_type === 'string') {
				output.push(parse_tree[i]);
			}
			else if (node_type === 'array') {
				match = parse_tree[i]; // convenience purposes only
				if (match[2]) { // keyword argument
					arg = argv[cursor];
					for (k = 0; k < match[2].length; k++) {
						if (!arg.hasOwnProperty(match[2][k])) {
							throw(sprintf('[sprintf] property "%s" does not exist', match[2][k]));
						}
						arg = arg[match[2][k]];
					}
				}
				else if (match[1]) { // positional argument (explicit)
					arg = argv[match[1]];
				}
				else { // positional argument (implicit)
					arg = argv[cursor++];
				}

				if (/[^s]/.test(match[8]) && (get_type(arg) != 'number')) {
					throw(sprintf('[sprintf] expecting number but found %s', get_type(arg)));
				}
				switch (match[8]) {
					case 'b': arg = arg.toString(2); break;
					case 'c': arg = String.fromCharCode(arg); break;
					case 'd': arg = parseInt(arg, 10); break;
					case 'e': arg = match[7] ? arg.toExponential(match[7]) : arg.toExponential(); break;
					case 'f': arg = match[7] ? parseFloat(arg).toFixed(match[7]) : parseFloat(arg); break;
					case 'o': arg = arg.toString(8); break;
					case 's': arg = ((arg = String(arg)) && match[7] ? arg.substring(0, match[7]) : arg); break;
					case 'u': arg = Math.abs(arg); break;
					case 'x': arg = arg.toString(16); break;
					case 'X': arg = arg.toString(16).toUpperCase(); break;
				}
				arg = (/[def]/.test(match[8]) && match[3] && arg >= 0 ? '+'+ arg : arg);
				pad_character = match[4] ? match[4] == '0' ? '0' : match[4].charAt(1) : ' ';
				pad_length = match[6] - String(arg).length;
				pad = match[6] ? str_repeat(pad_character, pad_length) : '';
				output.push(match[5] ? arg + pad : pad + arg);
			}
		}
		return output.join('');
	};

	str_format.cache = {};

	str_format.parse = function(fmt) {
		var _fmt = fmt, match = [], parse_tree = [], arg_names = 0;
		while (_fmt) {
			if ((match = /^[^\x25]+/.exec(_fmt)) !== null) {
				parse_tree.push(match[0]);
			}
			else if ((match = /^\x25{2}/.exec(_fmt)) !== null) {
				parse_tree.push('%');
			}
			else if ((match = /^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(_fmt)) !== null) {
				if (match[2]) {
					arg_names |= 1;
					var field_list = [], replacement_field = match[2], field_match = [];
					if ((field_match = /^([a-z_][a-z_\d]*)/i.exec(replacement_field)) !== null) {
						field_list.push(field_match[1]);
						while ((replacement_field = replacement_field.substring(field_match[0].length)) !== '') {
							if ((field_match = /^\.([a-z_][a-z_\d]*)/i.exec(replacement_field)) !== null) {
								field_list.push(field_match[1]);
							}
							else if ((field_match = /^\[(\d+)\]/.exec(replacement_field)) !== null) {
								field_list.push(field_match[1]);
							}
							else {
								throw('[sprintf] huh?');
							}
						}
					}
					else {
						throw('[sprintf] huh?');
					}
					match[2] = field_list;
				}
				else {
					arg_names |= 2;
				}
				if (arg_names === 3) {
					throw('[sprintf] mixing positional and named placeholders is not (yet) supported');
				}
				parse_tree.push(match);
			}
			else {
				throw('[sprintf] huh?');
			}
			_fmt = _fmt.substring(match[0].length);
		}
		return parse_tree;
	};

	return str_format;
})();

var vsprintf = function(fmt, argv) {
	argv.unshift(fmt);
	return sprintf.apply(null, argv);
};
</script>	
		<script type="text/javascript">/**
 * @version: 1.0 Alpha-1
 * @author: Coolite Inc. http://www.coolite.com/
 * @date: 2008-05-13
 * @copyright: Copyright (c) 2006-2008, Coolite Inc. (http://www.coolite.com/). All rights reserved.
 * @license: Licensed under The MIT License. See license.txt and http://www.datejs.com/license/. 
 * @website: http://www.datejs.com/
 */
Date.CultureInfo={name:"en-US",englishName:"English (United States)",nativeName:"English (United States)",dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],abbreviatedDayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],shortestDayNames:["Su","Mo","Tu","We","Th","Fr","Sa"],firstLetterDayNames:["S","M","T","W","T","F","S"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],abbreviatedMonthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],amDesignator:"AM",pmDesignator:"PM",firstDayOfWeek:0,twoDigitYearMax:2029,dateElementOrder:"mdy",formatPatterns:{shortDate:"M/d/yyyy",longDate:"dddd, MMMM dd, yyyy",shortTime:"h:mm tt",longTime:"h:mm:ss tt",fullDateTime:"dddd, MMMM dd, yyyy h:mm:ss tt",sortableDateTime:"yyyy-MM-ddTHH:mm:ss",universalSortableDateTime:"yyyy-MM-dd HH:mm:ssZ",rfc1123:"ddd, dd MMM yyyy HH:mm:ss GMT",monthDay:"MMMM dd",yearMonth:"MMMM, yyyy"},regexPatterns:{jan:/^jan(uary)?/i,feb:/^feb(ruary)?/i,mar:/^mar(ch)?/i,apr:/^apr(il)?/i,may:/^may/i,jun:/^jun(e)?/i,jul:/^jul(y)?/i,aug:/^aug(ust)?/i,sep:/^sep(t(ember)?)?/i,oct:/^oct(ober)?/i,nov:/^nov(ember)?/i,dec:/^dec(ember)?/i,sun:/^su(n(day)?)?/i,mon:/^mo(n(day)?)?/i,tue:/^tu(e(s(day)?)?)?/i,wed:/^we(d(nesday)?)?/i,thu:/^th(u(r(s(day)?)?)?)?/i,fri:/^fr(i(day)?)?/i,sat:/^sa(t(urday)?)?/i,future:/^next/i,past:/^last|past|prev(ious)?/i,add:/^(\+|aft(er)?|from|hence)/i,subtract:/^(\-|bef(ore)?|ago)/i,yesterday:/^yes(terday)?/i,today:/^t(od(ay)?)?/i,tomorrow:/^tom(orrow)?/i,now:/^n(ow)?/i,millisecond:/^ms|milli(second)?s?/i,second:/^sec(ond)?s?/i,minute:/^mn|min(ute)?s?/i,hour:/^h(our)?s?/i,week:/^w(eek)?s?/i,month:/^m(onth)?s?/i,day:/^d(ay)?s?/i,year:/^y(ear)?s?/i,shortMeridian:/^(a|p)/i,longMeridian:/^(a\.?m?\.?|p\.?m?\.?)/i,timezone:/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\s*(\+|\-)\s*\d\d\d\d?)|gmt|utc)/i,ordinalSuffix:/^\s*(st|nd|rd|th)/i,timeContext:/^\s*(\:|a(?!u|p)|p)/i},timezones:[{name:"UTC",offset:"-000"},{name:"GMT",offset:"-000"},{name:"EST",offset:"-0500"},{name:"EDT",offset:"-0400"},{name:"CST",offset:"-0600"},{name:"CDT",offset:"-0500"},{name:"MST",offset:"-0700"},{name:"MDT",offset:"-0600"},{name:"PST",offset:"-0800"},{name:"PDT",offset:"-0700"}]};
(function(){var $D=Date,$P=$D.prototype,$C=$D.CultureInfo,p=function(s,l){if(!l){l=2;}
return("000"+s).slice(l*-1);};$P.clearTime=function(){this.setHours(0);this.setMinutes(0);this.setSeconds(0);this.setMilliseconds(0);return this;};$P.setTimeToNow=function(){var n=new Date();this.setHours(n.getHours());this.setMinutes(n.getMinutes());this.setSeconds(n.getSeconds());this.setMilliseconds(n.getMilliseconds());return this;};$D.today=function(){return new Date().clearTime();};$D.compare=function(date1,date2){if(isNaN(date1)||isNaN(date2)){throw new Error(date1+" - "+date2);}else if(date1 instanceof Date&&date2 instanceof Date){return(date1<date2)?-1:(date1>date2)?1:0;}else{throw new TypeError(date1+" - "+date2);}};$D.equals=function(date1,date2){return(date1.compareTo(date2)===0);};$D.getDayNumberFromName=function(name){var n=$C.dayNames,m=$C.abbreviatedDayNames,o=$C.shortestDayNames,s=name.toLowerCase();for(var i=0;i<n.length;i++){if(n[i].toLowerCase()==s||m[i].toLowerCase()==s||o[i].toLowerCase()==s){return i;}}
return-1;};$D.getMonthNumberFromName=function(name){var n=$C.monthNames,m=$C.abbreviatedMonthNames,s=name.toLowerCase();for(var i=0;i<n.length;i++){if(n[i].toLowerCase()==s||m[i].toLowerCase()==s){return i;}}
return-1;};$D.isLeapYear=function(year){return((year%4===0&&year%100!==0)||year%400===0);};$D.getDaysInMonth=function(year,month){return[31,($D.isLeapYear(year)?29:28),31,30,31,30,31,31,30,31,30,31][month];};$D.getTimezoneAbbreviation=function(offset){var z=$C.timezones,p;for(var i=0;i<z.length;i++){if(z[i].offset===offset){return z[i].name;}}
return null;};$D.getTimezoneOffset=function(name){var z=$C.timezones,p;for(var i=0;i<z.length;i++){if(z[i].name===name.toUpperCase()){return z[i].offset;}}
return null;};$P.clone=function(){return new Date(this.getTime());};$P.compareTo=function(date){return Date.compare(this,date);};$P.equals=function(date){return Date.equals(this,date||new Date());};$P.between=function(start,end){return this.getTime()>=start.getTime()&&this.getTime()<=end.getTime();};$P.isAfter=function(date){return this.compareTo(date||new Date())===1;};$P.isBefore=function(date){return(this.compareTo(date||new Date())===-1);};$P.isToday=function(){return this.isSameDay(new Date());};$P.isSameDay=function(date){return this.clone().clearTime().equals(date.clone().clearTime());};$P.addMilliseconds=function(value){this.setMilliseconds(this.getMilliseconds()+value);return this;};$P.addSeconds=function(value){return this.addMilliseconds(value*1000);};$P.addMinutes=function(value){return this.addMilliseconds(value*60000);};$P.addHours=function(value){return this.addMilliseconds(value*3600000);};$P.addDays=function(value){this.setDate(this.getDate()+value);return this;};$P.addWeeks=function(value){return this.addDays(value*7);};$P.addMonths=function(value){var n=this.getDate();this.setDate(1);this.setMonth(this.getMonth()+value);this.setDate(Math.min(n,$D.getDaysInMonth(this.getFullYear(),this.getMonth())));return this;};$P.addYears=function(value){return this.addMonths(value*12);};$P.add=function(config){if(typeof config=="number"){this._orient=config;return this;}
var x=config;if(x.milliseconds){this.addMilliseconds(x.milliseconds);}
if(x.seconds){this.addSeconds(x.seconds);}
if(x.minutes){this.addMinutes(x.minutes);}
if(x.hours){this.addHours(x.hours);}
if(x.weeks){this.addWeeks(x.weeks);}
if(x.months){this.addMonths(x.months);}
if(x.years){this.addYears(x.years);}
if(x.days){this.addDays(x.days);}
return this;};var $y,$m,$d;$P.getWeek=function(){var a,b,c,d,e,f,g,n,s,w;$y=(!$y)?this.getFullYear():$y;$m=(!$m)?this.getMonth()+1:$m;$d=(!$d)?this.getDate():$d;if($m<=2){a=$y-1;b=(a/4|0)-(a/100|0)+(a/400|0);c=((a-1)/4|0)-((a-1)/100|0)+((a-1)/400|0);s=b-c;e=0;f=$d-1+(31*($m-1));}else{a=$y;b=(a/4|0)-(a/100|0)+(a/400|0);c=((a-1)/4|0)-((a-1)/100|0)+((a-1)/400|0);s=b-c;e=s+1;f=$d+((153*($m-3)+2)/5)+58+s;}
g=(a+b)%7;d=(f+g-e)%7;n=(f+3-d)|0;if(n<0){w=53-((g-s)/5|0);}else if(n>364+s){w=1;}else{w=(n/7|0)+1;}
$y=$m=$d=null;return w;};$P.getISOWeek=function(){$y=this.getUTCFullYear();$m=this.getUTCMonth()+1;$d=this.getUTCDate();return p(this.getWeek());};$P.setWeek=function(n){return this.moveToDayOfWeek(1).addWeeks(n-this.getWeek());};$D._validate=function(n,min,max,name){if(typeof n=="undefined"){return false;}else if(typeof n!="number"){throw new TypeError(n+" is not a Number.");}else if(n<min||n>max){throw new RangeError(n+" is not a valid value for "+name+".");}
return true;};$D.validateMillisecond=function(value){return $D._validate(value,0,999,"millisecond");};$D.validateSecond=function(value){return $D._validate(value,0,59,"second");};$D.validateMinute=function(value){return $D._validate(value,0,59,"minute");};$D.validateHour=function(value){return $D._validate(value,0,23,"hour");};$D.validateDay=function(value,year,month){return $D._validate(value,1,$D.getDaysInMonth(year,month),"day");};$D.validateMonth=function(value){return $D._validate(value,0,11,"month");};$D.validateYear=function(value){return $D._validate(value,0,9999,"year");};$P.set=function(config){if($D.validateMillisecond(config.millisecond)){this.addMilliseconds(config.millisecond-this.getMilliseconds());}
if($D.validateSecond(config.second)){this.addSeconds(config.second-this.getSeconds());}
if($D.validateMinute(config.minute)){this.addMinutes(config.minute-this.getMinutes());}
if($D.validateHour(config.hour)){this.addHours(config.hour-this.getHours());}
if($D.validateMonth(config.month)){this.addMonths(config.month-this.getMonth());}
if($D.validateYear(config.year)){this.addYears(config.year-this.getFullYear());}
if($D.validateDay(config.day,this.getFullYear(),this.getMonth())){this.addDays(config.day-this.getDate());}
if(config.timezone){this.setTimezone(config.timezone);}
if(config.timezoneOffset){this.setTimezoneOffset(config.timezoneOffset);}
if(config.week&&$D._validate(config.week,0,53,"week")){this.setWeek(config.week);}
return this;};$P.moveToFirstDayOfMonth=function(){return this.set({day:1});};$P.moveToLastDayOfMonth=function(){return this.set({day:$D.getDaysInMonth(this.getFullYear(),this.getMonth())});};$P.moveToNthOccurrence=function(dayOfWeek,occurrence){var shift=0;if(occurrence>0){shift=occurrence-1;}
else if(occurrence===-1){this.moveToLastDayOfMonth();if(this.getDay()!==dayOfWeek){this.moveToDayOfWeek(dayOfWeek,-1);}
return this;}
return this.moveToFirstDayOfMonth().addDays(-1).moveToDayOfWeek(dayOfWeek,+1).addWeeks(shift);};$P.moveToDayOfWeek=function(dayOfWeek,orient){var diff=(dayOfWeek-this.getDay()+7*(orient||+1))%7;return this.addDays((diff===0)?diff+=7*(orient||+1):diff);};$P.moveToMonth=function(month,orient){var diff=(month-this.getMonth()+12*(orient||+1))%12;return this.addMonths((diff===0)?diff+=12*(orient||+1):diff);};$P.getOrdinalNumber=function(){return Math.ceil((this.clone().clearTime()-new Date(this.getFullYear(),0,1))/86400000)+1;};$P.getTimezone=function(){return $D.getTimezoneAbbreviation(this.getUTCOffset());};$P.setTimezoneOffset=function(offset){var here=this.getTimezoneOffset(),there=Number(offset)*-6/10;return this.addMinutes(there-here);};$P.setTimezone=function(offset){return this.setTimezoneOffset($D.getTimezoneOffset(offset));};$P.hasDaylightSavingTime=function(){return(Date.today().set({month:0,day:1}).getTimezoneOffset()!==Date.today().set({month:6,day:1}).getTimezoneOffset());};$P.isDaylightSavingTime=function(){return(this.hasDaylightSavingTime()&&new Date().getTimezoneOffset()===Date.today().set({month:6,day:1}).getTimezoneOffset());};$P.getUTCOffset=function(){var n=this.getTimezoneOffset()*-10/6,r;if(n<0){r=(n-10000).toString();return r.charAt(0)+r.substr(2);}else{r=(n+10000).toString();return"+"+r.substr(1);}};$P.getElapsed=function(date){return(date||new Date())-this;};if(!$P.toISOString){$P.toISOString=function(){function f(n){return n<10?'0'+n:n;}
return'"'+this.getUTCFullYear()+'-'+
f(this.getUTCMonth()+1)+'-'+
f(this.getUTCDate())+'T'+
f(this.getUTCHours())+':'+
f(this.getUTCMinutes())+':'+
f(this.getUTCSeconds())+'Z"';};}
$P._toString=$P.toString;$P.toString=function(format){var x=this;if(format&&format.length==1){var c=$C.formatPatterns;x.t=x.toString;switch(format){case"d":return x.t(c.shortDate);case"D":return x.t(c.longDate);case"F":return x.t(c.fullDateTime);case"m":return x.t(c.monthDay);case"r":return x.t(c.rfc1123);case"s":return x.t(c.sortableDateTime);case"t":return x.t(c.shortTime);case"T":return x.t(c.longTime);case"u":return x.t(c.universalSortableDateTime);case"y":return x.t(c.yearMonth);}}
var ord=function(n){switch(n*1){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th";}};return format?format.replace(/(\\)?(dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|S)/g,function(m){if(m.charAt(0)==="\\"){return m.replace("\\","");}
x.h=x.getHours;switch(m){case"hh":return p(x.h()<13?(x.h()===0?12:x.h()):(x.h()-12));case"h":return x.h()<13?(x.h()===0?12:x.h()):(x.h()-12);case"HH":return p(x.h());case"H":return x.h();case"mm":return p(x.getMinutes());case"m":return x.getMinutes();case"ss":return p(x.getSeconds());case"s":return x.getSeconds();case"yyyy":return p(x.getFullYear(),4);case"yy":return p(x.getFullYear());case"dddd":return $C.dayNames[x.getDay()];case"ddd":return $C.abbreviatedDayNames[x.getDay()];case"dd":return p(x.getDate());case"d":return x.getDate();case"MMMM":return $C.monthNames[x.getMonth()];case"MMM":return $C.abbreviatedMonthNames[x.getMonth()];case"MM":return p((x.getMonth()+1));case"M":return x.getMonth()+1;case"t":return x.h()<12?$C.amDesignator.substring(0,1):$C.pmDesignator.substring(0,1);case"tt":return x.h()<12?$C.amDesignator:$C.pmDesignator;case"S":return ord(x.getDate());default:return m;}}):this._toString();};}());
(function(){var $D=Date,$P=$D.prototype,$C=$D.CultureInfo,$N=Number.prototype;$P._orient=+1;$P._nth=null;$P._is=false;$P._same=false;$P._isSecond=false;$N._dateElement="day";$P.next=function(){this._orient=+1;return this;};$D.next=function(){return $D.today().next();};$P.last=$P.prev=$P.previous=function(){this._orient=-1;return this;};$D.last=$D.prev=$D.previous=function(){return $D.today().last();};$P.is=function(){this._is=true;return this;};$P.same=function(){this._same=true;this._isSecond=false;return this;};$P.today=function(){return this.same().day();};$P.weekday=function(){if(this._is){this._is=false;return(!this.is().sat()&&!this.is().sun());}
return false;};$P.at=function(time){return(typeof time==="string")?$D.parse(this.toString("d")+" "+time):this.set(time);};$N.fromNow=$N.after=function(date){var c={};c[this._dateElement]=this;return((!date)?new Date():date.clone()).add(c);};$N.ago=$N.before=function(date){var c={};c[this._dateElement]=this*-1;return((!date)?new Date():date.clone()).add(c);};var dx=("sunday monday tuesday wednesday thursday friday saturday").split(/\s/),mx=("january february march april may june july august september october november december").split(/\s/),px=("Millisecond Second Minute Hour Day Week Month Year").split(/\s/),pxf=("Milliseconds Seconds Minutes Hours Date Week Month FullYear").split(/\s/),nth=("final first second third fourth fifth").split(/\s/),de;$P.toObject=function(){var o={};for(var i=0;i<px.length;i++){o[px[i].toLowerCase()]=this["get"+pxf[i]]();}
return o;};$D.fromObject=function(config){config.week=null;return Date.today().set(config);};var df=function(n){return function(){if(this._is){this._is=false;return this.getDay()==n;}
if(this._nth!==null){if(this._isSecond){this.addSeconds(this._orient*-1);}
this._isSecond=false;var ntemp=this._nth;this._nth=null;var temp=this.clone().moveToLastDayOfMonth();this.moveToNthOccurrence(n,ntemp);if(this>temp){throw new RangeError($D.getDayName(n)+" does not occur "+ntemp+" times in the month of "+$D.getMonthName(temp.getMonth())+" "+temp.getFullYear()+".");}
return this;}
return this.moveToDayOfWeek(n,this._orient);};};var sdf=function(n){return function(){var t=$D.today(),shift=n-t.getDay();if(n===0&&$C.firstDayOfWeek===1&&t.getDay()!==0){shift=shift+7;}
return t.addDays(shift);};};for(var i=0;i<dx.length;i++){$D[dx[i].toUpperCase()]=$D[dx[i].toUpperCase().substring(0,3)]=i;$D[dx[i]]=$D[dx[i].substring(0,3)]=sdf(i);$P[dx[i]]=$P[dx[i].substring(0,3)]=df(i);}
var mf=function(n){return function(){if(this._is){this._is=false;return this.getMonth()===n;}
return this.moveToMonth(n,this._orient);};};var smf=function(n){return function(){return $D.today().set({month:n,day:1});};};for(var j=0;j<mx.length;j++){$D[mx[j].toUpperCase()]=$D[mx[j].toUpperCase().substring(0,3)]=j;$D[mx[j]]=$D[mx[j].substring(0,3)]=smf(j);$P[mx[j]]=$P[mx[j].substring(0,3)]=mf(j);}
var ef=function(j){return function(){if(this._isSecond){this._isSecond=false;return this;}
if(this._same){this._same=this._is=false;var o1=this.toObject(),o2=(arguments[0]||new Date()).toObject(),v="",k=j.toLowerCase();for(var m=(px.length-1);m>-1;m--){v=px[m].toLowerCase();if(o1[v]!=o2[v]){return false;}
if(k==v){break;}}
return true;}
if(j.substring(j.length-1)!="s"){j+="s";}
return this["add"+j](this._orient);};};var nf=function(n){return function(){this._dateElement=n;return this;};};for(var k=0;k<px.length;k++){de=px[k].toLowerCase();$P[de]=$P[de+"s"]=ef(px[k]);$N[de]=$N[de+"s"]=nf(de);}
$P._ss=ef("Second");var nthfn=function(n){return function(dayOfWeek){if(this._same){return this._ss(arguments[0]);}
if(dayOfWeek||dayOfWeek===0){return this.moveToNthOccurrence(dayOfWeek,n);}
this._nth=n;if(n===2&&(dayOfWeek===undefined||dayOfWeek===null)){this._isSecond=true;return this.addSeconds(this._orient);}
return this;};};for(var l=0;l<nth.length;l++){$P[nth[l]]=(l===0)?nthfn(-1):nthfn(l);}}());
(function(){Date.Parsing={Exception:function(s){this.message="Parse error at '"+s.substring(0,10)+" ...'";}};var $P=Date.Parsing;var _=$P.Operators={rtoken:function(r){return function(s){var mx=s.match(r);if(mx){return([mx[0],s.substring(mx[0].length)]);}else{throw new $P.Exception(s);}};},token:function(s){return function(s){return _.rtoken(new RegExp("^\s*"+s+"\s*"))(s);};},stoken:function(s){return _.rtoken(new RegExp("^"+s));},until:function(p){return function(s){var qx=[],rx=null;while(s.length){try{rx=p.call(this,s);}catch(e){qx.push(rx[0]);s=rx[1];continue;}
break;}
return[qx,s];};},many:function(p){return function(s){var rx=[],r=null;while(s.length){try{r=p.call(this,s);}catch(e){return[rx,s];}
rx.push(r[0]);s=r[1];}
return[rx,s];};},optional:function(p){return function(s){var r=null;try{r=p.call(this,s);}catch(e){return[null,s];}
return[r[0],r[1]];};},not:function(p){return function(s){try{p.call(this,s);}catch(e){return[null,s];}
throw new $P.Exception(s);};},ignore:function(p){return p?function(s){var r=null;r=p.call(this,s);return[null,r[1]];}:null;},product:function(){var px=arguments[0],qx=Array.prototype.slice.call(arguments,1),rx=[];for(var i=0;i<px.length;i++){rx.push(_.each(px[i],qx));}
return rx;},cache:function(rule){var cache={},r=null;return function(s){try{r=cache[s]=(cache[s]||rule.call(this,s));}catch(e){r=cache[s]=e;}
if(r instanceof $P.Exception){throw r;}else{return r;}};},any:function(){var px=arguments;return function(s){var r=null;for(var i=0;i<px.length;i++){if(px[i]==null){continue;}
try{r=(px[i].call(this,s));}catch(e){r=null;}
if(r){return r;}}
throw new $P.Exception(s);};},each:function(){var px=arguments;return function(s){var rx=[],r=null;for(var i=0;i<px.length;i++){if(px[i]==null){continue;}
try{r=(px[i].call(this,s));}catch(e){throw new $P.Exception(s);}
rx.push(r[0]);s=r[1];}
return[rx,s];};},all:function(){var px=arguments,_=_;return _.each(_.optional(px));},sequence:function(px,d,c){d=d||_.rtoken(/^\s*/);c=c||null;if(px.length==1){return px[0];}
return function(s){var r=null,q=null;var rx=[];for(var i=0;i<px.length;i++){try{r=px[i].call(this,s);}catch(e){break;}
rx.push(r[0]);try{q=d.call(this,r[1]);}catch(ex){q=null;break;}
s=q[1];}
if(!r){throw new $P.Exception(s);}
if(q){throw new $P.Exception(q[1]);}
if(c){try{r=c.call(this,r[1]);}catch(ey){throw new $P.Exception(r[1]);}}
return[rx,(r?r[1]:s)];};},between:function(d1,p,d2){d2=d2||d1;var _fn=_.each(_.ignore(d1),p,_.ignore(d2));return function(s){var rx=_fn.call(this,s);return[[rx[0][0],r[0][2]],rx[1]];};},list:function(p,d,c){d=d||_.rtoken(/^\s*/);c=c||null;return(p instanceof Array?_.each(_.product(p.slice(0,-1),_.ignore(d)),p.slice(-1),_.ignore(c)):_.each(_.many(_.each(p,_.ignore(d))),px,_.ignore(c)));},set:function(px,d,c){d=d||_.rtoken(/^\s*/);c=c||null;return function(s){var r=null,p=null,q=null,rx=null,best=[[],s],last=false;for(var i=0;i<px.length;i++){q=null;p=null;r=null;last=(px.length==1);try{r=px[i].call(this,s);}catch(e){continue;}
rx=[[r[0]],r[1]];if(r[1].length>0&&!last){try{q=d.call(this,r[1]);}catch(ex){last=true;}}else{last=true;}
if(!last&&q[1].length===0){last=true;}
if(!last){var qx=[];for(var j=0;j<px.length;j++){if(i!=j){qx.push(px[j]);}}
p=_.set(qx,d).call(this,q[1]);if(p[0].length>0){rx[0]=rx[0].concat(p[0]);rx[1]=p[1];}}
if(rx[1].length<best[1].length){best=rx;}
if(best[1].length===0){break;}}
if(best[0].length===0){return best;}
if(c){try{q=c.call(this,best[1]);}catch(ey){throw new $P.Exception(best[1]);}
best[1]=q[1];}
return best;};},forward:function(gr,fname){return function(s){return gr[fname].call(this,s);};},replace:function(rule,repl){return function(s){var r=rule.call(this,s);return[repl,r[1]];};},process:function(rule,fn){return function(s){var r=rule.call(this,s);return[fn.call(this,r[0]),r[1]];};},min:function(min,rule){return function(s){var rx=rule.call(this,s);if(rx[0].length<min){throw new $P.Exception(s);}
return rx;};}};var _generator=function(op){return function(){var args=null,rx=[];if(arguments.length>1){args=Array.prototype.slice.call(arguments);}else if(arguments[0]instanceof Array){args=arguments[0];}
if(args){for(var i=0,px=args.shift();i<px.length;i++){args.unshift(px[i]);rx.push(op.apply(null,args));args.shift();return rx;}}else{return op.apply(null,arguments);}};};var gx="optional not ignore cache".split(/\s/);for(var i=0;i<gx.length;i++){_[gx[i]]=_generator(_[gx[i]]);}
var _vector=function(op){return function(){if(arguments[0]instanceof Array){return op.apply(null,arguments[0]);}else{return op.apply(null,arguments);}};};var vx="each any all".split(/\s/);for(var j=0;j<vx.length;j++){_[vx[j]]=_vector(_[vx[j]]);}}());(function(){var $D=Date,$P=$D.prototype,$C=$D.CultureInfo;var flattenAndCompact=function(ax){var rx=[];for(var i=0;i<ax.length;i++){if(ax[i]instanceof Array){rx=rx.concat(flattenAndCompact(ax[i]));}else{if(ax[i]){rx.push(ax[i]);}}}
return rx;};$D.Grammar={};$D.Translator={hour:function(s){return function(){this.hour=Number(s);};},minute:function(s){return function(){this.minute=Number(s);};},second:function(s){return function(){this.second=Number(s);};},meridian:function(s){return function(){this.meridian=s.slice(0,1).toLowerCase();};},timezone:function(s){return function(){var n=s.replace(/[^\d\+\-]/g,"");if(n.length){this.timezoneOffset=Number(n);}else{this.timezone=s.toLowerCase();}};},day:function(x){var s=x[0];return function(){this.day=Number(s.match(/\d+/)[0]);};},month:function(s){return function(){this.month=(s.length==3)?"jan feb mar apr may jun jul aug sep oct nov dec".indexOf(s)/4:Number(s)-1;};},year:function(s){return function(){var n=Number(s);this.year=((s.length>2)?n:(n+(((n+2000)<$C.twoDigitYearMax)?2000:1900)));};},rday:function(s){return function(){switch(s){case"yesterday":this.days=-1;break;case"tomorrow":this.days=1;break;case"today":this.days=0;break;case"now":this.days=0;this.now=true;break;}};},finishExact:function(x){x=(x instanceof Array)?x:[x];for(var i=0;i<x.length;i++){if(x[i]){x[i].call(this);}}
var now=new Date();if((this.hour||this.minute)&&(!this.month&&!this.year&&!this.day)){this.day=now.getDate();}
if(!this.year){this.year=now.getFullYear();}
if(!this.month&&this.month!==0){this.month=now.getMonth();}
if(!this.day){this.day=1;}
if(!this.hour){this.hour=0;}
if(!this.minute){this.minute=0;}
if(!this.second){this.second=0;}
if(this.meridian&&this.hour){if(this.meridian=="p"&&this.hour<12){this.hour=this.hour+12;}else if(this.meridian=="a"&&this.hour==12){this.hour=0;}}
if(this.day>$D.getDaysInMonth(this.year,this.month)){throw new RangeError(this.day+" is not a valid value for days.");}
var r=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second);if(this.timezone){r.set({timezone:this.timezone});}else if(this.timezoneOffset){r.set({timezoneOffset:this.timezoneOffset});}
return r;},finish:function(x){x=(x instanceof Array)?flattenAndCompact(x):[x];if(x.length===0){return null;}
for(var i=0;i<x.length;i++){if(typeof x[i]=="function"){x[i].call(this);}}
var today=$D.today();if(this.now&&!this.unit&&!this.operator){return new Date();}else if(this.now){today=new Date();}
var expression=!!(this.days&&this.days!==null||this.orient||this.operator);var gap,mod,orient;orient=((this.orient=="past"||this.operator=="subtract")?-1:1);if(!this.now&&"hour minute second".indexOf(this.unit)!=-1){today.setTimeToNow();}
if(this.month||this.month===0){if("year day hour minute second".indexOf(this.unit)!=-1){this.value=this.month+1;this.month=null;expression=true;}}
if(!expression&&this.weekday&&!this.day&&!this.days){var temp=Date[this.weekday]();this.day=temp.getDate();if(!this.month){this.month=temp.getMonth();}
this.year=temp.getFullYear();}
if(expression&&this.weekday&&this.unit!="month"){this.unit="day";gap=($D.getDayNumberFromName(this.weekday)-today.getDay());mod=7;this.days=gap?((gap+(orient*mod))%mod):(orient*mod);}
if(this.month&&this.unit=="day"&&this.operator){this.value=(this.month+1);this.month=null;}
if(this.value!=null&&this.month!=null&&this.year!=null){this.day=this.value*1;}
if(this.month&&!this.day&&this.value){today.set({day:this.value*1});if(!expression){this.day=this.value*1;}}
if(!this.month&&this.value&&this.unit=="month"&&!this.now){this.month=this.value;expression=true;}
if(expression&&(this.month||this.month===0)&&this.unit!="year"){this.unit="month";gap=(this.month-today.getMonth());mod=12;this.months=gap?((gap+(orient*mod))%mod):(orient*mod);this.month=null;}
if(!this.unit){this.unit="day";}
if(!this.value&&this.operator&&this.operator!==null&&this[this.unit+"s"]&&this[this.unit+"s"]!==null){this[this.unit+"s"]=this[this.unit+"s"]+((this.operator=="add")?1:-1)+(this.value||0)*orient;}else if(this[this.unit+"s"]==null||this.operator!=null){if(!this.value){this.value=1;}
this[this.unit+"s"]=this.value*orient;}
if(this.meridian&&this.hour){if(this.meridian=="p"&&this.hour<12){this.hour=this.hour+12;}else if(this.meridian=="a"&&this.hour==12){this.hour=0;}}
if(this.weekday&&!this.day&&!this.days){var temp=Date[this.weekday]();this.day=temp.getDate();if(temp.getMonth()!==today.getMonth()){this.month=temp.getMonth();}}
if((this.month||this.month===0)&&!this.day){this.day=1;}
if(!this.orient&&!this.operator&&this.unit=="week"&&this.value&&!this.day&&!this.month){return Date.today().setWeek(this.value);}
if(expression&&this.timezone&&this.day&&this.days){this.day=this.days;}
return(expression)?today.add(this):today.set(this);}};var _=$D.Parsing.Operators,g=$D.Grammar,t=$D.Translator,_fn;g.datePartDelimiter=_.rtoken(/^([\s\-\.\,\/\x27]+)/);g.timePartDelimiter=_.stoken(":");g.whiteSpace=_.rtoken(/^\s*/);g.generalDelimiter=_.rtoken(/^(([\s\,]|at|@|on)+)/);var _C={};g.ctoken=function(keys){var fn=_C[keys];if(!fn){var c=$C.regexPatterns;var kx=keys.split(/\s+/),px=[];for(var i=0;i<kx.length;i++){px.push(_.replace(_.rtoken(c[kx[i]]),kx[i]));}
fn=_C[keys]=_.any.apply(null,px);}
return fn;};g.ctoken2=function(key){return _.rtoken($C.regexPatterns[key]);};g.h=_.cache(_.process(_.rtoken(/^(0[0-9]|1[0-2]|[1-9])/),t.hour));g.hh=_.cache(_.process(_.rtoken(/^(0[0-9]|1[0-2])/),t.hour));g.H=_.cache(_.process(_.rtoken(/^([0-1][0-9]|2[0-3]|[0-9])/),t.hour));g.HH=_.cache(_.process(_.rtoken(/^([0-1][0-9]|2[0-3])/),t.hour));g.m=_.cache(_.process(_.rtoken(/^([0-5][0-9]|[0-9])/),t.minute));g.mm=_.cache(_.process(_.rtoken(/^[0-5][0-9]/),t.minute));g.s=_.cache(_.process(_.rtoken(/^([0-5][0-9]|[0-9])/),t.second));g.ss=_.cache(_.process(_.rtoken(/^[0-5][0-9]/),t.second));g.hms=_.cache(_.sequence([g.H,g.m,g.s],g.timePartDelimiter));g.t=_.cache(_.process(g.ctoken2("shortMeridian"),t.meridian));g.tt=_.cache(_.process(g.ctoken2("longMeridian"),t.meridian));g.z=_.cache(_.process(_.rtoken(/^((\+|\-)\s*\d\d\d\d)|((\+|\-)\d\d\:?\d\d)/),t.timezone));g.zz=_.cache(_.process(_.rtoken(/^((\+|\-)\s*\d\d\d\d)|((\+|\-)\d\d\:?\d\d)/),t.timezone));g.zzz=_.cache(_.process(g.ctoken2("timezone"),t.timezone));g.timeSuffix=_.each(_.ignore(g.whiteSpace),_.set([g.tt,g.zzz]));g.time=_.each(_.optional(_.ignore(_.stoken("T"))),g.hms,g.timeSuffix);g.d=_.cache(_.process(_.each(_.rtoken(/^([0-2]\d|3[0-1]|\d)/),_.optional(g.ctoken2("ordinalSuffix"))),t.day));g.dd=_.cache(_.process(_.each(_.rtoken(/^([0-2]\d|3[0-1])/),_.optional(g.ctoken2("ordinalSuffix"))),t.day));g.ddd=g.dddd=_.cache(_.process(g.ctoken("sun mon tue wed thu fri sat"),function(s){return function(){this.weekday=s;};}));g.M=_.cache(_.process(_.rtoken(/^(1[0-2]|0\d|\d)/),t.month));g.MM=_.cache(_.process(_.rtoken(/^(1[0-2]|0\d)/),t.month));g.MMM=g.MMMM=_.cache(_.process(g.ctoken("jan feb mar apr may jun jul aug sep oct nov dec"),t.month));g.y=_.cache(_.process(_.rtoken(/^(\d\d?)/),t.year));g.yy=_.cache(_.process(_.rtoken(/^(\d\d)/),t.year));g.yyy=_.cache(_.process(_.rtoken(/^(\d\d?\d?\d?)/),t.year));g.yyyy=_.cache(_.process(_.rtoken(/^(\d\d\d\d)/),t.year));_fn=function(){return _.each(_.any.apply(null,arguments),_.not(g.ctoken2("timeContext")));};g.day=_fn(g.d,g.dd);g.month=_fn(g.M,g.MMM);g.year=_fn(g.yyyy,g.yy);g.orientation=_.process(g.ctoken("past future"),function(s){return function(){this.orient=s;};});g.operator=_.process(g.ctoken("add subtract"),function(s){return function(){this.operator=s;};});g.rday=_.process(g.ctoken("yesterday tomorrow today now"),t.rday);g.unit=_.process(g.ctoken("second minute hour day week month year"),function(s){return function(){this.unit=s;};});g.value=_.process(_.rtoken(/^\d\d?(st|nd|rd|th)?/),function(s){return function(){this.value=s.replace(/\D/g,"");};});g.expression=_.set([g.rday,g.operator,g.value,g.unit,g.orientation,g.ddd,g.MMM]);_fn=function(){return _.set(arguments,g.datePartDelimiter);};g.mdy=_fn(g.ddd,g.month,g.day,g.year);g.ymd=_fn(g.ddd,g.year,g.month,g.day);g.dmy=_fn(g.ddd,g.day,g.month,g.year);g.date=function(s){return((g[$C.dateElementOrder]||g.mdy).call(this,s));};g.format=_.process(_.many(_.any(_.process(_.rtoken(/^(dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?)/),function(fmt){if(g[fmt]){return g[fmt];}else{throw $D.Parsing.Exception(fmt);}}),_.process(_.rtoken(/^[^dMyhHmstz]+/),function(s){return _.ignore(_.stoken(s));}))),function(rules){return _.process(_.each.apply(null,rules),t.finishExact);});var _F={};var _get=function(f){return _F[f]=(_F[f]||g.format(f)[0]);};g.formats=function(fx){if(fx instanceof Array){var rx=[];for(var i=0;i<fx.length;i++){rx.push(_get(fx[i]));}
return _.any.apply(null,rx);}else{return _get(fx);}};g._formats=g.formats(["\"yyyy-MM-ddTHH:mm:ssZ\"","yyyy-MM-ddTHH:mm:ssZ","yyyy-MM-ddTHH:mm:ssz","yyyy-MM-ddTHH:mm:ss","yyyy-MM-ddTHH:mmZ","yyyy-MM-ddTHH:mmz","yyyy-MM-ddTHH:mm","ddd, MMM dd, yyyy H:mm:ss tt","ddd MMM d yyyy HH:mm:ss zzz","MMddyyyy","ddMMyyyy","Mddyyyy","ddMyyyy","Mdyyyy","dMyyyy","yyyy","Mdyy","dMyy","d"]);g._start=_.process(_.set([g.date,g.time,g.expression],g.generalDelimiter,g.whiteSpace),t.finish);g.start=function(s){try{var r=g._formats.call({},s);if(r[1].length===0){return r;}}catch(e){}
return g._start.call({},s);};$D._parse=$D.parse;$D.parse=function(s){var r=null;if(!s){return null;}
if(s instanceof Date){return s;}
try{r=$D.Grammar.start.call({},s.replace(/^\s*(\S*(\s+\S+)*)\s*$/,"$1"));}catch(e){return null;}
return((r[1].length===0)?r[0]:null);};$D.getParseFunction=function(fx){var fn=$D.Grammar.formats(fx);return function(s){var r=null;try{r=fn.call({},s);}catch(e){return null;}
return((r[1].length===0)?r[0]:null);};};$D.parseExact=function(s,fx){return $D.getParseFunction(fx)(s);};}());
</script>
		<script type="text/javascript">function expandtemplate(options,callback) {

	// Interpretation of timeRanges:
	// DATE/DURATION       = DATE/now+DURATION
	// DURATION/DATE       = DATE+DURATION/DATE
	// DATE1/DATE2         = DATE1/DATE2
	// DURATION1/DURATION2 = now+DURATION1/now+DURATION2
	
	var template   = options.template;
	var timeRange  = options.timeRange;
	var indexRange = options.indexRange;
	var type       = options.type;
	var check      = options.check;
	var debug      = options.debug;
	var proxy      = options.proxy;
	var side       = "client";
	
	//debug = true;

	if (options.timeRange) {
		timeRange = expandISO8601Duration(timeRange);
		var Start = timeRange.split("/")[0];
		var Stop  = timeRange.split("/")[1];
		tmpStart = new Date(Start);
		tmpStop  = new Date(Stop);
		if (tmpStop.getTime() < tmpStart.getTime()) {
			console.log("Returing empty list because stop time is greater than start time.");
			return [];
		}
	}
	if (options.indexRange && type == "sprintf") {
		var Start = indexRange.split("/")[0];
		var Stop  = indexRange.split("/")[1];
		var Step  = indexRange.split("/")[2];
	}

	if (debug) console.log("Start: " + Start);
	if (debug) console.log("Stop:  " + Stop);
	if (debug) console.log("Step:  " + Step);

	if (Start.length == 13) {Start = Start + ":00:00";}
	if (Stop.length == 13) {Stop = Stop + ":00:00";}
	if (Start.length == 16) {Start = Start + ":00";}
	if (Stop.length == 16) {Stop = Stop + ":00";}

	if (debug) console.log("Start: " + Start);
	if (debug) console.log("Stop:  " + Stop);

	var tic = new Date().getTime();
	var files   = [];
	var headers = [];

	if (!options.template.match(/\$|\%/)) {
		files[0] = options.template;
		if (debug) console.log("expandtemplate.js: No wildcards")
		return finished();
	}
	
	if (type == "sprintf") {

		// Allow identifiers to be a $.  Internally use %.
		template = template.replace(/\$/g,'%');

		if (typeof(Start) === "string") Start = parseInt(Start);	
		if (typeof(Stop) === "string") Stop = parseInt(Stop);
		if (typeof(Step) === "string") {Step = parseInt(Step);} else {Step = 1;}
			
		var k = Start;
		for (i = Start; i < Stop + 1; i = i + Step) {
			var tmps = template;
			files[k-Start] = sprintf(tmps,i);
			k = k+1;
		}
	
		if (check) return head(files,proxy,headcomplete);
		if (!check) return finished();
	}

	if (type == "strftime") {
			
		// Allow identifiers to be a %.  Internally use $.
		template = template.replace(/\%/g,'$');

		if (debug) console.log("template      = " + template);

		// Remove time zone with substr(0,25).		
		var START_dateinc  = new Date(new Date(Start).toUTCString().substr(0, 25));
		var START_dateoff  = new Date(new Date(Start).toUTCString().substr(0, 25));
		var STOP_date      = new Date(new Date(Stop).toUTCString().substr(0, 25));

		if (debug) console.log("START_dateinc: " + START_dateinc);
		if (debug) console.log("STOP_dateoff:  " + START_dateoff);
		if (debug) console.log("Step:  " + Step);

		var addinc = {};
		var addoff = {};

		var keys  = ["microseconds","seconds","minutes","hours","days","days","months","years"];
		var codes = ["f",           "S",      "M",      "H",    "j",   "d",   "m",     "Y"];

		// Extract deltas (assumes 1 delta only!)
		for (i = 0; i < codes.length;i++)
			addinc[keys[i]] = parseInt(template.replace(new RegExp(".*\\${"+ codes[i] +";delta=([0-9].*)}.*"),"$1")) || 0;
		
		// Extract offsets (assumes 1 offset only!)
		for (i = 0; i < codes.length;i++)
			addoff[keys[i]] = parseInt(template.replace(new RegExp(".*\\${"+ codes[i] +";offset=([0-9].*)}.*"),"$1")) || 0;

		// Remove delta argument and replace $ with special character % for delta arguments. 
		while (template.match("{.*delta.*}"))
			template = template.replace(new RegExp("(.*)\\${([a-z]);delta=[0-9].*}(.*)","gi"),"$1%$2$3");	
		
		// Replace $ with % for all codes (will be for all except those with offset arguments).
		template = template.replace(new RegExp("\\$([a-z])","gi"),"%$1");
		
		// Remove offset argument but keep $.
		while (template.match("{.*offset.*}"))
			template = template.replace(new RegExp("(.*)\\${([a-z]);offset=[0-9].*}(.*)","ig"),"$1$$$2$3");

		// If there were no increments given, make increment equal to 1 for any code given.
		// Increment codes are marked with special character %.
		for (i = 0; i < codes.length;i++)
		 	if (template.match("%"+codes[i]) && allzero(addinc)) addinc[keys[i]] = 1;

		// If there were no offsets given, make offset equal to 1 for any code given.
		for (i = 0; i < codes.length;i++)
		 	if (template.match("$"+codes[i]) && allzero(addoff)) addoff[keys[i]] = 1;
						
		if (debug) {console.log("addoff");console.log(addoff);}
		if (debug) {console.log("addinc");console.log(addinc);}

		if (debug) console.log(template);
		if (debug) console.log(START_dateinc);
		
		var i = 0;
		
		START_dateoff.add(addoff);

		if (allzero(addinc)) {
			files[0] = template;
		} else {
			while (START_dateinc.isBefore(STOP_date)) {
				//console.log(START_dateinc);
				//console.log(START_dateoff);
				files[i] = START_dateinc.strftime(template);
				//console.log(files[i])
				START_dateinc.add(addinc);
				START_dateoff.add(addoff);
				files[i] = START_dateoff.strftime(files[i].replace(/\$/g,"%"));
				i = i+1;
			}
			if (Stop.substring(11).match(/[1-9]/)) {
				
				if (debug) console.log("Stop date has non-zero in time component.  Adding one more file.");
				// If stop date has time component, grab extra file.
				files[i] = START_dateinc.strftime(template);
				START_dateinc.add(addinc);
				START_dateoff.add(addoff);
				files[i] = START_dateoff.strftime(files[i].replace(/\$/g,"%"));
		
								
			}

		}	
		if (!callback) return files;
		if (check) return head(files,proxy,headcomplete);
		if (!check) return finished();
		
	}

	function allzero(obj) {for (var prop in obj) {if (obj[prop] > 0) return false} return true}

	function finished() {
		var elapsed = new Date().getTime() - tic;
		if (debug) {
			if (check) {
				console.log("Generated and checked " + files.length + " URLs in " + elapsed + " ms (" + Math.round(elapsed/files.length) + " ms per)");
			} else {
				console.log("Generated " + files.length + " URLs in " + elapsed + " ms (" + Math.round(files.length/elapsed) + " per ms)");
			}
		}
		
		if (callback) {
			callback(files,headers,options);
		} else {
			return files;
		}
	}
	
	function headcomplete(data,i) {
		var Nf = files.length;	
		if (!headcomplete.N) {headcomplete.N = 0;}
		headcomplete.N = headcomplete.N + 1; 
		headers[i] = data;
		if (Nf == headcomplete.N) {
			if (debug) console.log("All head requests complete.");
			return finished();
		}
	}
		
}

function expandISO8601Duration(timeRange,options) {

	function s2b(str) {if (str === "true") {return true} else {return false}}
	function s2i(str) {return parseInt(str)}

	if (!timeRange.match(/^P|\/P|^\-P|\/\-P/)) {return timeRange;}

	now = new Date().toISOString();
	if (options) { 
		var debug = options.debug;
		if (options.now) {
			now = options.now;
		}
	}

	//var debug = true;
	if (timeRange.split("/").length > 1) {
		var options = {};
		if (timeRange.split("/")[0].match(/P/) && !timeRange.split("/")[1].match(/P/)) {
			// DURATION/DATE
			options.now = timeRange.split("/")[1];
		} else {
			// DATE/DURATION
			options.now = new Date().toISOString();
		}
		var a = expandISO8601Duration(timeRange.split("/")[0],options);
		var b = expandISO8601Duration(timeRange.split("/")[1],options);
		var tmpa = new Date(a);
		var tmpb = new Date(b);
		if ((tmpa.getTime() > tmpb.getTime()) && !(timeRange.split("/")[0].match(/P/) && timeRange.split("/")[1].match(/P/)) ){
			// This will occur for DURATION/DATE when DURATION is positive.
			//console.log(timeRange)
			//console.log("x Returning "+ b + "/" + a)
			return b + "/" + a;
		} else {
			//console.log("Returning "+ a + "/" + b)
			return a + "/" + b;			
		}
	} else {
		Duration = timeRange;
	}
	var Durationo = Duration;
	if (debug) console.log("expandISO8601Duration: Input: " + Duration);
	if (!Duration.match(/P|T/)) return Duration;
	var Durationo = Duration;
	var years = 0;
	var months = 0;
	var days = 0;
	var hours = 0;
	var minutes = 0;
	var seconds = 0;
	if (Duration.match("P")) {
		var sign    = parseInt(Duration.replace(/(.*)P.*/,"$11"));
		var years   = sign*parseInt(Duration.replace(/.*?([0-9]*)Y.*/,"$1"));
		var months  = sign*parseInt(Duration.replace(/.*?([0-9]*)M.*/,"$1"));
		var days    = sign*parseInt(Duration.replace(/.*?([0-9]*)D.*/,"$1"));
	}
	if (Durationo.match("T")) {
		var hours   = sign*parseInt(Durationo.replace(/.*?([0-9]*)H.*/,"$1"));
		var minutes = sign*parseInt(Durationo.replace(/.*?([0-9]*)M.*/,"$1"));
		var seconds = sign*parseInt(Durationo.replace(/.*?([0-9]*)S.*/,"$1"));
	}

	
	if (debug) console.log("expandISO8601Duration: Now: " + now )
	if (debug) console.log("expandISO8601Duration: Offset: ");
	if (debug) console.log({years:years,months:months,days:days,hours:hours,minutes:minutes,seconds:seconds});
	Duration = new Date(now).add({years:years,months:months,days:days,hours:hours,minutes:minutes,seconds:seconds});
	if (debug) console.log("expandISO8601Duration: Now+"+Durationo+" = " + Duration.toISOString())
	
	return Duration.toISOString();
}

// node.js
if (typeof(exports) !== "undefined" && require){

	var fs = require("fs");

	if (fs.existsSync(__dirname + "/deps")) {
		require(__dirname+"/deps/strftime");
		require(__dirname+"/deps/date");
		var sp = require(__dirname+"/deps/sprintf-0.7-beta1");
	} else {
		require(__dirname+"/../deps/strftime");
		require(__dirname+"/../deps/date");
		var sp = require(__dirname+"/../deps/sprintf-0.7-beta1");
	}	

	sprintf = sp.sprintf;
	vsprintf = sp.vsprintf;

	exports.expandtemplate = expandtemplate;
	exports.expandISO8601Duration = expandISO8601Duration;
	
}</script>

		<script>
			// Do not remove the following lines.  Uncomment and place
			// an initial hash value to set the initial gallery.
			//location.hash = ""
		</script>
		<script>$( function () {viviz(VIVIZ)} )</script>

	</head>

	<body>

		<div id="g-container" style="display:none;text-align:center;">

			<div id="gallery1" class="ui-widget ui-widget-content ui-corner-all" style="padding:4px;display:inline-block;">
				
				<div id="error" class="well" style="display:none;background-color:red;"></div>

				<div id="catalogwrapper" class="well" style="text-align:center">
					<span id="infoclose" style="float:left;cursor:pointer;text-decoration:underline;visibility:hidden;">
						x
					</span>
					<span style="float:left;">&nbsp;Config.:&nbsp;</span>
					<span id="applicationopen" style="float:left;cursor:pointer;text-decoration:underline">
						Application
					</span>
					<span style="float:left;">&nbsp;|&nbsp;</span>
					<span id="catalogopen" style="float:left;cursor:pointer;text-decoration:underline">
						Catalog
					</span>
					<span style="float:left;">&nbsp;|&nbsp;</span>
					<span id="galleryopen" style="float:left;cursor:pointer;text-decoration:underline">
						Gallery
					</span>
					<span id="tooltip" style="margin-left:1em;margin-right:1em;float:center"></span>
					<span style="float:right"><a target="_blank" href="http://viviz.org/doc/" style="text-decoration: underline;">ViViz documentation</a></span>
					<br>
					<div id="info" style="text-align:left;overflow-x:scroll;"></div>
				</div>

				<div id="dropdownswrapper" class="well">
					<div style="text-align:center;">
						<span id="dropdowns"></span>
					</div>
				</div>

				<div id="controlswrapper" class="well" style="text-align:center">
					<div style="text-align:center;">
						<button class="btn" type="button" title="Hide thumbnails" id="showhidethumb"><h4>x</h4></button>
						<button class="btn" type="button" title="Play" id="play"><h4></h4></button>
						<button class="btn" type="button" title="Stop" id="stop"><h4></h4></button>&nbsp;&nbsp;&nbsp;								  
						<button class="btn" type="button" title="Previous frame" id="previous"><h4>|</h4></button>
						<button class="btn" type="button" title="Next frame" id="next"><h4>|</h4></button>&nbsp;&nbsp;&nbsp;
						<button class="btn" type="button" title="First frame" id="first"><h4>|</h4></button>
						<button class="btn" type="button" title="Last frame" id="last"><h4>|</h4></button>
						<span id="workingfullframe" style=""><img style="vertical-align:middle" src="css/ajax-loader.gif">&nbsp;</span>
						<span id="aboutbuttonwrapper" style="display:none;">
							<button class="btn" type="button" title="" id="aboutbutton"><h4>?</h4></button>
						</span>
						<span>
							<button class="btn" type="button" title="Show as thumbnail grid" id="thumbbrowsebutton">
								<h4></h4>
							</button>
						</span>
					</div>			
				</div>

				<div id="attributeswrapper" class="well">
					<span id="attributes" style="float:center">&nbsp;</span>
				</div>

				<div id="abouttextwrapper" class="well">
					<span id="abouttext" style="float:center">&nbsp;</span>
				</div>

				<div id="filenamewrapper" class="well">
					<span id="filename" title="Source file" style="float:center;color:white;cursor:pointer;">&nbsp;</span>
				</div>				

				<div id="images" style="display:inline-block">
					<table>
						<tbody><tr>
							<td id="gallerythumbframe"></td>
							<td id="fullframe"></td>
						</tr>
					</tbody></table>
				</div>

				<div id="warning" class="well" style="display:none;background-color:yellow;"></div>

			</div>
		</div>

		<div id="t-container" style="display:none;padding:4px;">
			<div id="thumb1" class="ui-widget ui-widget-content ui-corner-all" style="width:100%;display:inline-block;">

				<div id="error" class="well" style="display:none;background-color:red;text-align:center;"></div>

				<!-- catalogwrapper gets copied here -->

				<div id="dropdownswrapper" class="well">
					<div style="text-align:center;">
						<span id="dropdowns"></span>
						<span>
							<button class="btn" type="button" title="Show as gallery" id="gallerybrowsebutton">
								<h4>|</h4>
							</button>
						</span>

						<span style="float:right">
							<input title="Scale images" id="slider1" style="width:60px;margin-top:3px" type="range" value="4" min="1" max="4" step="1">
						</span>

					</div>
				</div>

				<div>
					<img id="thumbbrowseoverlay" class="thumbbrowsetop" style="border:1px solid black" src="css/ajax-loader.gif">
				</div>

				<div class="well ui-widget-content" id="thumbbrowseframe"></div>

				<div class="well">
					<div id="header" class="well" style="text-align:center;">
						<span id="instructions2" style="float:center;"></span>
					</div>
				</div>

				<div id="warning" class="well" style="display:none;background-color:yellow;"></div>

			</div>
		 </div>
		

	


</body></html>
